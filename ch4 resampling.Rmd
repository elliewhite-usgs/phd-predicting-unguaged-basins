---
title: "resampling"
author: "Ellie White"
date: "March 23, 2019"
output: html_document
---

Record of how a model's predictive capability is assessed given different resampling techniques on hydrologic data. 

# Contents   
1.0 Data Gathering  
2.0 Data Transformations  
3.0 Functions  
4.0 Modelling and Resampling 
  4.1 LM  
  4.2 GLM  
  4.3 RF  
  4.4 NN  
5.0 Post Processing
  5.1 Aggregate BAsins - CV  
  5.2 Aggregate Basins - BS  
  5.3 GOF Post Processing  
6.0 Plots
  6.1 GOF Comparisons
  6.2 Observed vs. Predicted  
  6.3 Density  
  6.4 Map Plots  
  6.5 Dotcharts  
  6.6 Boxplots  
  6.7 GIFs  

```{r, include=FALSE} 
library(knitr)
library(formatR)
opts_chunk$set(fig.width = 7.5, fig.height = 7.5, collapse = TRUE, tidy = FALSE)
```

# Citations
```{r citations} 
# cite R 
toBibtex(citation())

# cite R studio
RStudio.Version()

# cite packages
citethese <- c("magick", "purrr")
for(c in seq_along(citethese)){
  print(toBibtex(citation(citethese[c])))
}
remove(c)

# session info in case anything goes wrong
sessionInfo()
```

# Set Seed
```{r setseed}
set.seed(3232019)
```

# 1.0 Data Gathering
```{r data_gathering} 
df <- readRDS('inputdata/moddf.rds')

# remove DOMGEOLOGY cause it's causing problems
df <- df[ , !(colnames(df) %in% c("DOMGEOLOGY"))]

# order by baisn name
df <- df[order(df$CDEC_ID), ]
row.names(df) <- 1:nrow(df)

# get rid of negative flows
# 1st of all WHY THE FUCK ARE THERE NEGATIVE FLOWS IN THE DATA? inverstigate this later.
# 2nd make sure the dates that have negative flows in the original dataset is removed from the cumulative dataset too. Afterall, these cumulative values are calculated from the original dataset and negative flow don't make sense there, so their cumulative doesn't make sense in this dataset either. 
moddf <- df[df$FLOW>=0, ]

# check if all the negatives are gone from moddf and moddfc
tbd <- moddf[moddf$FLOW<0, "FLOW"]
tbd <- na.omit(tbd)
length(tbd) == 0

remove(tbd)
```

```{r data_gathering_extra}
# some helpful dataframes, may come in handy later for post processing

basins_points <- read.csv("inputdata/cdec_fnf_stations_data_minus_sfj_otr_bhn_ftm_sfr_sjm_klo.csv", stringsAsFactors = FALSE)
coordinates(basins_points) <- ~LONGITUDE+LATITUDE
proj4string(basins_points) <- CRS("+proj=longlat +datum=WGS84")

basins <- readRDS("inputdata/basins.rds")
cacounties <- readRDS("inputdata/counties.rds")

ta <- CRS("+proj=aea +lat_1=34 +lat_2=40.5 +lat_0=0 +lon_0=-120 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=km +ellps=GRS80")
basins_points <- spTransform(basins_points, ta)
basins <- spTransform(basins, ta)
cacounties <- spTransform(cacounties, ta)
  
# wide format data
cdec_fnf_wide <- read.csv('inputdata/cdec_fnf_wide.csv')
cdec_fnf_wide$DATE <- as.Date(cdec_fnf_wide$DATE, format="%Y-%m-%d")
cdec_fnf_wide <- cdec_fnf_wide[order(cdec_fnf_wide$DATE),]

# The full records span 1900-01-01 to 1980-09-01, but most records start at 1982
cdec_fnf_wide <- cdec_fnf_wide[cdec_fnf_wide$DATE>="1982-01-01", ]
```

```{r visuals}
# colourblind palettes
# ordered:     black      pink        orange     yellow     green       blue      darkorange  lightblue
cbpgrey <-  c("#999999", "#CC79A7",  "#E69F00", "#F0E442", "#009E73", "#0072B2", "#D55E00", "#56B4E9")
cbpblack <- c("#000000", "#CC79A7",  "#E69F00", "#F0E442", "#009E73", "#0072B2", "#D55E00", "#56B4E9")
```

# 2.0 Data Tranformations
```{r data_transformation_lm} 
# for LM
# split into two one original aggregate basins and one the incremental basins
df_lm_agg <- moddf[1:(which(moddf$CDEC_ID=="AMA_INC")[1]-1),]
df_lm_inc <- moddf[which(moddf$CDEC_ID=="AMA_INC")[1]:nrow(moddf),]

# get rid of na values 
df_lm_agg <- na.omit(df_lm_agg)
df_lm_inc <- na.omit(df_lm_inc)
```

# 3.0 Functions
```{r funcstoimport} 
# library(hydroGOF) # this is giving wrong functions, do not load it in make sure the search path is clear
goffuncs <- list.files("libraries/HydroGOFm/R")
for(i in 1:length(goffuncs)){
  source(paste0("libraries/HydroGOFm/R/", goffuncs[i]))
}
remove(goffuncs)

search()
```

# 4.0 Modelling and Resampling

## 4.1 LM
```{r lm_modelling_and_cv}
# group can be resub, 2L, 5L, 10L, logo, lmgo, lho. Notice how a plain 2, 5, and 10 will not work, you have to declare it an integer
# datatype can be "agg" or "inc"

library(dismo)
lmcv <- function(data, groupingstyle, datatype){
  # for resubstitution, where testing data and training data is the same
  if(groupingstyle=="resub"){
    linearmodel <- lm(FLOW~., data=data[,c(15,18:ncol(data))])
    predictions <- predict(linearmodel, data, type='response')
    results <- cbind(obs=data$FLOW, pred=predictions)
    modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
  }
  
  # for k-fold cross validation
  if(is.integer(groupingstyle)){
    group <- kfold(data, groupingstyle)
    linearmodel <- results <- modgof <- list()
    for (k in 1:groupingstyle) {
      trainset <- data[group != k, ]
      testset <- data[group == k, ]
      linearmodel[[k]] <- lm(FLOW~., data=trainset[,c(15,18:ncol(trainset))])
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # for leave one group (basin) out cross validation
  if(groupingstyle=="logo"){
    linearmodel <- results <- modgof <- list()
    for (k in 1:(length(unique(data$CDEC_ID)))){
      h <- unique(data$CDEC_ID)[k]
      testset <- data[data$CDEC_ID==h,]
      trainset <- data[data$CDEC_ID!=h,]
      linearmodel[[k]] <- lm(FLOW~., data=trainset[,c(15,18:ncol(trainset))])
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
    colnames(modgof) <- unique(data$CDEC_ID)
  }
  
  # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
  if(groupingstyle=="lmgo"){
    nfolds <- 5
    group <- as.data.frame(unique(data$CDEC_ID))
    colnames(group) <- "CDEC_ID"
    group$kftrain <- kfold(nrow(group), nfolds)
    data <- merge(data, group, by="CDEC_ID")
    
    linearmodel <- results <- modgof <- list()
    for (k in 1:nfolds) {
      testset <- data[data$kftrain == k, ]
      trainset <- data[data$kftrain != k, ]
      linearmodel[[k]] <- lm(FLOW~., data=trainset[,c(15,18:ncol(trainset))])
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # # for leave hierarchies out cross validation
  # if(groupingstyle=="lho"){
  # }
  
  if(groupingstyle=="resub"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else if(groupingstyle=="logo"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else{
    list(mod=linearmodel, results=results, gof=modgof, kf=group)
    }
}

# lm_agg_resub_results <- lmcv(df_lm_agg, "resub", "agg")
# lm_agg_2fold_results <- lmcv(df_lm_agg, 2L, "agg")
# lm_agg_5fold_results <- lmcv(df_lm_agg, 5L, "agg")
# lm_agg_10fold_results <- lmcv(df_lm_agg, 10L, "agg")
# lm_agg_logo_results <- lmcv(df_lm_agg, "logo", "agg")
# lm_agg_lmgo_results <- lmcv(df_lm_agg, "lmgo", "agg")
# 
# lm_inc_resub_results <- lmcv(df_lm_inc, "resub", "inc")
# lm_inc_2fold_results <- lmcv(df_lm_inc, 2L, "inc")
# lm_inc_5fold_results <- lmcv(df_lm_inc, 5L, "inc")
# lm_inc_10fold_results <- lmcv(df_lm_inc, 10L, "inc")
# lm_inc_logo_results <- lmcv(df_lm_inc, "logo", "inc")
# lm_inc_lmgo_results <- lmcv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(lm_agg_resub_results, file="ch4 resampling/outputdata/rds/lm_agg_resub_results.RDS")
# saveRDS(lm_agg_2fold_results, file="ch4 resampling/outputdata/rds/lm_agg_2fold_results.RDS")
# saveRDS(lm_agg_5fold_results, file="ch4 resampling/outputdata/rds/lm_agg_5fold_results.RDS")
# saveRDS(lm_agg_10fold_results, file="ch4 resampling/outputdata/rds/lm_agg_10fold_results.RDS")
# saveRDS(lm_agg_logo_results, file="ch4 resampling/outputdata/rds/lm_agg_logo_results.RDS")
# saveRDS(lm_agg_lmgo_results, file="ch4 resampling/outputdata/rds/lm_agg_lmgo_results.RDS")
# 
# saveRDS(lm_inc_resub_results, file="ch4 resampling/outputdata/rds/lm_inc_resub_results.RDS")
# saveRDS(lm_inc_2fold_results, file="ch4 resampling/outputdata/rds/lm_inc_2fold_results.RDS")
# saveRDS(lm_inc_5fold_results, file="ch4 resampling/outputdata/rds/lm_inc_5fold_results.RDS")
# saveRDS(lm_inc_10fold_results, file="ch4 resampling/outputdata/rds/lm_inc_10fold_results.RDS")
# saveRDS(lm_inc_logo_results, file="ch4 resampling/outputdata/rds/lm_inc_logo_results.RDS")
# saveRDS(lm_inc_lmgo_results, file="ch4 resampling/outputdata/rds/lm_inc_lmgo_results.RDS")

lm_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_resub_results.RDS")
lm_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_2fold_results.RDS")
lm_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_5fold_results.RDS")
lm_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_10fold_results.RDS")
lm_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_logo_results.RDS")
lm_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_lmgo_results.RDS")

# lm_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_resub_results.RDS")
# lm_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_2fold_results.RDS")
# lm_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_5fold_results.RDS")
# lm_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_10fold_results.RDS")
# lm_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_logo_results.RDS")
# lm_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_lmgo_results.RDS")
```

```{r lm_modelling_and_bs}
lmbs <- function(data, groupingstyle, datatype, nsim=100){
  linearmodel <- results <- modgof <- list()
  # for randomized or iid bootstrapping
  for(i in 1:nsim){
    if(groupingstyle=="iid"){
      iidsamp_train <- sample(nrow(data), replace=TRUE)
      trainset <- data[iidsamp_train, ]
      iidsamp_test <- setdiff(seq_len(nrow(data)), iidsamp_train) # used iidsamp_test
      testset <- data[iidsamp_test, ]
      
      linearmodel[[i]] <- lm(FLOW~., data=trainset[,c(15,18:ncol(trainset))])
      predictions <- predict(linearmodel[[i]], testset, type='response')
      # used iidsamp_test because the usual way (i.e., the way we are doing it for bbg abd bbmg) was giving larger numbers than the dataframe, not sure why but this works for now 
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=iidsamp_test)
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }

    # for blocked by group (basin) bootstrapping
    if(groupingstyle=="bbg"){
      # each unique basin gets a block number
      group <- as.data.frame(unique(data$CDEC_ID))
      colnames(group) <- "CDEC_ID"
      group$bsgroup <- rownames(group)
      datam <- merge(data, group, by="CDEC_ID")

      # sample the blocks
      bbgsamp_train <- sample(nrow(group), replace=TRUE)
      # trainset <- data[data$bsgroup %in% bbgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
      trainset <- data.frame()
      for(j in 1:length(bbgsamp_train)){
        subdata <- datam[datam$bsgroup==bbgsamp_train[j], ]
        trainset <- rbind(trainset, subdata)
      }
      bbgsamp_test <- setdiff(seq_len(nrow(group)), bbgsamp_train)
      testset <- datam[datam$bsgroup %in% bbgsamp_test, ] # because the setdiff gives values that are unique, this %in% business will work this time

      linearmodel[[i]] <- lm(FLOW~., data=trainset[,c(15,18:(ncol(trainset)-1))])
      predictions <- predict(linearmodel[[i]], testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }

    # for blocked by multiple groups
    if(groupingstyle=="bbmg"){
      # split the 67 basins up into 10 blocks
      nblocks <- 10
      group <- as.data.frame(unique(data$CDEC_ID))
      colnames(group) <- "CDEC_ID"
      group$bsgroup <- kfold(nrow(group), nblocks)
      datam <- merge(data, group, by="CDEC_ID")

      # sample the blocks
      bbmgsamp_train <- sample(nblocks, replace=TRUE)
      # trainset <- data[data$bsgroup %in% bbmgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
      trainset <- data.frame()
      for(j in 1:length(bbmgsamp_train)){
        subdata <- datam[datam$bsgroup==bbmgsamp_train[j], ]
        trainset <- rbind(trainset, subdata)
      }
      bbgsamp_test <- setdiff(1:nblocks, bbmgsamp_train)
      testset <- datam[datam$bsgroup %in% bbgsamp_test, ]

      linearmodel[[i]] <- lm(FLOW~., data=trainset[,c(15,18:(ncol(trainset)-1))])
      predictions <- predict(linearmodel[[i]], testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }

    # for blocked by hierarchy bootstrapping
    if(groupingstyle=="bbh"){
    }
  }
  list(mod=linearmodel, results=results, gof=modgof)
}

# lm_agg_iid_results <- lmbs(df_lm_agg, "iid", "agg", 100)
# lm_agg_bbg_results <- lmbs(df_lm_agg, "bbg", "agg", 100)
# lm_agg_bbmg_results <- lmbs(df_lm_agg, "bbmg", "agg", 100)
# 
# saveRDS(lm_agg_iid_results, file="ch4 resampling/outputdata/rds/lm_agg_iid_results.RDS")
# saveRDS(lm_agg_bbg_results, file="ch4 resampling/outputdata/rds/lm_agg_bbg_results.RDS")
# saveRDS(lm_agg_bbmg_results, file="ch4 resampling/outputdata/rds/lm_agg_bbmg_results.RDS")

lm_agg_iid_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_iid_results.RDS")
lm_agg_bbg_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_bbg_results.RDS")
lm_agg_bbmg_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_bbmg_results.RDS")
```

## 4.2 GLM
```{r glm_modelling_and_cv} 
glmcv <- function(data, groupingstyle, datatype){  
  # for resubstitution, where testing data and training data is the same
  if(groupingstyle=="resub"){
    linearmodel <- glm(FLOW~., data=data[,c(15,18:ncol(data))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
    predictions <- predict(linearmodel, data, type='response')
    results <- cbind(obs=data$FLOW, pred=predictions)
    modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
  }
  
  # for k-fold cross validation
  if(is.integer(groupingstyle)){
    group <- kfold(data, groupingstyle)
    linearmodel <- results <- modgof <- list()
    for (k in 1:groupingstyle) {
      trainset <- data[group != k, ]
      testset <- data[group == k, ]
      linearmodel[[k]] <- glm(FLOW~., data=trainset[,c(15,18:ncol(trainset))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # for leave one group (basin) out cross validation
  if(groupingstyle=="logo"){
    linearmodel <- results <- modgof <- list()
    for (k in 1:(length(unique(data$CDEC_ID)))){
      h <- unique(data$CDEC_ID)[k]
      testset <- data[data$CDEC_ID==h,]
      trainset <- data[data$CDEC_ID!=h,]
      linearmodel[[k]] <- glm(FLOW~., data=trainset[,c(15,18:ncol(trainset))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
    colnames(modgof) <- unique(data$CDEC_ID)
  }
  
  # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
  if(groupingstyle=="lmgo"){
    nfolds <- 5
    group <- as.data.frame(unique(data$CDEC_ID))
    colnames(group) <- "CDEC_ID"
    group$kftrain <- kfold(nrow(group), nfolds)
    data <- merge(data, group, by="CDEC_ID")
    
    linearmodel <- results <- modgof <- list()
    for (k in 1:nfolds) {
      testset <- data[data$kftrain == k, ]
      trainset <- data[data$kftrain != k, ]
      linearmodel[[k]] <- glm(FLOW~., data=trainset[,c(15,18:ncol(trainset))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # # for leave hierarchies out cross validation
  # if(groupingstyle=="lho"){
  # }
  
  if(groupingstyle=="resub"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else if(groupingstyle=="logo"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else{
    list(mod=linearmodel, results=results, gof=modgof, kf=group)
    }
}

library(statmod)
# glmtwd_agg_resub_results <- glmcv(df_lm_agg, "resub", "agg")
# glmtwd_agg_2fold_results <- glmcv(df_lm_agg, 2L, "agg")
# glmtwd_agg_5fold_results <- glmcv(df_lm_agg, 5L, "agg")
# glmtwd_agg_10fold_results <- glmcv(df_lm_agg, 10L, "agg")
# glmtwd_agg_logo_results <- glmcv(df_lm_agg, "logo", "agg")
# glmtwd_agg_lmgo_results <- glmcv(df_lm_agg, "lmgo", "agg")
# 
# glmtwd_inc_resub_results <- glmcv(df_lm_inc, "resub", "inc")
# glmtwd_inc_2fold_results <- glmcv(df_lm_inc, 2L, "inc")
# glmtwd_inc_5fold_results <- glmcv(df_lm_inc, 5L, "inc")
# glmtwd_inc_10fold_results <- glmcv(df_lm_inc, 10L, "inc")
# glmtwd_inc_logo_results <- glmcv(df_lm_inc, "logo", "inc")
# glmtwd_inc_lmgo_results <- glmcv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(glmtwd_agg_resub_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_resub_results.RDS")
# saveRDS(glmtwd_agg_2fold_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_2fold_results.RDS")
# saveRDS(glmtwd_agg_5fold_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_5fold_results.RDS")
# saveRDS(glmtwd_agg_10fold_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_10fold_results.RDS")
# saveRDS(glmtwd_agg_logo_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_logo_results.RDS")
# saveRDS(glmtwd_agg_lmgo_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_lmgo_results.RDS")
# 
# saveRDS(glmtwd_inc_resub_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_resub_results.RDS")
# saveRDS(glmtwd_inc_2fold_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_2fold_results.RDS")
# saveRDS(glmtwd_inc_5fold_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_5fold_results.RDS")
# saveRDS(glmtwd_inc_10fold_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_10fold_results.RDS")
# saveRDS(glmtwd_inc_logo_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_logo_results.RDS")
# saveRDS(glmtwd_inc_lmgo_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_lmgo_results.RDS")

glmtwd_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_resub_results.RDS")
glmtwd_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_2fold_results.RDS")
glmtwd_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_5fold_results.RDS")
glmtwd_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_10fold_results.RDS")
glmtwd_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_logo_results.RDS")
glmtwd_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_lmgo_results.RDS")

# glmtwd_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_resub_results.RDS")
# glmtwd_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_2fold_results.RDS")
# glmtwd_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_5fold_results.RDS")
# glmtwd_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_10fold_results.RDS")
# glmtwd_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_logo_results.RDS")
# glmtwd_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_lmgo_results.RDS")
```

```{r glm_modelling_and_bs}
glmbs <- function(data, groupingstyle, datatype, nsim=100){
  linearmodel <- results <- modgof <- list()
  # for randomized or iid bootstrapping
  for(i in 1:nsim){
    if(groupingstyle=="iid"){
      iidsamp_train <- sample(nrow(data), replace=TRUE)
      trainset <- data[iidsamp_train, ]
      iidsamp_test <- setdiff(seq_len(nrow(data)), iidsamp_train)
      testset <- data[iidsamp_test, ]
      
      linearmodel[[i]] <- glm(FLOW~., data=trainset[,c(15,18:ncol(trainset))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[i]], testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=iidsamp_test)
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }

    # for blocked by group (basin) bootstrapping
    if(groupingstyle=="bbg"){
      # each unique basin gets a block number
      group <- as.data.frame(unique(data$CDEC_ID))
      colnames(group) <- "CDEC_ID"
      group$bsgroup <- rownames(group)
      datam <- merge(data, group, by="CDEC_ID")

      # sample the blocks
      bbgsamp_train <- sample(nrow(group), replace=TRUE)
      # trainset <- data[data$bsgroup %in% bbgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
      trainset <- data.frame()
      for(j in 1:length(bbgsamp_train)){
        subdata <- datam[datam$bsgroup==bbgsamp_train[j], ]
        trainset <- rbind(trainset, subdata)
      }
      bbgsamp_test <- setdiff(seq_len(nrow(group)), bbgsamp_train)
      testset <- datam[datam$bsgroup %in% bbgsamp_test, ] # because the setdiff gives values that are unique, this %in% business will work this time

      linearmodel[[i]] <- glm(FLOW~., data=trainset[,c(15,18:(ncol(trainset)-1))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[i]], testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }

    # for blocked by multiple groups
    if(groupingstyle=="bbmg"){
      # split the 67 basins up into 10 blocks
      nblocks <- 10
      group <- as.data.frame(unique(data$CDEC_ID))
      colnames(group) <- "CDEC_ID"
      group$bsgroup <- kfold(nrow(group), nblocks)
      datam <- merge(data, group, by="CDEC_ID")

      # sample the blocks
      bbmgsamp_train <- sample(nblocks, replace=TRUE)
      # trainset <- data[data$bsgroup %in% bbmgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
      trainset <- data.frame()
      for(j in 1:length(bbmgsamp_train)){
        subdata <- datam[datam$bsgroup==bbmgsamp_train[j], ]
        trainset <- rbind(trainset, subdata)
      }
      bbgsamp_test <- setdiff(1:nblocks, bbmgsamp_train)
      testset <- datam[datam$bsgroup %in% bbgsamp_test, ]

      linearmodel[[i]] <- glm(FLOW~., data=trainset[,c(15,18:(ncol(trainset)-1))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[i]], testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }
    
    # for blocked by hierarchy bootstrapping
    if(groupingstyle=="bbh"){
    }
  }
  list(mod=linearmodel, results=results, gof=modgof)
}

# glm_agg_iid_results <- glmbs(df_lm_agg, "iid", "agg", 100)
# glm_agg_bbg_results <- glmbs(df_lm_agg, "bbg", "agg", 100)
# glm_agg_bbmg_results <- glmbs(df_lm_agg, "bbmg", "agg", 100)
# 
# saveRDS(glm_agg_iid_results, file="ch4 resampling/outputdata/rds/glm_agg_iid_results.RDS")
# saveRDS(glm_agg_bbg_results, file="ch4 resampling/outputdata/rds/glm_agg_bbg_results.RDS")
# saveRDS(glm_agg_bbmg_results, file="ch4 resampling/outputdata/rds/glm_agg_bbmg_results.RDS")

glm_agg_iid_results <- readRDS("ch4 resampling/outputdata/rds/glm_agg_iid_results.RDS")
glm_agg_bbg_results <- readRDS("ch4 resampling/outputdata/rds/glm_agg_bbg_results.RDS")
glm_agg_bbmg_results <- readRDS("ch4 resampling/outputdata/rds/glm_agg_bbmg_results.RDS")
```

## 4.3 RF
```{r rf_modelling_and_cv}
# we are not saving the models because it takes too much memory. so rrfmodel is no longer specified as a list and took mod=rfmodel out of return list. 

library(randomForest)

# # let's first optimize the tuning parameter mtry
# trf <- tuneRF(df_lm_inc[,c(15,18:ncol(df_lm_inc))], df_lm_inc$FLOW, mtryStart=5, stepFactor=2)
# mt <- trf[which.min(trf[,2]), 1]
mt <- 20

rfcv <- function(data, groupingstyle, datatype){ 
  # for resubstitution, where testing data and training data is the same
  if(groupingstyle=="resub"){
    rfmodel <- randomForest(FLOW~. , data=data[,c(15,18:ncol(data))], mtry=mt)
    predictions <- predict(rfmodel, data, type='response')
    results <- cbind(obs=data$FLOW, pred=predictions)
    modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
  }
  
  # for k-fold cross validation
  if(is.integer(groupingstyle)){
    group <- kfold(data, groupingstyle)
    results <- modgof <- list()
    for(k in 1:groupingstyle) {
      trainset <- data[group != k, ]
      testset <- data[group == k, ]
      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:ncol(trainset))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # for leave one group (basin) out cross validation
  if(groupingstyle=="logo"){
    results <- modgof <- list()
    for (k in 1:(length(unique(data$CDEC_ID)))){
      h <- unique(data$CDEC_ID)[k]
      testset <- data[data$CDEC_ID==h,]
      trainset <- data[data$CDEC_ID!=h,]
      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:ncol(trainset))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
    colnames(modgof) <- unique(data$CDEC_ID)
  }
  
  # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
  if(groupingstyle=="lmgo"){
    nfolds <- 5
    group <- as.data.frame(unique(data$CDEC_ID))
    colnames(group) <- "CDEC_ID"
    group$kftrain <- kfold(nrow(group), nfolds)
    data <- merge(data, group, by="CDEC_ID")
    
    results <- modgof <- list()
    for (k in 1:nfolds) {
      testset <- data[data$kftrain == k, ]
      trainset <- data[data$kftrain != k, ]
      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:ncol(trainset))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  if(groupingstyle=="resub"){
    list(results=results, gof=modgof)
  } else if(groupingstyle=="logo"){
    list(results=results, gof=modgof)
  } else{
    list(results=results, gof=modgof, kf=group)
  }
}

# rf_agg_resub_results <- rfcv(df_lm_agg, "resub", "agg")
# rf_agg_2fold_results <- rfcv(df_lm_agg, 2L, "agg")
# rf_agg_5fold_results <- rfcv(df_lm_agg, 5L, "agg")
# rf_agg_10fold_results <- rfcv(df_lm_agg, 10L, "agg")
# rf_agg_logo_results <- rfcv(df_lm_agg, "logo", "agg")
# rf_agg_lmgo_results <- rfcv(df_lm_agg, "lmgo", "agg")
# 
# rf_inc_resub_results <- rfcv(df_lm_inc, "resub", "inc")
# rf_inc_2fold_results <- rfcv(df_lm_inc, 2L, "inc")
# rf_inc_5fold_results <- rfcv(df_lm_inc, 5L, "inc")
# rf_inc_10fold_results <- rfcv(df_lm_inc, 10L, "inc")
# rf_inc_logo_results <- rfcv(df_lm_inc, "logo", "inc")
# rf_inc_lmgo_results <- rfcv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(rf_agg_resub_results, file="ch4 resampling/outputdata/rds/rf_agg_resub_results.RDS")
# saveRDS(rf_agg_2fold_results, file="ch4 resampling/outputdata/rds/rf_agg_2fold_results.RDS")
# saveRDS(rf_agg_5fold_results, file="ch4 resampling/outputdata/rds/rf_agg_5fold_results.RDS")
# saveRDS(rf_agg_10fold_results, file="ch4 resampling/outputdata/rds/rf_agg_10fold_results.RDS")
# saveRDS(rf_agg_logo_results, file="ch4 resampling/outputdata/rds/rf_agg_logo_results.RDS")
# saveRDS(rf_agg_lmgo_results, file="ch4 resampling/outputdata/rds/rf_agg_lmgo_results.RDS")
# 
# saveRDS(rf_inc_resub_results, file="ch4 resampling/outputdata/rds/rf_inc_resub_results.RDS")
# saveRDS(rf_inc_2fold_results, file="ch4 resampling/outputdata/rds/rf_inc_2fold_results.RDS")
# saveRDS(rf_inc_5fold_results, file="ch4 resampling/outputdata/rds/rf_inc_5fold_results.RDS")
# saveRDS(rf_inc_10fold_results, file="ch4 resampling/outputdata/rds/rf_inc_10fold_results.RDS")
# saveRDS(rf_inc_logo_results, file="ch4 resampling/outputdata/rds/rf_inc_logo_results.RDS")
# saveRDS(rf_inc_lmgo_results, file="ch4 resampling/outputdata/rds/rf_inc_lmgo_results.RDS")

rf_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_resub_results.RDS")
rf_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_2fold_results.RDS")
rf_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_5fold_results.RDS")
rf_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_10fold_results.RDS")
rf_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_logo_results.RDS")
rf_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_lmgo_results.RDS")

# rf_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_resub_results.RDS")
# rf_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_2fold_results.RDS")
# rf_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_5fold_results.RDS")
# rf_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_10fold_results.RDS")
# rf_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_logo_results.RDS")
# rf_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_lmgo_results.RDS")
```

```{r rf_modelling_and_bs}
rfbs <- function(data, groupingstyle, datatype, nsim=100){
  mt <- 20
  results <- modgof <- list()
  # for randomized or iid bootstrapping
  for(i in 1:nsim){
    if(groupingstyle=="iid"){
      iidsamp_train <- sample(nrow(data), replace=TRUE)
      trainset <- data[iidsamp_train, ]
      iidsamp_test <- setdiff(seq_len(nrow(data)), iidsamp_train)
      testset <- data[iidsamp_test, ]

      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:ncol(trainset))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=iidsamp_test)
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
      
    }

    # for blocked by group (basin) bootstrapping
    if(groupingstyle=="bbg"){
      # each unique basin gets a block number
      group <- as.data.frame(unique(data$CDEC_ID))
      colnames(group) <- "CDEC_ID"
      group$bsgroup <- rownames(group)
      datam <- merge(data, group, by="CDEC_ID")

      # sample the blocks
      bbgsamp_train <- sample(nrow(group), replace=TRUE)
      # trainset <- data[data$bsgroup %in% bbgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
      trainset <- data.frame()
      for(j in 1:length(bbgsamp_train)){
        subdata <- datam[datam$bsgroup==bbgsamp_train[j], ]
        trainset <- rbind(trainset, subdata)
      }
      bbgsamp_test <- setdiff(seq_len(nrow(group)), bbgsamp_train)
      testset <- datam[datam$bsgroup %in% bbgsamp_test, ] # because the setdiff gives values that are unique, this %in% business will work this time

      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:(ncol(trainset)-1))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }

    # for blocked by multiple groups
    if(groupingstyle=="bbmg"){
      # split the 67 basins up into 10 blocks
      nblocks <- 10
      group <- as.data.frame(unique(data$CDEC_ID))
      colnames(group) <- "CDEC_ID"
      group$bsgroup <- kfold(nrow(group), nblocks)
      datam <- merge(data, group, by="CDEC_ID")

      # sample the blocks
      bbmgsamp_train <- sample(nblocks, replace=TRUE)
      # trainset <- data[data$bsgroup %in% bbmgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
      trainset <- data.frame()
      for(j in 1:length(bbmgsamp_train)){
        subdata <- datam[datam$bsgroup==bbmgsamp_train[j], ]
        trainset <- rbind(trainset, subdata)
      }
      bbgsamp_test <- setdiff(1:nblocks, bbmgsamp_train)
      testset <- datam[datam$bsgroup %in% bbgsamp_test, ]

      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:(ncol(trainset)-1))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[i]] <- cbind(obs=testset$FLOW, pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
    }

    # for blocked by hierarchy bootstrapping
    if(groupingstyle=="bbh"){
    }
  }
  list(results=results, gof=modgof)
}

# rf_agg_iid_results <- rfbs(df_lm_agg, "iid", "agg", 100)
# rf_agg_bbg_results <- rfbs(df_lm_agg, "bbg", "agg", 100)
# rf_agg_bbmg_results <- rfbs(df_lm_agg, "bbmg", "agg", 100)
# 
# saveRDS(rf_agg_iid_results, file="ch4 resampling/outputdata/rds/rf_agg_iid_results.RDS")
# saveRDS(rf_agg_bbg_results, file="ch4 resampling/outputdata/rds/rf_agg_bbg_results.RDS")
# saveRDS(rf_agg_bbmg_results, file="ch4 resampling/outputdata/rds/rf_agg_bbmg_results.RDS")

rf_agg_iid_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_iid_results.RDS")
rf_agg_bbg_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_bbg_results.RDS")
rf_agg_bbmg_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_bbmg_results.RDS")
```

## 4.4 NN
RUN JUST THE NN INC ONES LATER
```{r nn_modeling_and_cv}
# install and set up our environment for deep learning
# devtools::install_github("rstudio/keras")
# library(keras)
# install_keras(method = "conda")
# 
# nncv <- function(data, groupingstyle, datatype){
#   # the model network includes two layers of fully-connected relu activated neurons, and an output layer with no transformation. units are the number of hidden nodes
#   trainingdim <- dim(data[,c(15,18:(ncol(data)-1))])
#   nnmodel <- keras_model_sequential() %>%
#   layer_dense(units=64, activation="relu", input_shape=trainingdim[[2]]) %>%
#   layer_dense(units=64, activation="relu") %>%
#   layer_dense(units=1) # number of outputs, here we just want one prediction
#     
#   nnmodel %>% # to compile the model, loss functions are defined here
#     compile(optimizer="rmsprop", loss=keras::loss_mean_squared_error, metrics=c("mae"))
#     
#   # for resubstitution, where testing data and training data is the same
#   if(groupingstyle=="resub"){
#     trainsetpvs <- as.matrix(data[,c(15,18:(ncol(data)-1))])
#     trainsetrv <- as.matrix(data$FLOW)
#     nnmodel %>%  # this is to fit the model coefficients
#       fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
#     predictions <- nnmodel %>% predict(trainsetpvs)
#     predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
#     results <- cbind(obs=trainsetrv[ , 1], pred=predictions)
#     modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
#   }
#   
#   # for k-fold cross validation
#   if(is.integer(groupingstyle)){
#     group <- kfold(data, groupingstyle)
#     results <- modgof <- list()
#     for(k in 1:groupingstyle) {
#       trainset <- data[group != k, ]
#       testset <- data[group == k, ]
#       
#       # seperate into predictor variables and response variable
#       testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-1))])
#       trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-1))])
#       testsetrv <- as.matrix(testset$FLOW)
#       trainsetrv <- as.matrix(trainset$FLOW)
#       
#       nnmodel %>% 
#         fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
#       predictions <- nnmodel %>% predict(testsetpvs)
#       predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
#       results[[k]] <- cbind(obs=testsetrv[ , 1], pred=predictions, nforstitch=as.numeric(rownames(testset))) # adding rownames here for later stitching the dataset back to its original shape
#       modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
#     }
#     names_tbd <- rownames(modgof[[1]])
#     modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
#     rownames(modgof) <- names_tbd
#   }
#   
#   # for leave one group (basin) out cross validation
#   if(groupingstyle=="logo"){
#     results <- modgof <- list()
#   
#     for (k in 1:(length(unique(data$CDEC_ID)))){
#       h <- unique(data$CDEC_ID)[k]
#       testset <- data[data$CDEC_ID==h,]
#       trainset <- data[data$CDEC_ID!=h,]
#       testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-1))])
#       trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-1))])
#       testsetrv <- as.matrix(testset$FLOW)
#       trainsetrv <- as.matrix(trainset$FLOW)
#       
#       nnmodel %>%  
#         fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
#       predictions <- nnmodel %>% predict(testsetpvs)
#       predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
#       results[[k]] <- cbind(obs=testsetrv[ , 1], pred=predictions)
#       modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
#     }
#     names_tbd <- rownames(modgof[[1]])
#     modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
#     rownames(modgof) <- names_tbd
#     colnames(modgof) <- unique(data$CDEC_ID)
#   }
#   
#   # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
#   if(groupingstyle=="lmgo"){
#     nfolds <- 5
#     group <- as.data.frame(unique(data$CDEC_ID))
#     colnames(group) <- "CDEC_ID"
#     group$kftrain <- kfold(nrow(group), nfolds)
#     data <- merge(data, group, by="CDEC_ID")
#     
#     results <- modgof <- list()
#     for(k in 1:nfolds) {
#       testset <- data[data$kftrain == k, ]
#       trainset <- data[data$kftrain != k, ]
#       testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-2))])
#       trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-2))])
#       testsetrv <- as.matrix(testset$FLOW)
#       trainsetrv <- as.matrix(trainset$FLOW)
#       
#       nnmodel %>% 
#         fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
#       predictions <- nnmodel %>% predict(testsetpvs)
#       predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
#       results[[k]] <- cbind(obs=testsetrv[ , 1], pred=predictions, nforstitch=as.numeric(rownames(testset)))
#       modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
#     }
#     names_tbd <- rownames(modgof[[1]])
#     modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
#     rownames(modgof) <- names_tbd
#   }
#   
#   if(groupingstyle=="resub"){
#     list(results=results, gof=modgof)
#   } else if(groupingstyle=="logo"){
#     list(results=results, gof=modgof)
#   } else{
#     list(results=results, gof=modgof, kf=group)
#   }
# }

# nn_agg_resub_results <- nncv(df_lm_agg, "resub", "agg")
# nn_agg_2fold_results <- nncv(df_lm_agg, 2L, "agg")
# nn_agg_5fold_results <- nncv(df_lm_agg, 5L, "agg")
# nn_agg_10fold_results <- nncv(df_lm_agg, 10L, "agg")
# nn_agg_logo_results <- nncv(df_lm_agg, "logo", "agg")
# nn_agg_lmgo_results <- nncv(df_lm_agg, "lmgo", "agg")
# 
# nn_inc_resub_results <- nncv(df_lm_inc, "resub", "inc")
# nn_inc_2fold_results <- nncv(df_lm_inc, 2L, "inc")
# nn_inc_5fold_results <- nncv(df_lm_inc, 5L, "inc")
# nn_inc_10fold_results <- nncv(df_lm_inc, 10L, "inc")
# nn_inc_logo_results <- nncv(df_lm_inc, "logo", "inc")
# nn_inc_lmgo_results <- nncv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(nn_agg_resub_results, file="ch4 resampling/outputdata/rds/nn_agg_resub_results.RDS")
# saveRDS(nn_agg_2fold_results, file="ch4 resampling/outputdata/rds/nn_agg_2fold_results.RDS")
# saveRDS(nn_agg_5fold_results, file="ch4 resampling/outputdata/rds/nn_agg_5fold_results.RDS")
# saveRDS(nn_agg_10fold_results, file="ch4 resampling/outputdata/rds/nn_agg_10fold_results.RDS")
# saveRDS(nn_agg_logo_results, file="ch4 resampling/outputdata/rds/nn_agg_logo_results.RDS")
# saveRDS(nn_agg_lmgo_results, file="ch4 resampling/outputdata/rds/nn_agg_lmgo_results.RDS")
# 
# saveRDS(nn_inc_resub_results, file="ch4 resampling/outputdata/rds/nn_inc_resub_results.RDS")
# saveRDS(nn_inc_2fold_results, file="ch4 resampling/outputdata/rds/nn_inc_2fold_results.RDS")
# saveRDS(nn_inc_5fold_results, file="ch4 resampling/outputdata/rds/nn_inc_5fold_results.RDS")
# saveRDS(nn_inc_10fold_results, file="ch4 resampling/outputdata/rds/nn_inc_10fold_results.RDS")
# saveRDS(nn_inc_logo_results, file="ch4 resampling/outputdata/rds/nn_inc_logo_results.RDS")
# saveRDS(nn_inc_lmgo_results, file="ch4 resampling/outputdata/rds/nn_inc_lmgo_results.RDS")

nn_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_resub_results.RDS")
nn_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_2fold_results.RDS")
nn_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_5fold_results.RDS")
nn_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_10fold_results.RDS")
nn_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_logo_results.RDS")
nn_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_lmgo_results.RDS")

# nn_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_resub_results.RDS")
# nn_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_2fold_results.RDS")
# nn_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_5fold_results.RDS")
# nn_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_10fold_results.RDS")
# nn_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_logo_results.RDS")
# nn_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_lmgo_results.RDS")
```

```{r nn_modeling_and_bs}
# grouping style can be iid, bbg, bbmg
# library(keras)
# install_keras(method = "conda")

# nnbs <- function(data, groupingstyle, datatype, nsim=100){
#   # the model network includes two layers of fully-connected relu activated neurons, and an output layer with no transformation. units are the number of hidden nodes
#   trainingdim <- dim(data[,c(15,18:(ncol(data)-1))])
#   nnmodel <- keras_model_sequential() %>%
#   layer_dense(units=64, activation="relu", input_shape=trainingdim[[2]]) %>%
#   layer_dense(units=64, activation="relu") %>%
#   layer_dense(units=1) # number of outputs, here we just want one prediction
# 
#   nnmodel %>% # to compile the model, loss functions are defined here
#     compile(optimizer="rmsprop", loss=keras::loss_mean_squared_error, metrics=c("mae"))
# 
#   results <- modgof <- list()
#   # for randomized or iid bootstrapping
#   for(i in 1:nsim){
#     if(groupingstyle=="iid"){
#       iidsamp_train <- sample(nrow(data), replace=TRUE)
#       trainset <- data[iidsamp_train, ]
#       iidsamp_test <- setdiff(seq_len(nrow(data)), iidsamp_train)
#       testset <- data[iidsamp_test, ]
# 
#       testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-1))])
#       trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-1))])
#       testsetrv <- as.matrix(testset$FLOW)
#       trainsetrv <- as.matrix(trainset$FLOW)
# 
#       nnmodel %>%
#         fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
#       predictions <- nnmodel %>% predict(testsetpvs)
#       predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
#       results[[i]] <- cbind(obs=testsetrv[ , 1], pred=predictions, nforstitch=iidsamp_test)
#       modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
#     }
# 
#     # for blocked by group (basin) bootstrapping
#     if(groupingstyle=="bbg"){
#       # each unique basin gets a block number
#       group <- as.data.frame(unique(data$CDEC_ID))
#       colnames(group) <- "CDEC_ID"
#       group$bsgroup <- rownames(group)
#       datam <- merge(data, group, by="CDEC_ID")
# 
#       # sample the blocks
#       bbgsamp_train <- sample(nrow(group), replace=TRUE)
#       # trainset <- data[data$bsgroup %in% bbgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
#       trainset <- data.frame()
#       for(j in 1:length(bbgsamp_train)){
#         subdata <- datam[datam$bsgroup==bbgsamp_train[j], ]
#         trainset <- rbind(trainset, subdata)
#       }
#       bbgsamp_test <- setdiff(seq_len(nrow(group)), bbgsamp_train)
#       testset <- datam[datam$bsgroup %in% bbgsamp_test, ] # because the setdiff gives values that are unique, this %in% business will work this time
# 
#       testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-2))])
#       trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-2))])
#       testsetrv <- as.matrix(testset$FLOW)
#       trainsetrv <- as.matrix(trainset$FLOW)
# 
#       nnmodel %>%
#         fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
#       predictions <- nnmodel %>% predict(testsetpvs)
#       predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
#       results[[i]] <- cbind(obs=testsetrv[ , 1], pred=predictions, nforstitch=as.numeric(rownames(testset)))
#       modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
#     }
# 
#     # for blocked by multiple groups
#     if(groupingstyle=="bbmg"){
#       # split the 67 basins up into 10 blocks
#       nblocks <- 10
#       group <- as.data.frame(unique(data$CDEC_ID))
#       colnames(group) <- "CDEC_ID"
#       group$bsgroup <- kfold(nrow(group), nblocks)
#       datam <- merge(data, group, by="CDEC_ID")
# 
#       # sample the blocks
#       bbmgsamp_train <- sample(nblocks, replace=TRUE)
#       # trainset <- data[data$bsgroup %in% bbmgsamp_train, ] # this isn't repeating the blocks like we want it to, so use the loop
#       trainset <- data.frame()
#       for(j in 1:length(bbmgsamp_train)){
#         subdata <- datam[datam$bsgroup==bbmgsamp_train[j], ]
#         trainset <- rbind(trainset, subdata)
#       }
#       bbgsamp_test <- setdiff(1:nblocks, bbmgsamp_train)
#       testset <- datam[datam$bsgroup %in% bbgsamp_test, ]
# 
#       testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-2))])
#       trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-2))])
#       testsetrv <- as.matrix(testset$FLOW)
#       trainsetrv <- as.matrix(trainset$FLOW)
# 
#       nnmodel %>%
#         fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
#       predictions <- nnmodel %>% predict(testsetpvs)
#       predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
#       results[[i]] <- cbind(obs=testsetrv[ , 1], pred=predictions, nforstitch=as.numeric(rownames(testset)))
#       modgof[[i]] <- gof(as.data.frame(results[[i]])$pred, as.data.frame(results[[i]])$obs)
#     }
# 
#     # for blocked by hierarchy bootstrapping
#     if(groupingstyle=="bbh"){
#     }
#   }
#   list(results=results, gof=modgof)
# }

# nn_agg_iid_results <- nnbs(df_lm_agg, "iid", "agg", 100)
# nn_agg_bbg_results <- nnbs(df_lm_agg, "bbg", "agg", 100)
# nn_agg_bbmg_results <- nnbs(df_lm_agg, "bbmg", "agg", 100)
# 
# saveRDS(nn_agg_iid_results, file="ch4 resampling/outputdata/rds/nn_agg_iid_results.RDS")
# saveRDS(nn_agg_bbg_results, file="ch4 resampling/outputdata/rds/nn_agg_bbg_results.RDS")
# saveRDS(nn_agg_bbmg_results, file="ch4 resampling/outputdata/rds/nn_agg_bbmg_results.RDS")

nn_agg_iid_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_iid_results.RDS")
nn_agg_bbg_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_bbg_results.RDS")
nn_agg_bbmg_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_bbmg_results.RDS")
```

# 5.0 Post Processing 
For saving results
```{r data_results_df}
# make a copy of the original dataframes to add the results to later
# notice how the lm, not glm dataset was used for the Tweedie distribution
results_lm_agg <- results_glm_agg <- results_nn_agg <- results_rf_agg <- df_lm_agg
results_lm_inc <- results_glm_inc <- results_nn_inc <- results_rf_inc <- df_lm_inc

# consider putting them all in one dataframe 
results_agg <- df_lm_agg
results_inc <- df_lm_inc
```

## 5.1 Aggregate basins - CV
```{r results_dataframes}
# put the logo results in their respective dataframes
# datatype: "agg", "inc"
# modeltype: "lm", "glm", "rf", "nn"
# grouping style: "resub", "2fold", "5fold", "10fold", "logo", "lmgo"

pp_agg_results <- function(resultsls, resultsdf, modeltype, groupingstyle){
  if(groupingstyle=="resub"){
    results_unlisted <- as.data.frame(resultsls$results)
    resultsdf <- cbind(resultsdf, RESUBFIT=results_unlisted$pred)
    resultsdf$RESUBRES <- resultsdf$RESUBFIT-resultsdf$FLOW # this is pred - obs
    
    # adding a KF column to make it consistent between groupingstyles
    resultsdf$KF <- 1
    colnames(resultsdf)[ncol(resultsdf)] <- "RESUBKF"
  } 
  
  if(is.integer(groupingstyle)){ 
    if(modeltype=="nn"|modeltype=="glm"){ # for GLM and NN we made a nforstitch column, use that to order instead of the usual way of using rownames
      kftype <- paste0(as.character(groupingstyle), "FOLD")
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      results_unlisted <- results_unlisted[order(results_unlisted$nforstitch), ]
      resultsdf <- cbind(resultsdf, FIT=results_unlisted$pred)
      resultsdf$RES <- resultsdf$FIT-resultsdf$FLOW
      colnames(resultsdf)[ncol(resultsdf)-1] <- paste0(kftype, "FIT")
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "RES")
      resultsdf$KF <- resultsls$kf
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "KF")
    }else{
      kftype <- paste0(as.character(groupingstyle), "FOLD")
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      # use the kf vector to scramble the unlisted results, to match up with the observations in the results df... no need to do these, because the rownames, or I should say numbers, have been preserved. So, just order
      index <- as.numeric(row.names(results_unlisted))
      results_unlisted <- results_unlisted[order(index), ]
      resultsdf <- cbind(resultsdf, FIT=results_unlisted$pred)
      resultsdf$RES <- resultsdf$FIT-resultsdf$FLOW
      colnames(resultsdf)[ncol(resultsdf)-1] <- paste0(kftype, "FIT")
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "RES")
      resultsdf$KF <- resultsls$kf
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "KF")
    }
  }
  
  if(groupingstyle=="logo"){ # no need to use the unique CDEC_IDs vector to scramble the unlisted results because the original results dataframe is in the same order, so a simple cbind will be OK
    results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
    resultsdf <- cbind(resultsdf, LOGOFIT=results_unlisted$pred)
    resultsdf$LOGORES <- resultsdf$LOGOFIT-resultsdf$FLOW 
    
    # adding a KF column to make it consistent between groupingstyles
    resultsdf$KF <- as.numeric(resultsdf$CDEC_ID)
    colnames(resultsdf)[ncol(resultsdf)] <- "LOGOKF"
  }
  
  if(groupingstyle=="lmgo"){
    if(modeltype=="nn"|modeltype=="glm"){ 
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      results_unlisted <- results_unlisted[order(results_unlisted$nforstitch), ]
      resultsdf <- cbind(resultsdf, LMGOFIT=results_unlisted$pred)
      resultsdf$LMGORES <- resultsdf$LMGOFIT-resultsdf$FLOW
      resultsdf <- merge(resultsdf, resultsls$kf, by="CDEC_ID")
      colnames(resultsdf)[ncol(resultsdf)] <- "LMGOKF"
    } else {
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      index <- as.numeric(row.names(results_unlisted))
      results_unlisted <- results_unlisted[order(index), ]
      resultsdf <- cbind(resultsdf, LMGOFIT=results_unlisted$pred)
      resultsdf$LMGORES <- resultsdf$LMGOFIT-resultsdf$FLOW
      resultsdf <- merge(resultsdf, resultsls$kf, by="CDEC_ID")
      colnames(resultsdf)[ncol(resultsdf)] <- "LMGOKF"
    }
  }
  
  # now change column names based on modeltype
  colnames(resultsdf)[ncol(resultsdf)-2] <- paste0(toupper(modeltype), "_", colnames(resultsdf)[ncol(resultsdf)-2])
  colnames(resultsdf)[ncol(resultsdf)-1] <- paste0(toupper(modeltype), "_", colnames(resultsdf)[ncol(resultsdf)-1])
  colnames(resultsdf)[ncol(resultsdf)] <- paste0(toupper(modeltype), "_", colnames(resultsdf)[ncol(resultsdf)])
  return(resultsdf)
}

# first check to see if the dimensions match, examples below
dim(as.data.frame(do.call("rbind", glmtwd_agg_lmgo_results$results)))[[1]] == dim(results_agg)[[1]]

results_agg <- pp_agg_results(lm_agg_resub_results, results_agg, "lm", "resub")
results_agg <- pp_agg_results(lm_agg_2fold_results, results_agg, "lm", 2L)
results_agg <- pp_agg_results(lm_agg_5fold_results, results_agg, "lm", 5L)
results_agg <- pp_agg_results(lm_agg_10fold_results, results_agg, "lm", 10L)
results_agg <- pp_agg_results(lm_agg_logo_results, results_agg, "lm", "logo")
results_agg <- pp_agg_results(lm_agg_lmgo_results, results_agg, "lm", "lmgo")

results_agg <- pp_agg_results(glmtwd_agg_resub_results, results_agg, "glm", "resub")
results_agg <- pp_agg_results(glmtwd_agg_2fold_results, results_agg, "glm", 2L)
results_agg <- pp_agg_results(glmtwd_agg_5fold_results, results_agg, "glm", 5L)
results_agg <- pp_agg_results(glmtwd_agg_10fold_results, results_agg, "glm", 10L)
results_agg <- pp_agg_results(glmtwd_agg_logo_results, results_agg, "glm", "logo")
results_agg <- pp_agg_results(glmtwd_agg_lmgo_results, results_agg, "glm", "lmgo")

results_agg <- pp_agg_results(rf_agg_resub_results, results_agg, "rf", "resub")
results_agg <- pp_agg_results(rf_agg_2fold_results, results_agg, "rf", 2L)
results_agg <- pp_agg_results(rf_agg_5fold_results, results_agg, "rf", 5L)
results_agg <- pp_agg_results(rf_agg_10fold_results, results_agg, "rf", 10L)
results_agg <- pp_agg_results(rf_agg_logo_results, results_agg, "rf", "logo")
results_agg <- pp_agg_results(rf_agg_lmgo_results, results_agg, "rf", "lmgo")

results_agg <- pp_agg_results(nn_agg_resub_results, results_agg, "nn", "resub")
results_agg <- pp_agg_results(nn_agg_2fold_results, results_agg, "nn", 2L)
results_agg <- pp_agg_results(nn_agg_5fold_results, results_agg, "nn", 5L)
results_agg <- pp_agg_results(nn_agg_10fold_results, results_agg, "nn", 10L)
results_agg <- pp_agg_results(nn_agg_logo_results, results_agg, "nn", "logo")
results_agg <- pp_agg_results(nn_agg_lmgo_results, results_agg, "nn", "lmgo")
```

## 5.2 Aggregate Basins - BS
```{r pp_bs}
# make a copy of the original dataframe
results_agg_bs <- df_lm_agg

# use the dataframe above to add information to the results from modeling
pp_agg_results_bs <- function(resultsls, resultsdf, modeltype, groupingstyle){
  results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
  resultsdf_selected <- resultsdf[results_unlisted$nforstitch, ]
  resultsdf_pp <- cbind(resultsdf_selected, results_unlisted)
  # # delete the extra columns, keep them for plotting
  # resultsdf_pp <- resultsdf_pp[, -c((ncol(resultsdf_pp)-2), ncol(resultsdf_pp))]
  resultsdf_pp$res <- resultsdf_pp$pred-resultsdf_pp$FLOW
  # easier to use obs and pred as column names for plotting functions
  # colnames(resultsdf_pp)[(ncol(resultsdf_pp)-1)] <- paste0(toupper(modeltype), "_", toupper(groupingstyle), "FIT")
  # colnames(resultsdf_pp)[ncol(resultsdf_pp)] <- paste0(toupper(modeltype), "_", toupper(groupingstyle), "RES")
  return(resultsdf_pp)
}

results_agg_bs_lm_iid <- pp_agg_results_bs(lm_agg_iid_results, results_agg_bs,  "lm", "iid")
results_agg_bs_lm_bbg <- pp_agg_results_bs(lm_agg_bbg_results, results_agg_bs, "lm", "bbg")
results_agg_bs_lm_bbmg <- pp_agg_results_bs(lm_agg_bbmg_results, results_agg_bs, "lm", "bbmg")

results_agg_bs_glm_iid <- pp_agg_results_bs(glm_agg_iid_results, results_agg_bs, "glm", "iid")
results_agg_bs_glm_bbg <- pp_agg_results_bs(glm_agg_bbg_results, results_agg_bs, "glm", "bbg")
results_agg_bs_glm_bbmg <- pp_agg_results_bs(glm_agg_bbmg_results, results_agg_bs, "glm", "bbmg")

results_agg_bs_rf_iid <- pp_agg_results_bs(rf_agg_iid_results, results_agg_bs, "rf", "iid")
results_agg_bs_rf_bbg <- pp_agg_results_bs(rf_agg_bbg_results, results_agg_bs, "rf", "bbg")
results_agg_bs_rf_bbmg <- pp_agg_results_bs(rf_agg_bbmg_results, results_agg_bs, "rf", "bbmg")

results_agg_bs_nn_iid <- pp_agg_results_bs(nn_agg_iid_results, results_agg_bs, "nn", "iid")
results_agg_bs_nn_bbg <- pp_agg_results_bs(nn_agg_bbg_results, results_agg_bs, "nn", "bbg")
results_agg_bs_nn_bbmg <- pp_agg_results_bs(nn_agg_bbmg_results, results_agg_bs, "nn", "bbmg")
```

## 5.3 GOF Post Processing
```{r post_processing_gof_cv}
gof_lm_resub_agg <- gof(results_agg$LM_RESUBFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_resub_agg <- gof(results_agg$GLM_RESUBFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_resub_agg <- gof(results_agg$RF_RESUBFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_resub_agg <- gof(results_agg$NN_RESUBFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_2fold_agg <- gof(results_agg$LM_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_2fold_agg <- gof(results_agg$GLM_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_2fold_agg <- gof(results_agg$RF_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_2fold_agg <- gof(results_agg$NN_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_5fold_agg <- gof(results_agg$LM_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_5fold_agg <- gof(results_agg$GLM_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_5fold_agg <- gof(results_agg$RF_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_5fold_agg <- gof(results_agg$NN_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_10fold_agg <- gof(results_agg$LM_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_10fold_agg <- gof(results_agg$GLM_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_10fold_agg <- gof(results_agg$RF_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_10fold_agg <- gof(results_agg$NN_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_logo_agg <- gof(results_agg$LM_LOGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_logo_agg <- gof(results_agg$GLM_LOGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_logo_agg <- gof(results_agg$RF_LOGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_logo_agg <- gof(results_agg$NN_LOGOFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_lmgo_agg <- gof(results_agg$LM_LMGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_lmgo_agg <- gof(results_agg$GLM_LMGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_lmgo_agg <- gof(results_agg$RF_LMGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_lmgo_agg <- gof(results_agg$NN_LMGOFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_agg <- cbind(gof_lm_resub_agg, gof_lm_2fold_agg, gof_lm_5fold_agg, gof_lm_10fold_agg, gof_lm_logo_agg, gof_lm_lmgo_agg)
gof_glm_agg <- cbind(gof_glm_resub_agg, gof_glm_2fold_agg, gof_glm_5fold_agg, gof_glm_10fold_agg, gof_glm_logo_agg, gof_glm_lmgo_agg)
gof_rf_agg <- cbind(gof_rf_resub_agg, gof_rf_2fold_agg, gof_rf_5fold_agg, gof_rf_10fold_agg, gof_rf_logo_agg, gof_rf_lmgo_agg)
gof_nn_agg <- cbind(gof_nn_resub_agg, gof_nn_2fold_agg, gof_nn_5fold_agg, gof_nn_10fold_agg, gof_nn_logo_agg, gof_nn_lmgo_agg)

colnames(gof_lm_agg) <- c("LM_RESUB", "LM_2FOLD", "LM_5FOLD", "LM_10FOLD", "LM_LOGO", "LM_LMGO")
colnames(gof_glm_agg) <- c("GLM_RESUB", "GLM_2FOLD", "GLM_5FOLD", "GLM_10FOLD", "GLM_LOGO", "GLM_LMGO")
colnames(gof_rf_agg) <- c("RF_RESUB", "RF_2FOLD", "RF_5FOLD", "RF_10FOLD", "RF_LOGO", "RF_LMGO")
colnames(gof_nn_agg) <- c("NN_RESUB", "NN_2FOLD", "NN_5FOLD", "NN_10FOLD", "NN_LOGO", "NN_LMGO")

gof_all <- as.data.frame(cbind(gof_lm_agg, gof_glm_agg, gof_rf_agg, gof_nn_agg))

library(Hmisc)
var_labels <- c("LM Resub", "LM 2 Fold", "LM 5 Fold", "LM 10 Fold", "LM Logo", "LM Lmgo", "GLM Resub", "GLM 2 Fold", "GLM 5 Fold", "GLM 10 Fold", "GLM Logo", "GLM Lmgo", "RF Resub", "RF 2 Fold", "RF 5 Fold", "RF 10 Fold", "RF Logo", "RF Lmgo", "NN Resub", "NN 2 Fold", "NN 5 Fold", "NN 10 Fold", "NN Logo", "NN Lmgo") 
names(var_labels) <- colnames(gof_all)
Hmisc::label(gof_all) <- lapply(names(var_labels), function(x) Hmisc::label(gof_all[,x]) = var_labels[x])

# for latex documents, put this in appendix
library(xtable)
xtable(data.frame(gof_all))

# check results
gof_all["bR2",]
```

```{r post_processing_gof_by_basins_cv}
gof_lm_resub_agg <- gof_glm_resub_agg <- gof_rf_resub_agg <- gof_nn_resub_agg <- list()
gof_lm_2fold_agg <- gof_glm_2fold_agg <- gof_rf_2fold_agg <- gof_nn_2fold_agg <- list()
gof_lm_5fold_agg <- gof_glm_5fold_agg <- gof_rf_5fold_agg <- gof_nn_5fold_agg <- list()
gof_lm_10fold_agg <- gof_glm_10fold_agg <- gof_rf_10fold_agg <- gof_nn_10fold_agg <- list()
gof_lm_logo_agg <- gof_glm_logo_agg <- gof_rf_logo_agg <- gof_nn_logo_agg <- list()
gof_lm_lmgo_agg <- gof_glm_lmgo_agg <- gof_rf_lmgo_agg <- gof_nn_lmgo_agg <- list()

for (r in 1:(length(unique(results_agg$CDEC_ID)))){ 
  h <- unique(results_agg$CDEC_ID)[r]
  resultsdf_sub <- results_agg[results_agg$CDEC_ID==h,]
  
  gof_lm_resub_agg[[r]] <- gof(resultsdf_sub$LM_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_resub_agg[[r]] <- gof(resultsdf_sub$GLM_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_resub_agg[[r]] <- gof(resultsdf_sub$RF_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_resub_agg[[r]] <- gof(resultsdf_sub$NN_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_2fold_agg[[r]] <- gof(resultsdf_sub$LM_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_2fold_agg[[r]] <- gof(resultsdf_sub$GLM_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_2fold_agg[[r]] <- gof(resultsdf_sub$RF_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_2fold_agg[[r]] <- gof(resultsdf_sub$NN_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_5fold_agg[[r]] <- gof(resultsdf_sub$LM_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_5fold_agg[[r]] <- gof(resultsdf_sub$GLM_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_5fold_agg[[r]] <- gof(resultsdf_sub$RF_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_5fold_agg[[r]] <- gof(resultsdf_sub$NN_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_10fold_agg[[r]] <- gof(resultsdf_sub$LM_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_10fold_agg[[r]] <- gof(resultsdf_sub$GLM_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_10fold_agg[[r]] <- gof(resultsdf_sub$RF_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_10fold_agg[[r]] <- gof(resultsdf_sub$NN_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_logo_agg[[r]] <- gof(resultsdf_sub$LM_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_logo_agg[[r]] <- gof(resultsdf_sub$GLM_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_logo_agg[[r]] <- gof(resultsdf_sub$RF_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_logo_agg[[r]] <- gof(resultsdf_sub$NN_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_lmgo_agg[[r]] <- gof(resultsdf_sub$LM_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_lmgo_agg[[r]] <- gof(resultsdf_sub$GLM_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_lmgo_agg[[r]] <- gof(resultsdf_sub$RF_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_lmgo_agg[[r]] <- gof(resultsdf_sub$NN_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
}

names_tbd <- rownames(gof_lm_resub_agg[[1]])
gof_lm_resub_agg_by_basins <- data.frame(matrix(unlist(gof_lm_resub_agg), nrow=length(gof_lm_resub_agg[[1]]), byrow=FALSE))
gof_glm_resub_agg_by_basins <- data.frame(matrix(unlist(gof_glm_resub_agg), nrow=length(gof_glm_resub_agg[[1]]), byrow=FALSE))
gof_rf_resub_agg_by_basins <- data.frame(matrix(unlist(gof_rf_resub_agg), nrow=length(gof_rf_resub_agg[[1]]), byrow=FALSE))
gof_nn_resub_agg_by_basins <- data.frame(matrix(unlist(gof_nn_resub_agg), nrow=length(gof_nn_resub_agg[[1]]), byrow=FALSE))
gof_lm_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_lm_2fold_agg), nrow=length(gof_lm_2fold_agg[[1]]), byrow=FALSE))
gof_glm_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_glm_2fold_agg), nrow=length(gof_glm_2fold_agg[[1]]), byrow=FALSE))
gof_rf_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_rf_2fold_agg), nrow=length(gof_rf_2fold_agg[[1]]), byrow=FALSE))
gof_nn_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_nn_2fold_agg), nrow=length(gof_nn_2fold_agg[[1]]), byrow=FALSE))
gof_lm_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_lm_5fold_agg), nrow=length(gof_lm_5fold_agg[[1]]), byrow=FALSE))
gof_glm_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_glm_5fold_agg), nrow=length(gof_glm_5fold_agg[[1]]), byrow=FALSE))
gof_rf_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_rf_5fold_agg), nrow=length(gof_rf_5fold_agg[[1]]), byrow=FALSE))
gof_nn_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_nn_5fold_agg), nrow=length(gof_nn_5fold_agg[[1]]), byrow=FALSE))
gof_lm_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_lm_10fold_agg), nrow=length(gof_lm_10fold_agg[[1]]), byrow=FALSE))
gof_glm_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_glm_10fold_agg), nrow=length(gof_glm_10fold_agg[[1]]), byrow=FALSE))
gof_rf_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_rf_10fold_agg), nrow=length(gof_rf_10fold_agg[[1]]), byrow=FALSE))
gof_nn_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_nn_10fold_agg), nrow=length(gof_nn_10fold_agg[[1]]), byrow=FALSE))
gof_lm_logo_agg_by_basins <- data.frame(matrix(unlist(gof_lm_logo_agg), nrow=length(gof_lm_logo_agg[[1]]), byrow=FALSE))
gof_glm_logo_agg_by_basins <- data.frame(matrix(unlist(gof_glm_logo_agg), nrow=length(gof_glm_logo_agg[[1]]), byrow=FALSE))
gof_rf_logo_agg_by_basins <- data.frame(matrix(unlist(gof_rf_logo_agg), nrow=length(gof_rf_logo_agg[[1]]), byrow=FALSE))
gof_nn_logo_agg_by_basins <- data.frame(matrix(unlist(gof_nn_logo_agg), nrow=length(gof_nn_logo_agg[[1]]), byrow=FALSE))
gof_lm_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_lm_lmgo_agg), nrow=length(gof_lm_lmgo_agg[[1]]), byrow=FALSE))
gof_glm_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_glm_lmgo_agg), nrow=length(gof_glm_lmgo_agg[[1]]), byrow=FALSE))
gof_rf_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_rf_lmgo_agg), nrow=length(gof_rf_lmgo_agg[[1]]), byrow=FALSE))
gof_nn_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_nn_lmgo_agg), nrow=length(gof_nn_lmgo_agg[[1]]), byrow=FALSE))

rownames(gof_lm_resub_agg_by_basins) <- names_tbd
rownames(gof_glm_resub_agg_by_basins) <- names_tbd
rownames(gof_rf_resub_agg_by_basins) <- names_tbd
rownames(gof_nn_resub_agg_by_basins) <- names_tbd
rownames(gof_lm_2fold_agg_by_basins) <- names_tbd
rownames(gof_glm_2fold_agg_by_basins) <- names_tbd
rownames(gof_rf_2fold_agg_by_basins) <- names_tbd
rownames(gof_nn_2fold_agg_by_basins) <- names_tbd
rownames(gof_lm_5fold_agg_by_basins) <- names_tbd
rownames(gof_glm_5fold_agg_by_basins) <- names_tbd
rownames(gof_rf_5fold_agg_by_basins) <- names_tbd
rownames(gof_nn_5fold_agg_by_basins) <- names_tbd
rownames(gof_lm_10fold_agg_by_basins) <- names_tbd
rownames(gof_glm_10fold_agg_by_basins) <- names_tbd
rownames(gof_rf_10fold_agg_by_basins) <- names_tbd
rownames(gof_nn_10fold_agg_by_basins) <- names_tbd
rownames(gof_lm_logo_agg_by_basins) <- names_tbd
rownames(gof_glm_logo_agg_by_basins) <- names_tbd
rownames(gof_rf_logo_agg_by_basins) <- names_tbd
rownames(gof_nn_logo_agg_by_basins) <- names_tbd
rownames(gof_lm_lmgo_agg_by_basins) <- names_tbd
rownames(gof_glm_lmgo_agg_by_basins) <- names_tbd
rownames(gof_rf_lmgo_agg_by_basins) <- names_tbd
rownames(gof_nn_lmgo_agg_by_basins) <- names_tbd
  
colnames(gof_lm_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID) 
colnames(gof_lm_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
  
remove(names_tbd)
```

```{r post_processing_gof_bs_1}
# average the gofs over the nsim runs 
# make a wide df with the gof of each simulation in the columns and the simulations across the rows
pp_gof_sims_bs <- function(gofls){
  gof_sims <- data.frame(matrix(unlist(gofls), nrow=length(gofls), byrow=T))
  colnames(gof_sims) <- rownames(gofls[[1]])
  gof_sims
}

gof_lm_iid_agg_sims <- pp_gof_sims_bs(lm_agg_iid_results$gof)
gof_lm_iid_agg <- colMeans(gof_lm_iid_agg_sims)
gof_lm_iid_agg_sd <- apply(gof_lm_iid_agg_sims, 2, sd, na.rm = TRUE)
gof_lm_bbg_agg_sims <- pp_gof_sims_bs(lm_agg_bbg_results$gof)
gof_lm_bbg_agg <- colMeans(gof_lm_bbg_agg_sims)
gof_lm_bbg_agg_sd <- apply(gof_lm_bbg_agg_sims, 2, sd, na.rm = TRUE)
gof_lm_bbmg_agg_sims <- pp_gof_sims_bs(lm_agg_bbmg_results$gof)
gof_lm_bbmg_agg <- colMeans(gof_lm_bbmg_agg_sims)
gof_lm_bbmg_agg_sd <- apply(gof_lm_bbmg_agg_sims, 2, sd, na.rm = TRUE)

gof_glm_iid_agg_sims <- pp_gof_sims_bs(glm_agg_iid_results$gof)
gof_glm_iid_agg <- colMeans(gof_glm_iid_agg_sims)
gof_glm_iid_agg_sd <- apply(gof_glm_iid_agg_sims, 2, sd, na.rm = TRUE)
gof_glm_bbg_agg_sims <- pp_gof_sims_bs(glm_agg_bbg_results$gof)
gof_glm_bbg_agg <- colMeans(gof_glm_bbg_agg_sims)
gof_glm_bbg_agg_sd <- apply(gof_glm_bbg_agg_sims, 2, sd, na.rm = TRUE)
gof_glm_bbmg_agg_sims <- pp_gof_sims_bs(glm_agg_bbmg_results$gof)
gof_glm_bbmg_agg <- colMeans(gof_glm_bbmg_agg_sims)
gof_glm_bbmg_agg_sd <- apply(gof_glm_bbmg_agg_sims, 2, sd, na.rm = TRUE)

gof_rf_iid_agg_sims <- pp_gof_sims_bs(rf_agg_iid_results$gof)
gof_rf_iid_agg <- colMeans(gof_rf_iid_agg_sims)
gof_rf_iid_agg_sd <- apply(gof_rf_iid_agg_sims, 2, sd, na.rm = TRUE)
gof_rf_bbg_agg_sims <- pp_gof_sims_bs(rf_agg_bbg_results$gof)
gof_rf_bbg_agg <- colMeans(gof_rf_bbg_agg_sims)
gof_rf_bbg_agg_sd <- apply(gof_rf_bbg_agg_sims, 2, sd, na.rm = TRUE)
gof_rf_bbmg_agg_sims <- pp_gof_sims_bs(rf_agg_bbmg_results$gof)
gof_rf_bbmg_agg <- colMeans(gof_rf_bbmg_agg_sims)
gof_rf_bbmg_agg_sd <- apply(gof_rf_bbmg_agg_sims, 2, sd, na.rm = TRUE)

gof_nn_iid_agg_sims <- pp_gof_sims_bs(nn_agg_iid_results$gof)
gof_nn_iid_agg <- colMeans(gof_nn_iid_agg_sims)
gof_nn_iid_agg_sd <- apply(gof_nn_iid_agg_sims, 2, sd, na.rm = TRUE)
gof_nn_bbg_agg_sims <- pp_gof_sims_bs(nn_agg_bbg_results$gof)
gof_nn_bbg_agg <- colMeans(gof_nn_bbg_agg_sims)
gof_nn_bbg_agg_sd <- apply(gof_nn_bbg_agg_sims, 2, sd, na.rm = TRUE)
gof_nn_bbmg_agg_sims <- pp_gof_sims_bs(nn_agg_bbmg_results$gof)
gof_nn_bbmg_agg <- colMeans(gof_nn_bbmg_agg_sims)
gof_nn_bbmg_agg_sd <- apply(gof_nn_bbmg_agg_sims, 2, sd, na.rm = TRUE)

# for the means
gof_lm_agg_bs <- cbind(gof_lm_iid_agg, gof_lm_bbg_agg, gof_lm_bbmg_agg)
gof_glm_agg_bs <- cbind(gof_glm_iid_agg, gof_glm_bbg_agg, gof_glm_bbmg_agg)
gof_rf_agg_bs <- cbind(gof_rf_iid_agg, gof_rf_bbg_agg, gof_rf_bbmg_agg)
gof_nn_agg_bs <- cbind(gof_nn_iid_agg, gof_nn_bbg_agg, gof_nn_bbmg_agg)

# for the sd
gof_lm_agg_bs_sd <- cbind(gof_lm_iid_agg_sd, gof_lm_bbg_agg_sd, gof_lm_bbmg_agg_sd)
gof_glm_agg_bs_sd <- cbind(gof_glm_iid_agg_sd, gof_glm_bbg_agg_sd, gof_glm_bbmg_agg_sd)
gof_rf_agg_bs_sd <- cbind(gof_rf_iid_agg_sd, gof_rf_bbg_agg_sd, gof_rf_bbmg_agg_sd)
gof_nn_agg_bs_sd <- cbind(gof_nn_iid_agg_sd, gof_nn_bbg_agg_sd, gof_nn_bbmg_agg_sd)

gof_all_bs <- as.data.frame(cbind(gof_lm_agg_bs, gof_glm_agg_bs, gof_rf_agg_bs, gof_nn_agg_bs))
gof_all_bs_sd <- as.data.frame(cbind(gof_lm_agg_bs_sd, gof_glm_agg_bs_sd, gof_rf_agg_bs_sd, gof_nn_agg_bs_sd))

library(Hmisc)
var_labels_bs <- c("LM IID", "LM BBG", "LM BBMG", "GLM IID", "GLM BBG", "GLM BBMG", "RF IID", "RF BBG", "RF BBMG", "NN IID", "NN BBG", "NN BBMG") 
names(var_labels_bs) <- colnames(gof_all_bs)
Hmisc::label(gof_all_bs) <- lapply(names(var_labels_bs), function(x) Hmisc::label(gof_all_bs[,x]) = var_labels_bs[x])

# for latex documents, put this in appendix
library(xtable)
xtable(data.frame(gof_all_bs))

# check results
gof_all_bs["bR2",]
gof_all_bs_sd["bR2",]

2*gof_all_bs_sd["bR2",]
```

```{r post_processing_gof_bs_2}
# get the simulation values in a data frame too, we need to see the spread 
pp_gof_sims_bs2 <- function(idd_sims, bbg_sims, bbmg_sims, gofofinterest){
  iid <- idd_sims[, gofofinterest]
  bbg <- bbg_sims[, gofofinterest]
  bbmg <- bbmg_sims[, gofofinterest]
  m <- cbind(iid, bbg, bbmg)
  colnames(m) <- c("IID", "BBG", "BBMG")
  m
}

lm_agg_br2_sims <- pp_gof_sims_bs2(gof_lm_iid_agg_sims, gof_lm_bbg_agg_sims, gof_lm_bbmg_agg_sims, "bR2")
glm_agg_br2_sims <- pp_gof_sims_bs2(gof_glm_iid_agg_sims, gof_glm_bbg_agg_sims, gof_glm_bbmg_agg_sims, "bR2")
rf_agg_br2_sims <- pp_gof_sims_bs2(gof_rf_iid_agg_sims, gof_rf_bbg_agg_sims, gof_rf_bbmg_agg_sims, "bR2")
nn_agg_br2_sims <- pp_gof_sims_bs2(gof_nn_iid_agg_sims, gof_nn_bbg_agg_sims, gof_nn_bbmg_agg_sims, "bR2")

# put them all in one dataframe for ggplot
library(reshape2)

pp_gof_sims_bs3 <- function(lm_gof_sims, glm_gof_sims, rf_gof_sims, nn_gof_sims){
  lm_gof_sims_melted <- melt(lm_gof_sims)
  colnames(lm_gof_sims_melted) <- c("NSIM", "BSTYPE", "VALUE")
  lm_gof_sims_melted$MODELTYPE <- "LM"
  
  glm_gof_sims_melted <- melt(glm_gof_sims)
  colnames(glm_gof_sims_melted) <- c("NSIM", "BSTYPE", "VALUE")
  glm_gof_sims_melted$MODELTYPE <- "GLM"
  
  rf_gof_sims_melted <- melt(rf_gof_sims)
  colnames(rf_gof_sims_melted) <- c("NSIM", "BSTYPE", "VALUE")
  rf_gof_sims_melted$MODELTYPE <- "RF"
  
  nn_gof_sims_melted <- melt(nn_gof_sims)
  colnames(nn_gof_sims_melted) <- c("NSIM", "BSTYPE", "VALUE")
  nn_gof_sims_melted$MODELTYPE <- "NN"
  
  gof_sims_melted <- rbind(lm_gof_sims_melted, glm_gof_sims_melted, rf_gof_sims_melted, nn_gof_sims_melted)
  
  gof_sims_melted$MODELTYPE <- factor(gof_sims_melted$MODELTYPE, levels= c("LM", "GLM", "RF", "NN"))
  gof_sims_melted$BSTYPE <- factor(gof_sims_melted$BSTYPE, levels = c("BBMG", "BBG", "IID"))

  gof_sims_melted
}

br2_sims_melted <- pp_gof_sims_bs3(lm_agg_br2_sims, glm_agg_br2_sims, rf_agg_br2_sims, nn_agg_br2_sims)
```

```{r post_processing_gof_by_basins_bs}
gof_bs_by_basins <- function(resultsdf){
  # resultsdf <- na.omit(resultsdf) figured out why there were NAs and resolved it
  gof_model_grouping_agg <- list()
  for (r in 1:(length(unique(resultsdf$CDEC_ID)))){ 
    h <- unique(resultsdf$CDEC_ID)[r]
    resultsdf_sub <- resultsdf[resultsdf$CDEC_ID==h,]
    gof_model_grouping_agg[[r]] <- gof(resultsdf_sub$pred, resultsdf_sub$obs, na.rm=TRUE)
  }
  names_tbd <- rownames(gof_model_grouping_agg[[1]])
  gof_by_basins <- data.frame(matrix(unlist(gof_model_grouping_agg), nrow=length(gof_model_grouping_agg[[1]]), byrow=FALSE))
  rownames(gof_by_basins) <- names_tbd
  colnames(gof_by_basins) <- unique(resultsdf$CDEC_ID)
  return(gof_by_basins)
}

gof_lm_iid_agg_by_basins <- gof_bs_by_basins(results_agg_bs_lm_iid)
gof_lm_bbg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_lm_bbg)
gof_lm_bbmg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_lm_bbmg)

gof_glm_iid_agg_by_basins <- gof_bs_by_basins(results_agg_bs_glm_iid)
gof_glm_bbg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_glm_bbg)
gof_glm_bbmg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_glm_bbmg)

gof_rf_iid_agg_by_basins <- gof_bs_by_basins(results_agg_bs_rf_iid)
gof_rf_bbg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_rf_bbg)
gof_rf_bbmg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_rf_bbmg)

gof_nn_iid_agg_by_basins <- gof_bs_by_basins(results_agg_bs_nn_iid)
gof_nn_bbg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_nn_bbg)
gof_nn_bbmg_agg_by_basins <- gof_bs_by_basins(results_agg_bs_nn_bbmg)
```

# 6.0 Plots

## 6.1 GOF Comparisons
```{r mof_comp_plots}
# CV plot, just for bR2
goftablet <- data.frame(t(gof_all))
goftablet$MODELTYPE <- factor(c("LM", "LM", "LM", "LM", "LM", "LM", "GLM", "GLM", "GLM", "GLM", "GLM", "GLM", "RF", "RF", "RF", "RF", "RF", "RF", "NN", "NN", "NN", "NN", "NN", "NN"), levels= c("LM", "GLM", "RF", "NN"))
goftablet$CVTYPE <- rep(c("RESUB", "2FOLD", "5FOLD", "10FOLD", "LOGO", "LMGO"), times=4)
goftablet$COLORS <- c(cbpblack[2], cbpblack[3], cbpblack[5], cbpblack[6])[goftablet$MODELTYPE]

png('ch4 resampling/outputdata/rplot41_gof_bR2.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  plottoprint <- ggplot(goftablet)+
    #geom_rect(aes(xmin=0.2, xmax=0.5, ymin=1, ymax=24 col=cbpblack[2], alpha=0.2))+
    geom_point(aes(x = bR2, y = reorder(rownames(goftablet), bR2), color=MODELTYPE, shape=CVTYPE))+
    scale_y_discrete(labels=var_labels[match(rownames(goftablet), names(var_labels))])+
    theme_bw(base_size = 8) +
    annotate("rect", xmin = 0.2, xmax = 0.5, ymin = 1, ymax = 24, fill= "grey55", alpha = 0.5) +
    annotate("rect", xmin = 0.5, xmax = 0.65, ymin = 1, ymax = 24, fill= "grey70", alpha = 0.5) +
    annotate("rect", xmin = 0.65, xmax = 0.75, ymin = 1, ymax = 24, fill= "grey85", alpha = 0.5) +
    annotate("rect", xmin = 0.75, xmax = 1.0, ymin = 1, ymax = 24, fill= "grey95", alpha = 0.5) +
    geom_text(aes(x = bR2, y = reorder(rownames(goftablet), bR2), label=bR2), nudge_x = 0.03, size=3) +
    geom_text(aes(x= 0.35, y=24, label="Unsatisfactory"), size=3, hjust="center")+
    geom_text(aes(x= 0.575, y=24, label="Satisfactory"), size=3, hjust="center")+
    geom_text(aes(x= 0.7, y=1, label="Good"), size=3, hjust="center")+
    geom_text(aes(x= 0.875, y=1, label="Very Good"), size=3, hjust="center")+
    ylab("") +
    xlab("Bias-Corrected Coefficient of Determination (-)") +
    theme(legend.title = element_blank(), legend.text=element_text(size=10), text=element_text(size=10), legend.position = "right", legend.box = "vertical", axis.text.y = element_text(colour=goftablet[order(goftablet$bR2),]$COLOR))+
    scale_colour_manual(aesthetics = c("colour"), values=c(cbpblack[2], cbpblack[3], cbpblack[5], cbpblack[6])) +  
    scale_shape_manual(breaks = c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"), values=c(2, 8, 5, 15, 16, 4)) + # to order the legend
    guides(colour = guide_legend(ncol=1), shape = guide_legend(ncol=1))
  print(plottoprint)
dev.off()

# try putting a bracket around NN and RF and call them out, not doing this just yet
# library(grid)
# library(pBrackets) 
# 
# png('ch4 resampling/outputdata/rplot41_gof_bR2.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
# plottoprint
# grid.locator(unit="native") 
# grid.brackets(2200, 28,   2300, 28, lwd=2, col="red")
# dev.off()

# BS plot, just for bR2
goftablet_bs <- data.frame(t(gof_all_bs))
goftablet_bs$MODELTYPE <- factor(c("LM", "LM", "LM", "GLM", "GLM", "GLM", "RF", "RF", "RF", "NN", "NN", "NN"), levels= c("LM", "GLM", "RF", "NN"))
goftablet_bs$BSTYPE <- rep(c("IID", "BBG", "BBMG"), times=4)
goftablet_bs$COLORS <- c(cbpblack[2], cbpblack[3], cbpblack[5], cbpblack[6])[goftablet_bs$MODELTYPE]

png('ch4 resampling/outputdata/rplot41_gof_bR2_bs.png', width=6.5, height=2, units="in", pointsize=8, res=1200)
  ggplot(goftablet_bs)+
    geom_point(aes(x = bR2, y = reorder(rownames(goftablet_bs), bR2), color=MODELTYPE, shape=BSTYPE))+
    scale_y_discrete(labels=var_labels_bs[match(rownames(goftablet_bs), names(var_labels_bs))])+
    theme_bw(base_size = 8) +
    annotate("rect", xmin = 0.2, xmax = 0.5, ymin = 1, ymax = 12, fill= "grey55", alpha = 0.5) +
    annotate("rect", xmin = 0.5, xmax = 0.65, ymin = 1, ymax = 12, fill= "grey70", alpha = 0.5) +
    annotate("rect", xmin = 0.65, xmax = 0.75, ymin = 1, ymax = 12, fill= "grey85", alpha = 0.5) +
    annotate("rect", xmin = 0.75, xmax = 1.0, ymin = 1, ymax = 12, fill= "grey95", alpha = 0.5) +
    geom_text(aes(x = bR2, y = reorder(rownames(goftablet_bs), bR2), label=round(bR2, digits=2)), nudge_x = 0.03, size=3)+
    geom_text(aes(x= 0.35, y=12, label="Unsatisfactory"), size=3, hjust="center")+
    geom_text(aes(x= 0.575, y=12, label="Satisfactory"), size=3, hjust="center")+
    geom_text(aes(x= 0.7, y=1, label="Good"), size=3, hjust="center")+
    geom_text(aes(x= 0.875, y=1, label="Very Good"), size=3, hjust="center")+
    ylab("") +
    xlab("Bias-Corrected Coefficient of Determination (-)") +
    theme(legend.title = element_blank(), legend.text=element_text(size=10), text=element_text(size=10), legend.position = "right", legend.box = "vertical", axis.text.y = element_text(colour=goftablet_bs[order(goftablet_bs$bR2),]$COLOR))+
    scale_colour_manual(aesthetics = c("colour"), values=c(cbpblack[2], cbpblack[3], cbpblack[5], cbpblack[6])) +
    scale_shape_manual(breaks = c("IID", "BBG", "BBMG"), values=c(16, 2, 4)) + # to order the legend
    guides(colour = guide_legend(ncol=1), shape = guide_legend(ncol=1))
dev.off()
```

```{r mof_comp_ggplots} 
# for CV
png('ch4 resampling/outputdata/rplot42_gof_bR2.png', width=6.5, height=2, units="in", pointsize=8, res=1200)
  plottoprint <- ggplot(goftablet, aes(x=MODELTYPE, y=bR2, fill=CVTYPE))+
    geom_point(aes(group=MODELTYPE, col=CVTYPE),position=position_jitterdodge(jitter.width = 0.25, jitter.height = 0, dodge.width = 0.85, seed = NA), alpha=0.8, show.legend=TRUE) +
    coord_flip() +
    theme_bw(base_size = 8) +
    ylab("Bias-Corrected Coefficient of Determination (-)") +
    xlab("") +
    theme(legend.title = element_blank(), legend.text=element_text(size=10), text=element_text(size=10), legend.position = "right")+
    scale_colour_manual(aesthetics = c("colour", "fill"), values=c(cbpblack[3], cbpblack[5], cbpblack[4], cbpblack[6], cbpblack[8], cbpblack[2]), breaks = c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"))  # to order the legend
  print(plottoprint)
dev.off()

# for BS, boxplot this time
png('ch4 resampling/outputdata/rplot42_gof_bR2_bs_boxplot.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  plottoprint <- ggplot(br2_sims_melted, aes(x=MODELTYPE, y=VALUE, fill=BSTYPE))+
    geom_boxplot(outlier.shape=NA, alpha=0.3, position=position_dodge(0.85), show.legend = FALSE) +
    geom_point(position=position_jitterdodge(jitter.width = 0.2, jitter.height = 0,
dodge.width = 0.85, seed = NA), aes(group=BSTYPE, col=BSTYPE, shape=BSTYPE), alpha=0.5) +
    scale_color_manual(name="Type", breaks = c("IID", "BBG", "BBMG"), labels=c("IID", "BBG", "BMG"), values=c(cbpblack[5], cbpblack[3], cbpblack[2])) +
    scale_fill_manual(name="Type", breaks = c("IID", "BBG", "BBMG"), labels=c("IID", "BBG", "BMG"), values=c(cbpblack[5], cbpblack[3], cbpblack[2])) +
    scale_shape_manual(name="Type", breaks = c("IID", "BBG", "BBMG"), labels=c("IID", "BBG", "BMG"), values=c(1, 2, 0)) +
    coord_flip() +
    theme_bw(base_size = 8) +
    ylab("Bias-Corrected Coefficient of Determination (-)") +
    xlab("") +
    theme(legend.title = element_blank(), legend.text=element_text(size=10), text=element_text(size=10), legend.position = "right")
  print(plottoprint)
dev.off()
```

## 6.2 Observed vs. Predicted 
```{r obsvspred_forpaper_ggplot}
# to replace the base plots above
mastercv_lm <- results_agg[,c("HIERARCHY", "FLOW", "LM_RESUBFIT", "LM_2FOLDFIT", "LM_5FOLDFIT", "LM_10FOLDFIT", "LM_LOGOFIT", "LM_LMGOFIT")]
mastercv_glm <- results_agg[,c ("HIERARCHY", "FLOW", "GLM_RESUBFIT", "GLM_2FOLDFIT", "GLM_5FOLDFIT", "GLM_10FOLDFIT", "GLM_LOGOFIT", "GLM_LMGOFIT")]
mastercv_rf <- results_agg[,c("HIERARCHY","FLOW", "RF_RESUBFIT", "RF_2FOLDFIT", "RF_5FOLDFIT", "RF_10FOLDFIT", "RF_LOGOFIT", "RF_LMGOFIT")]
mastercv_nn <- results_agg[,c("HIERARCHY", "FLOW", "NN_RESUBFIT", "NN_2FOLDFIT", "NN_5FOLDFIT", "NN_10FOLDFIT", "NN_LOGOFIT", "NN_LMGOFIT")]

mastercv_lm$MODELTYPE <- "LM"
mastercv_glm$MODELTYPE <- "GLM"
mastercv_rf$MODELTYPE <- "RF"
mastercv_nn$MODELTYPE <- "NN"

colnames(mastercv_lm)[1:8] <- colnames(mastercv_glm)[1:8] <- colnames(mastercv_rf)[1:8] <- colnames(mastercv_nn)[1:8] <- c("HIERARCHY", "OBS", "RESUB", "2FOLD", "5FOLD", "10FOLD", "LOGO", "LMGO")

# just do NN for now, so don't join
# master_cv <- rbind(mastercv_lm, mastercv_glm, mastercv_rf, mastercv_nn)
master_cv_melted <- melt(mastercv_nn, measure.vars= c("RESUB", "2FOLD", "5FOLD", "10FOLD", "LOGO", "LMGO"), variable.name="GROUPINGSTYLE", value.name="PRED")
master_cv_melted$MODELTYPE <- factor(master_cv_melted$MODELTYPE, levels=c("LM", "GLM", "RF", "NN"))
master_cv_melted$GROUPINGSTYLE <- factor(master_cv_melted$GROUPINGSTYLE, levels=c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"))
master_cv_melted$HIERARCHY <- factor(master_cv_melted$HIERARCHY, levels=c("1", "2", "3", "4", "5"))

pretty_facet_labels <- c("Resubstitution", "Random 10 Fold", "Random 5 Fold", "Random 2 Fold", "Leave One Group Out (LOGO)", "Leave Multiple Groups Out (LMGO)")
names(pretty_facet_labels) <- c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO")

library(ggpmisc)
png('ch4 resampling/outputdata/rplot43_obsvspred_all_nn.png', width=6.5, height=8, units="in", pointsize=8, res=1200)
  plottoprint <- ggplot(master_cv_melted, aes(x=OBS, y=PRED)) +
    geom_point(aes(group=HIERARCHY, colour=HIERARCHY, shape=HIERARCHY)) +
    geom_smooth(method="lm", se=FALSE, color="black")+
    stat_poly_eq(formula = y ~ x, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
    geom_abline(slope=1, intercept=0, color="black", linetype=3)+
    facet_wrap(~GROUPINGSTYLE, ncol=2, labeller=labeller(GROUPINGSTYLE=pretty_facet_labels))+
    scale_discrete_manual(aesthetics = "color", values=c(cbpblack[2], cbpblack[3], cbpblack[4], cbpblack[5], cbpblack[6]), name="Hierarchy")+
    scale_discrete_manual(aesthetics= "shape", values=c(1, 16, 2, 0, 15), name="Hierarchy") +
    labs(x ="Observed Unimpaired Flow (AF/m)", y = "Predicted Unimpaired Flow (AF/m)", color = "")+
    theme(legend.text=element_text(size=10), text=element_text(size=10))+
    theme_bw(base_size = 8)
  print(plottoprint)
dev.off()
```

```{r obsvspred_forpaper_bs_ggplot}
master_bs_nn_iid <- results_agg_bs_nn_iid[, c("obs", "pred", "HIERARCHY")]
master_bs_nn_bbg <- results_agg_bs_nn_bbg[, c("obs", "pred", "HIERARCHY")]
master_bs_nn_bbmg <- results_agg_bs_nn_bbmg[, c("obs", "pred", "HIERARCHY")]

master_bs_nn_iid$GROUPINGSTYLE <- "IID"
master_bs_nn_bbg$GROUPINGSTYLE <- "BBG"
master_bs_nn_bbmg$GROUPINGSTYLE <- "BBMG"

master_bs_nn <- rbind(master_bs_nn_iid, master_bs_nn_bbg, master_bs_nn_bbmg)
master_bs_nn$MODELTYPE <- "NN"
colnames(master_bs_nn)[1:5] <- c("OBS", "PRED", "HIERARCHY", "GROUPINGSTYLE", "MODELTYPE")
master_bs_nn$GROUPINGSTYLE <- factor(master_bs_nn$GROUPINGSTYLE, levels=c("IID", "BBG", "BBMG"))
master_bs_nn$HIERARCHY <- factor(master_bs_nn$HIERARCHY, levels=c("1", "2", "3", "4", "5"))

# master_bs$MODELTYPE <- factor(master_bs$MODELTYPE, levels=c("LM", "GLM", "RF", "NN"))

pretty_facet_labels <- c("Random or IID", "Blocked By Group (BBG)", "Blocked By Multiple Groups (BBMG)")
names(pretty_facet_labels) <- c("IID", "BBG", "BBMG")

png('ch4 resampling/outputdata/rplot44_obsvspred_bs_all_nn.png', width=6.5, height=5.33, units="in", pointsize=8, res=1200)
  plottoprint <- ggplot(master_bs_nn, aes(x=OBS, y=PRED)) +
    geom_point(aes(group=HIERARCHY, colour=HIERARCHY, shape=HIERARCHY)) +
    geom_smooth(method="lm", se=FALSE, color="black")+
    stat_poly_eq(formula = y ~ x, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
    geom_abline(slope=1, intercept=0, color="black", linetype=3)+
    facet_wrap(~GROUPINGSTYLE, ncol=2, labeller=labeller(GROUPINGSTYLE=pretty_facet_labels))+
    scale_discrete_manual(aesthetics = "color", values=c(cbpblack[2], cbpblack[3], cbpblack[4], cbpblack[5], cbpblack[6]), name="Hierarchy")+
    scale_discrete_manual(aesthetics= "shape", values=c(1, 16, 2, 0, 15), name="Hierarchy") +
    labs(x ="Observed Unimpaired Flow (AF/m)", y = "Predicted Unimpaired Flow (AF/m)", color = "")+
    theme(legend.text=element_text(size=10), text=element_text(size=10))+
    theme_bw(base_size = 8)
  print(plottoprint)
dev.off()

# just checking the R2 values
# test=master_bs_nn[c(master_bs_nn$MODELTYPE=="NN", master_bs_nn$GROUPINGSTYLE=="IID"), ]
# summary(lm(test$PRED~test$OBS))
```

## 6.3 Density Plots
```{r error_density_plot_for_paper}
mastercv_lm <- results_agg[,c("FLOW", "LM_RESUBFIT", "LM_2FOLDFIT", "LM_5FOLDFIT", "LM_10FOLDFIT", "LM_LOGOFIT", "LM_LMGOFIT")]
mastercv_glm <- results_agg[,c("FLOW", "GLM_RESUBFIT", "GLM_2FOLDFIT", "GLM_5FOLDFIT", "GLM_10FOLDFIT", "GLM_LOGOFIT", "GLM_LMGOFIT")]
mastercv_rf <- results_agg[,c("FLOW", "RF_RESUBFIT", "RF_2FOLDFIT", "RF_5FOLDFIT", "RF_10FOLDFIT", "RF_LOGOFIT", "RF_LMGOFIT")]
mastercv_nn <- results_agg[,c("FLOW", "NN_RESUBFIT", "NN_2FOLDFIT", "NN_5FOLDFIT", "NN_10FOLDFIT", "NN_LOGOFIT", "NN_LMGOFIT")]

mastercv_lm$MODELTYPE <- "LM"
mastercv_glm$MODELTYPE <- "GLM"
mastercv_rf$MODELTYPE <- "RF"
mastercv_nn$MODELTYPE <- "NN"

colnames(mastercv_lm)[1:7] <- colnames(mastercv_glm)[1:7] <- colnames(mastercv_rf)[1:7] <- colnames(mastercv_nn)[1:7] <- c("OBS", "RESUB", "2FOLD", "5FOLD", "10FOLD", "LOGO", "LMGO")

master_cv <- rbind(mastercv_lm, mastercv_glm, mastercv_rf, mastercv_nn)
master_cv_melted <- melt(master_cv, measure.vars= c("RESUB", "2FOLD", "5FOLD", "10FOLD", "LOGO", "LMGO"), variable.name="GROUPINGSTYLE", value.name="FLOW")
master_cv_melted$MODELTYPE <- factor(master_cv_melted$MODELTYPE, levels=c("LM", "GLM", "RF", "NN"))
master_cv_melted$GROUPINGSTYLE <- factor(master_cv_melted$GROUPINGSTYLE, levels=c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"))

MODELTYPE.labs <- c("Linear Model (LM)", "Generalized Linear Model (GLM)", "Random Forest (RF)", "Neural Network (NN)")
names(MODELTYPE.labs) <- c("LM", "GLM", "RF", "NN")

png('ch4 resampling/outputdata/rplot47_density_all.png', width=3.25*2, height=2.85*2, units="in", pointsize=8, res=1200)
  plottoprint <- ggplot(master_cv_melted) +
    geom_density(aes(x=FLOW, group=GROUPINGSTYLE, colour=GROUPINGSTYLE, linetype=GROUPINGSTYLE), position=position_dodge(width=0.2)) +
    facet_wrap(~MODELTYPE, labeller=labeller(MODELTYPE=MODELTYPE.labs))+
    scale_discrete_manual(aesthetics = "color", values=c(cbpblack[2], cbpblack[3], cbpblack[4], cbpblack[5], cbpblack[8], cbpblack[6]), name="Pred", breaks = c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"))+ 
    scale_linetype_manual(values=c("dashed", "dotted", "dotdash", "longdash", "twodash", "solid"), labels=c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"), name="Pred", breaks=c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"))+
    geom_density(aes(x=OBS, fill=""), alpha=0.2) +
    scale_discrete_manual(aesthetics = "fill", values=cbpblack[1], name="Obs")+
    guides(fill = guide_legend(override.aes = list(alpha = 0.2)))+
    scale_x_continuous(trans="log10")+
    labs(x ="Unimpaired Flow (AF/m)", y = "Density or Frequency of Occurance (%)", color = "")+
    annotation_logticks(sides="b")+
    theme(legend.text=element_text(size=10), text=element_text(size=10))+
    theme_bw(base_size = 8)
  print(plottoprint)
dev.off()
```

```{r error_density_plot_bs_for_paper}
ppfordensityplot <- function(agg_iid_results, agg_bbg_results, agg_bbmg_results){
  bindedls_iid <- do.call(rbind.data.frame, agg_iid_results$results)
  bindedls_bbg <- do.call(rbind.data.frame, agg_bbg_results$results)
  bindedls_bbmg <- do.call(rbind.data.frame, agg_bbmg_results$results)
  
  bindedls_iid$GROUPINGSTYLE <- "IID"
  bindedls_bbg$GROUPINGSTYLE <- "BBG"
  bindedls_bbmg$GROUPINGSTYLE <- "BBMG"
  
  master_bs <- rbind(bindedls_iid, bindedls_bbg, bindedls_bbmg)
  master_bs
}

lm_master_bs <- ppfordensityplot(lm_agg_iid_results, lm_agg_bbg_results, lm_agg_bbmg_results)
glm_master_bs <- ppfordensityplot(glm_agg_iid_results, glm_agg_bbg_results, glm_agg_bbmg_results)
rf_master_bs <- ppfordensityplot(rf_agg_iid_results, rf_agg_bbg_results, rf_agg_bbmg_results)
nn_master_bs <- ppfordensityplot(nn_agg_iid_results, nn_agg_bbg_results, nn_agg_bbmg_results)

lm_master_bs$MODELTYPE <- "LM"
glm_master_bs$MODELTYPE <- "GLM"
rf_master_bs$MODELTYPE <- "RF"
nn_master_bs$MODELTYPE <- "NN"

master_bs <- rbind(lm_master_bs, glm_master_bs, rf_master_bs, nn_master_bs)
master_bs$MODELTYPE <- factor(master_bs$MODELTYPE, levels=c("LM", "GLM", "RF", "NN"))
master_bs$GROUPINGSTYLE <- factor(master_bs$GROUPINGSTYLE, levels=c("IID", "BBG", "BBMG"))

# doing this becasue plot legend is acting up
master_bs_1 <- master_bs[, c("pred", "GROUPINGSTYLE", "MODELTYPE")]
master_bs_2 <- master_bs[, c("obs", "GROUPINGSTYLE", "MODELTYPE")]

MODELTYPE.labs <- c("Linear Model (LM)", "Generalized Linear Model (GLM)", "Random Forest (RF)", "Neural Network (NN)")
names(MODELTYPE.labs) <- c("LM", "GLM", "RF", "NN")

plottoprint <- ggplot() +
  geom_density(data=master_bs_1, aes(x=pred, group=GROUPINGSTYLE, colour=GROUPINGSTYLE, linetype=GROUPINGSTYLE), position=position_dodge(width=0.2)) +
  scale_color_manual(values=c(cbpblack[2], cbpblack[3], cbpblack[5]), breaks = c("IID", "BBG", "BBMG"), labels=c("IID", "BBG", "BBMG"), name="Pred")+
  scale_linetype_manual(values=c("dashed", "dotted", "solid"), breaks=c("IID", "BBG", "BBMG"), labels=c("IID", "BBG", "BBMG"), name="Pred")+
  geom_density(data=master_bs_2, aes(x=obs, group=GROUPINGSTYLE, colour=GROUPINGSTYLE, fill=GROUPINGSTYLE), alpha=0.2) +
  scale_fill_manual(values=c(cbpblack[3], cbpblack[5], cbpblack[2]), breaks = c("IID", "BBG", "BBMG"), labels=c("IID", "BBG", "BBMG"), name="Obs")+
  guides(color=guide_legend(order=0), linetype=guide_legend(order=1), fill=guide_legend(order=2, override.aes=list(alpha=0.2)))+ 
  facet_wrap(~MODELTYPE, labeller=labeller(MODELTYPE=MODELTYPE.labs)) +
  scale_x_continuous(trans="log10")+
  labs(x ="Unimpaired Flow (AF/m)", y = "Density or Frequency of Occurance (%)", color = "")+
  annotation_logticks(sides="b")+
  theme(legend.text=element_text(size=10), text=element_text(size=10))+
  theme_bw(base_size = 8)

png('ch4 resampling/outputdata/rplot412_density_bs_all.png', width=3.25*2, height=2.85*2, units="in", pointsize=8, res=1200)
  print(plottoprint)
dev.off()
```

## 6.4 Map Plots
```{r error_mapplots}
# modeltype can be: "lm", "glm", "rf", "nn"
library(RColorBrewer)
library(lattice)
library(grid)

br2map <- function(gof_results, modelform, groupingstyle, datatype){ 
  basinsc <- basins_points
  results <- data.frame(t(gof_results))
  results$CDEC_ID <- rownames(results)
  basinsc <- merge(basinsc, results, by="CDEC_ID", all=TRUE)
  counties <- list(first=TRUE, "sp.polygons", cacounties, fill="gray88", col="white")

  png(paste0('ch4 resampling/outputdata/rplot415_br2map_', modelform, "_", groupingstyle, "_", datatype , '.png'), width=3.25, height=3, units="in", pointsize=8, res=1200)
  par(mar=c(0,0,0,0)+0.1, cex=1)
  mycolors <- colorRampPalette(c(cbpblack[2],cbpblack[4],cbpblack[6]))
  tbdspplot <- spplot(basinsc["bR2"], cex=0.8, sp.layout=counties, col.regions = mycolors(100), colorkey = list(right = list( # see ?levelplot in package trellis, argument colorkey:
                      fun = draw.colorkey, 
                      args = list(
                             key = list(
                                  at = seq(0, 1.0, 1/100), # colour breaks
                                  col = mycolors(100), # colours
                                  labels = list(
                                      at = seq(0, 1.0, 0.2),
                                      labels = seq(0, 1.0, 0.2)
                                      )
                                   )
                              )
                      )
          )
  )
  print(tbdspplot)
  grid.text("bR2(-)", 0.65, 0.88)
  dev.off()
}

# for CV
br2map(gof_lm_resub_agg_by_basins, "lm", "resub", "agg")
br2map(gof_lm_2fold_agg_by_basins, "lm", "2fold", "agg")
br2map(gof_lm_5fold_agg_by_basins, "lm", "5fold", "agg")
br2map(gof_lm_10fold_agg_by_basins, "lm", "10fold", "agg")
br2map(gof_lm_logo_agg_by_basins, "lm", "logo", "agg")
br2map(gof_lm_lmgo_agg_by_basins, "lm", "lmgo", "agg")

br2map(gof_glm_resub_agg_by_basins, "glm", "resub", "agg")
br2map(gof_glm_2fold_agg_by_basins, "glm", "2fold", "agg")
br2map(gof_glm_5fold_agg_by_basins, "glm", "5fold", "agg")
br2map(gof_glm_10fold_agg_by_basins, "glm", "10fold", "agg")
br2map(gof_glm_logo_agg_by_basins, "glm", "logo", "agg")
br2map(gof_glm_lmgo_agg_by_basins, "glm", "lmgo", "agg")

br2map(gof_rf_resub_agg_by_basins, "rf", "resub", "agg")
br2map(gof_rf_2fold_agg_by_basins, "rf", "2fold", "agg")
br2map(gof_rf_5fold_agg_by_basins, "rf", "5fold", "agg")
br2map(gof_rf_10fold_agg_by_basins, "rf", "10fold", "agg")
br2map(gof_rf_logo_agg_by_basins, "rf", "logo", "agg")
br2map(gof_rf_lmgo_agg_by_basins, "rf", "lmgo", "agg")

br2map(gof_nn_resub_agg_by_basins, "nn", "resub", "agg")
br2map(gof_nn_2fold_agg_by_basins, "nn", "2fold", "agg")
br2map(gof_nn_5fold_agg_by_basins, "nn", "5fold", "agg")
br2map(gof_nn_10fold_agg_by_basins, "nn", "10fold", "agg")
br2map(gof_nn_logo_agg_by_basins, "nn", "logo", "agg")
br2map(gof_nn_lmgo_agg_by_basins, "nn", "lmgo", "agg")

# for BS 
br2map(gof_lm_iid_agg_by_basins, "lm", "iid", "agg")
br2map(gof_lm_bbg_agg_by_basins, "lm", "bbg", "agg")
br2map(gof_lm_bbmg_agg_by_basins, "lm", "bbmg", "agg")

br2map(gof_glm_iid_agg_by_basins, "glm", "iid", "agg")
br2map(gof_glm_bbg_agg_by_basins, "glm", "bbg", "agg")
br2map(gof_glm_bbmg_agg_by_basins, "glm", "bbmg", "agg")

br2map(gof_rf_iid_agg_by_basins, "rf", "iid", "agg")
br2map(gof_rf_bbg_agg_by_basins, "rf", "bbg", "agg")
br2map(gof_rf_bbmg_agg_by_basins, "rf", "bbmg", "agg")

br2map(gof_nn_iid_agg_by_basins, "nn", "iid", "agg")
br2map(gof_nn_bbg_agg_by_basins, "nn", "bbg", "agg")
br2map(gof_nn_bbmg_agg_by_basins, "nn", "bbmg", "agg")
```

## 6.5 Dotcharts
```{r error_hierarchy_plots_cv}
# groupingstyle comparisons by basin
library(reshape2)
gofdotchart <- function(gof_results_resub, gof_results_2fold, gof_results_5fold, gof_results_10fold, gof_results_logo, gof_results_lmgo, modeltype, fitofinterest){
  basins_points$HIERARCHY <- (basins_points$STATIONS_ABOVE1!="none") + (basins_points$STATIONS_ABOVE2!="none") + (basins_points$STATIONS_ABOVE3!="none") + (basins_points$STATIONS_ABOVE4!="none") + 1
  basins_points$HIERARCHY <- as.factor(basins_points$HIERARCHY)
  basins_points <- basins_points[,-c(2:(ncol(basins_points)-1))]
    
  tgof_results_resub <- data.frame(t(gof_results_resub))
  tgof_results_resub$CDEC_ID <- rownames(tgof_results_resub)
  basinsc <- basins_points@data
  basinsc <- merge(basinsc, tgof_results_resub, by="CDEC_ID", all=TRUE)
  basinsc$GROUPINGSTYLE <- "RESUB"
  
  tgof_results_2fold <- data.frame(t(gof_results_2fold))
  tgof_results_2fold$CDEC_ID <- rownames(tgof_results_2fold)
  basinsc2 <- basins_points@data
  basinsc2 <- merge(basinsc2, tgof_results_2fold, by="CDEC_ID", all=TRUE)
  basinsc2$GROUPINGSTYLE <- "2FOLD"
  
  tgof_results_5fold <- data.frame(t(gof_results_5fold))
  tgof_results_5fold$CDEC_ID <- rownames(tgof_results_5fold)
  basinsc3 <- basins_points@data
  basinsc3 <- merge(basinsc3, tgof_results_5fold, by="CDEC_ID", all=TRUE)
  basinsc3$GROUPINGSTYLE <- "5FOLD"
  
  tgof_results_10fold <- data.frame(t(gof_results_10fold))
  tgof_results_10fold$CDEC_ID <- rownames(tgof_results_10fold)
  basinsc4 <- basins_points@data
  basinsc4 <- merge(basinsc4, tgof_results_10fold, by="CDEC_ID", all=TRUE)
  basinsc4$GROUPINGSTYLE <- "10FOLD"
  
  tgof_results_logo <- data.frame(t(gof_results_logo))
  tgof_results_logo$CDEC_ID <- rownames(tgof_results_logo)
  basinsc5 <- basins_points@data
  basinsc5 <- merge(basinsc5, tgof_results_logo, by="CDEC_ID", all=TRUE)
  basinsc5$GROUPINGSTYLE <- "LOGO"
  
  tgof_results_lmgo <- data.frame(t(gof_results_lmgo))
  tgof_results_lmgo$CDEC_ID <- rownames(tgof_results_lmgo)
  basinsc6 <- basins_points@data
  basinsc6 <- merge(basinsc6, tgof_results_lmgo, by="CDEC_ID", all=TRUE)
  basinsc6$GROUPINGSTYLE <- "LMGO"

  if(fitofinterest=="ME"){
    fitofinterestlabel <- "Mean Error (AF)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="ME",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="ME",], na.rm=TRUE))
  } else if(fitofinterest=="MAE"){
    fitofinterestlabel <- "Mean Absolute Error (AF)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="MAE",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="MAE",], na.rm=TRUE))
  } else if(fitofinterest=="MSE"){
    fitofinterestlabel <- "Mean Squared Error (AF^2)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="MSE",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="MSE",], na.rm=TRUE))
  } else if(fitofinterest=="RMSE"){
    fitofinterestlabel <- "Root Mean Squared Error (AF)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="RMSE",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="RMSE",], na.rm=TRUE))
  } else if(fitofinterest=="NRMSE.."){
    fitofinterestlabel <- "Normalized Root Mean Squared Error (AF^2)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="NRMSE..",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="NRMSE..",], na.rm=TRUE))
  } else if(fitofinterest=="PBIAS.."){
    fitofinterestlabel <- "Percent Bias (-)"
    maxxlim <- max(1.4*max(basinscm[basinscm$GOF=="PBIAS..",], na.rm=TRUE), 1.4*max(basinscm[basinscm$GOF=="PBIAS..",], na.rm=TRUE))
  } else if(fitofinterest=="RSR"){
    fitofinterestlabel <- "RMSE to Standard Deviation of Observations Ratio (-)"
    maxxlim <- 67
  } else if(fitofinterest=="NSE"){
    fitofinterestlabel <- "Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 10
    # minxlim <- 7*minxlim
  } else if(fitofinterest=="rSD"){
    fitofinterestlabel <- "Ratio of Standard Deviations (-)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="rSD",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="rSD",], na.rm=TRUE))
  } else if(fitofinterest=="mNSE"){
    fitofinterestlabel <- "Modified Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5
  } else if(fitofinterest=="rNSE"){
    fitofinterestlabel <- "Relative Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5e5
  } else if(fitofinterest=="d"){
    fitofinterestlabel <- "Index of Agreement (-)"
    maxxlim <- max(1.05*max(basinscm[basinscm$GOF=="d",], na.rm=TRUE), 1.05*max(basinscm[basinscm$GOF=="d",], na.rm=TRUE))
  } else if(fitofinterest=="md"){
    fitofinterestlabel <- "Modified Index of Agreement (-)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="md",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="md",], na.rm=TRUE))
  } else if(fitofinterest=="rd"){
    fitofinterestlabel <- "Relative Index of Agreement (-)"
    maxxlim <- 100
  } else if(fitofinterest=="cp"){
    fitofinterestlabel <- "Persistence Index (-)"
    maxxlim <- 200
  } else if(fitofinterest=="r"){
    fitofinterestlabel <- "Pearson Correlation coefficient (-)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="r",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="r",], na.rm=TRUE))
  } else if(fitofinterest=="R2"){
    fitofinterestlabel <- "Coefficient of Determination (-)"
    maxxlim <- 1.0
  } else if(fitofinterest=="bR2"){
    fitofinterestlabel <- "Bias-Corrected Coefficient of Determination (-)"
    maxxlim <- 1.0
    minxlim <- -0.05
  } else if(fitofinterest=="KGE"){
    fitofinterestlabel <- "Kling-Gupta Efficiency (-)"
    maxxlim <- 10
  } else if(fitofinterest=="VE"){
    fitofinterestlabel <- "Volumetric Efficiency (AF)"
    maxxlim <- 6
  } else{
    print("Input a measure of fit provided by the gof function in HydroGOF package!")
  }
  
  basinscr <- melt(basinsc, id.vars=c("CDEC_ID", "HIERARCHY", "GROUPINGSTYLE"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  basinsc2r <- melt(basinsc2, id.vars=c("CDEC_ID", "GROUPINGSTYLE", "HIERARCHY"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  basinsc3r <- melt(basinsc3, id.vars=c("CDEC_ID", "GROUPINGSTYLE", "HIERARCHY"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  basinsc4r <- melt(basinsc4, id.vars=c("CDEC_ID", "GROUPINGSTYLE", "HIERARCHY"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  basinsc5r <- melt(basinsc5, id.vars=c("CDEC_ID", "GROUPINGSTYLE", "HIERARCHY"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  basinsc6r <- melt(basinsc6, id.vars=c("CDEC_ID", "GROUPINGSTYLE", "HIERARCHY"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  
  # order the basins based on LOGO values, decreasing
  orderrownums <- as.numeric(row.names(basinsc5r[order(basinsc5r$VALUE, decreasing=TRUE), ]))
  basinscr <- basinscr[orderrownums, ]
  basinsc2r <- basinsc2r[orderrownums, ]
  basinsc3r <- basinsc3r[orderrownums, ]
  basinsc4r <- basinsc4r[orderrownums, ]
  basinsc5r <- basinsc5r[orderrownums, ]
  basinsc6r <- basinsc6r[orderrownums, ]
  
  # bind aacross the different grouping styles
  basinscm <- rbind(basinscr, basinsc2r, basinsc3r, basinsc4r, basinsc5r, basinsc6r)
  basinscm$GROUPINGSTYLE <- factor(basinscm$GROUPINGSTYLE, levels = c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"))
  basinscm$CDEC_ID <- factor(basinscm$CDEC_ID, levels=basinscm$CDEC_ID[1:67])
  
  png(paste0('ch4 resampling/outputdata/rplot416_', modeltype, "_", fitofinterest, 'dotchart_comp.png'), width=6.5, height=8, units="in", pointsize=8, res=1200)
    plottoprint <- ggplot(data=basinscm, aes(x=VALUE, y=CDEC_ID)) +
      geom_point(aes(shape=GROUPINGSTYLE, color=GROUPINGSTYLE), size=4)+
      facet_grid(HIERARCHY ~ ., scales = "free", space = "free") +
      scale_shape_manual(breaks = c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO"), values=c(4, 2, 5, 8, 16, 15)) + 
      scale_colour_manual(aesthetics = c("colour"), values=c(cbpblack[2], cbpblack[3], cbpblack[4], cbpblack[5], cbpblack[8], cbpblack[6]), breaks = c("RESUB", "10FOLD", "5FOLD", "2FOLD", "LOGO", "LMGO")) +
      labs(x=fitofinterestlabel, y="")+
      theme_bw()+
      theme(legend.position="bottom", legend.title = element_blank())+
      guides(color = guide_legend(nrow = 1), shape= guide_legend(nrow = 1))
    print(plottoprint)
  dev.off()
}

gofdotchart(gof_lm_resub_agg_by_basins, gof_lm_2fold_agg_by_basins, gof_lm_5fold_agg_by_basins, gof_lm_10fold_agg_by_basins, gof_lm_logo_agg_by_basins, gof_lm_lmgo_agg_by_basins, "lm", "bR2")
gofdotchart(gof_glm_resub_agg_by_basins, gof_glm_2fold_agg_by_basins, gof_glm_5fold_agg_by_basins, gof_glm_10fold_agg_by_basins, gof_glm_logo_agg_by_basins, gof_glm_lmgo_agg_by_basins, "glm", "bR2")
gofdotchart(gof_rf_resub_agg_by_basins, gof_rf_2fold_agg_by_basins, gof_rf_5fold_agg_by_basins, gof_rf_10fold_agg_by_basins, gof_rf_logo_agg_by_basins, gof_rf_lmgo_agg_by_basins, "rf", "bR2")
gofdotchart(gof_nn_resub_agg_by_basins, gof_nn_2fold_agg_by_basins, gof_nn_5fold_agg_by_basins, gof_nn_10fold_agg_by_basins, gof_nn_logo_agg_by_basins, gof_nn_lmgo_agg_by_basins, "nn", "bR2")
```

```{r error_hierarchy_plots_bs}
# use mean BS values  
gofdotchart_bs <- function(gof_results_iid, gof_results_bbg, gof_results_bbmg, modeltype, fitofinterest){
  basins_points$HIERARCHY <- (basins_points$STATIONS_ABOVE1!="none") + (basins_points$STATIONS_ABOVE2!="none") + (basins_points$STATIONS_ABOVE3!="none") + (basins_points$STATIONS_ABOVE4!="none") + 1
  basins_points$HIERARCHY <- as.factor(basins_points$HIERARCHY)
  basins_points <- basins_points[,-c(2:(ncol(basins_points)-1))]
    
  tgof_results_iid <- data.frame(t(gof_results_iid))
  tgof_results_iid$CDEC_ID <- rownames(tgof_results_iid)
  basinsc <- basins_points@data
  basinsc <- merge(basinsc, tgof_results_iid, by="CDEC_ID", all=TRUE)
  basinsc$GROUPINGSTYLE <- "IID"
  
  tgof_results_bbg <- data.frame(t(gof_results_bbg))
  tgof_results_bbg$CDEC_ID <- rownames(tgof_results_bbg)
  basinsc2 <- basins_points@data
  basinsc2 <- merge(basinsc2, tgof_results_bbg, by="CDEC_ID", all=TRUE)
  basinsc2$GROUPINGSTYLE <- "BBG"
  
  tgof_results_bbmg <- data.frame(t(gof_results_bbmg))
  tgof_results_bbmg$CDEC_ID <- rownames(tgof_results_bbmg)
  basinsc3 <- basins_points@data
  basinsc3 <- merge(basinsc3, tgof_results_bbmg, by="CDEC_ID", all=TRUE)
  basinsc3$GROUPINGSTYLE <- "BBMG"

  if(fitofinterest=="ME"){
    fitofinterestlabel <- "Mean Error (AF)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="ME",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="ME",], na.rm=TRUE))
  } else if(fitofinterest=="MAE"){
    fitofinterestlabel <- "Mean Absolute Error (AF)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="MAE",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="MAE",], na.rm=TRUE))
  } else if(fitofinterest=="MSE"){
    fitofinterestlabel <- "Mean Squared Error (AF^2)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="MSE",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="MSE",], na.rm=TRUE))
  } else if(fitofinterest=="RMSE"){
    fitofinterestlabel <- "Root Mean Squared Error (AF)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="RMSE",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="RMSE",], na.rm=TRUE))
  } else if(fitofinterest=="NRMSE.."){
    fitofinterestlabel <- "Normalized Root Mean Squared Error (AF^2)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="NRMSE..",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="NRMSE..",], na.rm=TRUE))
  } else if(fitofinterest=="PBIAS.."){
    fitofinterestlabel <- "Percent Bias (-)"
    maxxlim <- max(1.4*max(basinscm[basinscm$GOF=="PBIAS..",], na.rm=TRUE), 1.4*max(basinscm[basinscm$GOF=="PBIAS..",], na.rm=TRUE))
  } else if(fitofinterest=="RSR"){
    fitofinterestlabel <- "RMSE to Standard Deviation of Observations Ratio (-)"
    maxxlim <- 67
  } else if(fitofinterest=="NSE"){
    fitofinterestlabel <- "Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 10
    # minxlim <- 7*minxlim
  } else if(fitofinterest=="rSD"){
    fitofinterestlabel <- "Ratio of Standard Deviations (-)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="rSD",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="rSD",], na.rm=TRUE))
  } else if(fitofinterest=="mNSE"){
    fitofinterestlabel <- "Modified Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5
  } else if(fitofinterest=="rNSE"){
    fitofinterestlabel <- "Relative Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5e5
  } else if(fitofinterest=="d"){
    fitofinterestlabel <- "Index of Agreement (-)"
    maxxlim <- max(1.05*max(basinscm[basinscm$GOF=="d",], na.rm=TRUE), 1.05*max(basinscm[basinscm$GOF=="d",], na.rm=TRUE))
  } else if(fitofinterest=="md"){
    fitofinterestlabel <- "Modified Index of Agreement (-)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="md",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="md",], na.rm=TRUE))
  } else if(fitofinterest=="rd"){
    fitofinterestlabel <- "Relative Index of Agreement (-)"
    maxxlim <- 100
  } else if(fitofinterest=="cp"){
    fitofinterestlabel <- "Persistence Index (-)"
    maxxlim <- 200
  } else if(fitofinterest=="r"){
    fitofinterestlabel <- "Pearson Correlation coefficient (-)"
    maxxlim <- max(1.1*max(basinscm[basinscm$GOF=="r",], na.rm=TRUE), 1.1*max(basinscm[basinscm$GOF=="r",], na.rm=TRUE))
  } else if(fitofinterest=="R2"){
    fitofinterestlabel <- "Coefficient of Determination (-)"
    maxxlim <- 1.0
  } else if(fitofinterest=="bR2"){
    fitofinterestlabel <- "Bias-Corrected Coefficient of Determination (-)"
    maxxlim <- 1.0
    minxlim <- -0.05
  } else if(fitofinterest=="KGE"){
    fitofinterestlabel <- "Kling-Gupta Efficiency (-)"
    maxxlim <- 10
  } else if(fitofinterest=="VE"){
    fitofinterestlabel <- "Volumetric Efficiency (AF)"
    maxxlim <- 6
  } else{
    print("Input a measure of fit provided by the gof function in HydroGOF package!")
  }
  
  basinscr <- melt(basinsc, id.vars=c("CDEC_ID", "HIERARCHY", "GROUPINGSTYLE"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  basinsc2r <- melt(basinsc2, id.vars=c("CDEC_ID", "GROUPINGSTYLE", "HIERARCHY"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  basinsc3r <- melt(basinsc3, id.vars=c("CDEC_ID", "GROUPINGSTYLE", "HIERARCHY"), variable.name = "GOF", value.name="VALUE", measure.vars = fitofinterest)
  
  # order the basins based on BBG values, decreasing
  orderrownums <- as.numeric(row.names(basinsc2r[order(basinsc2r$VALUE, decreasing=TRUE), ]))
  basinscr <- basinscr[orderrownums, ]
  basinsc2r <- basinsc2r[orderrownums, ]
  basinsc3r <- basinsc3r[orderrownums, ]
  
  # bind aacross the different grouping styles
  basinscm <- rbind(basinscr, basinsc2r, basinsc3r)
  basinscm$GROUPINGSTYLE <- factor(basinscm$GROUPINGSTYLE, levels = c("IID", "BBG", "BBMG"))
  basinscm$CDEC_ID <- factor(basinscm$CDEC_ID, levels=basinscm$CDEC_ID[1:67])
  
  png(paste0('ch4 resampling/outputdata/rplot417_', modeltype, "_", fitofinterest, 'dotchart_comp.png'), width=6.5, height=8, units="in", pointsize=8, res=1200)
    plottoprint <- ggplot(data=basinscm, aes(x=VALUE, y=CDEC_ID)) +
      geom_point(aes(shape=GROUPINGSTYLE, color=GROUPINGSTYLE), size=4)+
      facet_grid(HIERARCHY ~ ., scales = "free", space = "free") +
      scale_colour_manual(values=c(cbpblack[2], cbpblack[3], cbpblack[5]))+
      scale_shape_manual(values=c(4, 16, 2))+
      labs(x=fitofinterestlabel, y="")+
      theme_bw()+
      theme(legend.position="bottom", legend.title = element_blank())+
      guides(color = guide_legend(nrow = 1))
    print(plottoprint)
  dev.off()
}

gofdotchart_bs(gof_lm_iid_agg_by_basins, gof_lm_bbg_agg_by_basins, gof_lm_bbmg_agg_by_basins, "lm", "bR2")
gofdotchart_bs(gof_glm_iid_agg_by_basins, gof_glm_bbg_agg_by_basins, gof_glm_bbmg_agg_by_basins, "glm", "bR2")
gofdotchart_bs(gof_rf_iid_agg_by_basins, gof_rf_bbg_agg_by_basins, gof_rf_bbmg_agg_by_basins, "rf", "bR2")
gofdotchart_bs(gof_nn_iid_agg_by_basins, gof_nn_bbg_agg_by_basins, gof_nn_bbmg_agg_by_basins, "nn", "bR2")
```

## 6.6 Boxplots
consider adding a boxplot band on each of the mean points in the dotchart for the BS runs

## 6.7 GIFs
```{r gif_plots} 
# make the plot with title and appropriate name
br2map_gif <- function(gof_results, modelform, groupingstyle_title, datatype, cvorbs, orderingif){ 
  basinsc <- basins_points
  results <- data.frame(t(gof_results))
  results$CDEC_ID <- rownames(results)
  basinsc <- merge(basinsc, results, by="CDEC_ID", all=TRUE)
  counties <- list(first=TRUE, "sp.polygons", cacounties, fill="gray88", col="white")

  png(paste0('ch4 resampling/outputdata/gif/', modelform, '/', cvorbs, '/', 'br2map-', orderingif, '.png'), width=3.25, height=3, units="in", pointsize=8, res=1200)
  par(mar=c(0,0,2,0)+0.1, cex=1)
  mycolors <- colorRampPalette(c(cbpblack[2],cbpblack[4],cbpblack[6]))
  tbdspplot <- spplot(basinsc["bR2"], cex=0.8, sp.layout=counties, col.regions = mycolors(100), colorkey = list(right = list( # see ?levelplot in package trellis, argument colorkey:
                      fun = draw.colorkey, 
                      args = list(
                             key = list(
                                  at = seq(0, 1.0, 1/100), # colour breaks
                                  col = mycolors(100), # colours
                                  labels = list(
                                      at = seq(0, 1.0, 0.2),
                                      labels = seq(0, 1.0, 0.2)
                                      )
                                   )
                              )
                      )
          )
  )
  print(tbdspplot)
  grid.text("bR2(-)", 0.78, 0.95)
  grid.text(groupingstyle_title, 0.43, 0.95)
  dev.off()
}

# for CV
br2map_gif(gof_lm_resub_agg_by_basins, "lm", "Resubstitution", "agg", "cv", "1")
br2map_gif(gof_lm_2fold_agg_by_basins, "lm", "Random 2 Fold", "agg", "cv", "4")
br2map_gif(gof_lm_5fold_agg_by_basins, "lm", "Random 5 Fold", "agg", "cv", "3")
br2map_gif(gof_lm_10fold_agg_by_basins, "lm", "Random 10 Fold", "agg", "cv", "2")
br2map_gif(gof_lm_logo_agg_by_basins, "lm", "Leave One Group Out (LOGO)", "agg", "cv", "5")
br2map_gif(gof_lm_lmgo_agg_by_basins, "lm", "Leave Multiple Groups Out (LMGO)", "agg", "cv", "6")

br2map_gif(gof_glm_resub_agg_by_basins, "glm", "Resubstitution", "agg", "cv", "1")
br2map_gif(gof_glm_2fold_agg_by_basins, "glm", "Random 2 Fold", "agg", "cv", "4")
br2map_gif(gof_glm_5fold_agg_by_basins, "glm", "Random 5 Fold", "agg", "cv", "3")
br2map_gif(gof_glm_10fold_agg_by_basins, "glm", "Random 10 Fold", "agg", "cv", "2")
br2map_gif(gof_glm_logo_agg_by_basins, "glm", "Leave One Group Out (LOGO)", "agg", "cv", "5")
br2map_gif(gof_glm_lmgo_agg_by_basins, "glm", "Leave Multiple Groups Out (LMGO)", "agg", "cv", "6")

br2map_gif(gof_rf_resub_agg_by_basins, "rf", "Resubstitution", "agg", "cv", "1")
br2map_gif(gof_rf_2fold_agg_by_basins, "rf", "Random 2 Fold", "agg", "cv", "4")
br2map_gif(gof_rf_5fold_agg_by_basins, "rf", "Random 5 Fold", "agg", "cv", "3")
br2map_gif(gof_rf_10fold_agg_by_basins, "rf", "Random 10 Fold", "agg", "cv", "2")
br2map_gif(gof_rf_logo_agg_by_basins, "rf", "Leave One Group Out (LOGO)", "agg", "cv", "5")
br2map_gif(gof_rf_lmgo_agg_by_basins, "rf", "Leave Multiple Groups Out (LMGO)", "agg", "cv", "6")

br2map_gif(gof_nn_resub_agg_by_basins, "nn", "Resubstitution", "agg", "cv", "1")
br2map_gif(gof_nn_2fold_agg_by_basins, "nn", "Random 2 Fold", "agg", "cv", "4")
br2map_gif(gof_nn_5fold_agg_by_basins, "nn", "Random 5 Fold", "agg", "cv", "3")
br2map_gif(gof_nn_10fold_agg_by_basins, "nn", "Random 10 Fold", "agg", "cv", "2")
br2map_gif(gof_nn_logo_agg_by_basins, "nn", "Leave One Group Out (LOGO)", "agg", "cv", "5")
br2map_gif(gof_nn_lmgo_agg_by_basins, "nn", "Leave Multiple Groups Out (LMGO)", "agg", "cv", "6")

# for BS 
br2map_gif(gof_lm_iid_agg_by_basins, "lm", "Random or IID", "agg", "bs", "1")
br2map_gif(gof_lm_bbg_agg_by_basins, "lm", "Blocked By Group (BBG)", "agg", "bs", "2")
br2map_gif(gof_lm_bbmg_agg_by_basins, "lm", "Blocked By Multiple Groups (BBMG)", "agg", "bs", "3")

br2map_gif(gof_glm_iid_agg_by_basins, "glm", "Random or IID", "agg", "bs", "1")
br2map_gif(gof_glm_bbg_agg_by_basins, "glm", "Blocked By Group (BBG)", "agg", "bs", "2")
br2map_gif(gof_glm_bbmg_agg_by_basins, "glm", "Blocked By Multiple Groups (BBMG)", "agg", "bs", "3")

br2map_gif(gof_rf_iid_agg_by_basins, "rf", "Random or IID", "agg", "bs", "1")
br2map_gif(gof_rf_bbg_agg_by_basins, "rf", "Blocked By Group (BBG)", "agg", "bs", "2")
br2map_gif(gof_rf_bbmg_agg_by_basins, "rf", "Blocked By Multiple Groups (BBMG)", "agg", "bs", "3")

br2map_gif(gof_nn_iid_agg_by_basins, "nn", "Random or IID", "agg", "bs", "1")
br2map_gif(gof_nn_bbg_agg_by_basins, "nn", "Blocked By Group (BBG)", "agg", "bs", "2")
br2map_gif(gof_nn_bbmg_agg_by_basins, "nn", "Blocked By Multiple Groups (BBMG)", "agg", "bs", "3")
```

```{r gifs}
library(magick)
library(purrr)

mapgif <- function(modeltype, grouping){
  list.files(path = paste0("ch4 resampling/outputdata/gif/", modeltype, "/", grouping), pattern = "*.png", full.names = T) %>% 
  map(image_read) %>% # reads each path file
  image_join() %>% # joins image
  image_animate(fps=1) %>% # animates, can opt for number of loops
  image_write(paste0("ch4 resampling/outputdata/rplot418_br2_mapgif_", modeltype, "_", grouping, ".gif")) # write to current dir
}

mapgif("lm", "cv")
mapgif("glm", "cv")
mapgif("rf", "cv")
mapgif("nn", "cv")

mapgif("lm", "bs")
mapgif("glm", "bs")
mapgif("rf", "bs")
mapgif("nn", "bs")
```

