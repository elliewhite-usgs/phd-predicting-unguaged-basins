---
title: "resampling"
author: "Ellie White"
date: "March 23, 2019"
output: html_document
---

Record of how a model's predictive capability is assessed given different resampling techniques on hydrologic data. And hopefully, coming up with a way that gets close to finding the accurate predictive capability. 

# Contents   
1.0 Data Gathering  
2.0 Modelling 
3.0 Resampling
  3.1 Resubstitution
  3.2 Random k-fold
  3.3 Leave one group out
  3.4 Random k-fold leave multiple groups out
  3.5 Hierarchical leave multiple groups out

```{r, include=FALSE}
library(knitr)
library(formatR)
opts_chunk$set(fig.width = 7.5, fig.height = 7.5, collapse = TRUE, tidy = FALSE)
```

# Citations
```{r citations}
# cite R 
toBibtex(citation())

# cite R studio
RStudio.Version()

# cite packages
citethese <- c("raster", "sp", "rgdal", "rgeos", "dismo", "geojsonio", "hydroGOF", "RColorBrewer", "fBasics", "lmtest", "prism", "reshape2", "statmod")
for(c in seq_along(citethese)){
  print(toBibtex(citation(citethese[c])))
}
remove(c)

# session info in case anything goes wrong
sessionInfo()
```

# Set Seed
```{r setseed}
set.seed(3232019)
```

# 1.0 Data Gathering
```{r data_gathering} 
df <- readRDS('inputdata/moddf.rds')

# remove DOMGEOLOGY cause it's causing problems
df <- df[ , !(colnames(df) %in% c("DOMGEOLOGY"))]

# order by baisn name
df <- df[order(df$CDEC_ID), ]
row.names(df) <- 1:nrow(df)

# get rid of negative flows
# 1st of all WHY THE FUCK ARE THERE NEGATIVE FLOWS IN THE DATA? inverstigate this later.
# 2nd make sure the dates that have negative flows in the original dataset is removed from the cumulative dataset too. Afterall, these cumulative values are calculated from the original dataset and negative flow don't make sense there, so their cumulative doesn't make sense in this dataset either. 
moddf <- df[df$FLOW>=0, ]

# check if all the negatives are gone from moddf and moddfc
tbd <- moddf[moddf$FLOW<0, "FLOW"]
tbd <- na.omit(tbd)
length(tbd) == 0

remove(tbd)
```

```{r data_gathering_extra}
# some helpful dataframes, may come in handy later for post processing
basins_points <- read.csv("inputdata/cdec_fnf_stations_data_minus_sfj_otr_bhn_ftm_sfr_sjm_klo.csv", stringsAsFactors = FALSE)
coordinates(basins_points) <- ~LONGITUDE+LATITUDE
proj4string(basins_points) <- CRS("+proj=longlat +datum=WGS84")

basins <- readRDS("inputdata/basins.rds")
cacounties <- readRDS("inputdata/counties.rds")

ta <- CRS("+proj=aea +lat_1=34 +lat_2=40.5 +lat_0=0 +lon_0=-120 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=km +ellps=GRS80")
basins_points <- spTransform(basins_points, ta)
basins <- spTransform(basins, ta)
cacounties <- spTransform(cacounties, ta)
  
# wide format data
cdec_fnf_wide <- read.csv('inputdata/cdec_fnf_wide.csv')
cdec_fnf_wide$DATE <- as.Date(cdec_fnf_wide$DATE, format="%Y-%m-%d")
cdec_fnf_wide <- cdec_fnf_wide[order(cdec_fnf_wide$DATE),]

# The full records span 1900-01-01 to 1980-09-01, but most records start at 1982
cdec_fnf_wide <- cdec_fnf_wide[cdec_fnf_wide$DATE>="1982-01-01", ]
```

```{r visuals}
# colourblind palettes
# ordered:     black      pink        orange     yellow     green       blue      darkorange  lightblue
cbpgrey <-  c("#999999", "#CC79A7",  "#E69F00", "#F0E442", "#009E73", "#0072B2", "#D55E00", "#56B4E9")
cbpblack <- c("#000000", "#CC79A7",  "#E69F00", "#F0E442", "#009E73", "#0072B2", "#D55E00", "#56B4E9")
```

# 2.0 Data Tranformations
```{r data_transformation_lm}
# for LM
# split into two one original aggregate basins and one the incremental basins
df_lm_agg <- moddf[1:(which(moddf$CDEC_ID=="AMA_INC")[1]-1),]
df_lm_inc <- moddf[which(moddf$CDEC_ID=="AMA_INC")[1]:nrow(moddf),]

# get rid of na values 
df_lm_agg <- na.omit(df_lm_agg)
df_lm_inc <- na.omit(df_lm_inc)
```

# 3.0 Functions
```{r funcstoimport}
# library(hydroGOF) # this is giving wrong functions, do not load it in make sure the search path is clear
goffuncs <- list.files("libraries/HydroGOFm/R")
for(i in 1:length(goffuncs)){
  source(paste0("libraries/HydroGOFm/R/", goffuncs[i]))
}
remove(goffuncs)

search()
```

# 4.0 Modelling and Resampling
```{r lm_modelling_and_cv}
# group can be resub, 2L, 5L, 10L, logo, lmgo, lho. Notice how a plain 2, 5, and 10 will not work, you have to declare it an integer
# datatype can be "agg" or "inc"

library(dismo)
lmcv <- function(data, groupingstyle, datatype){
  # for resubstitution, where testing data and training data is the same
  if(groupingstyle=="resub"){
    linearmodel <- lm(FLOW~., data=data[,c(15,18:ncol(data))])
    predictions <- predict(linearmodel, data, type='response')
    results <- cbind(obs=data$FLOW, pred=predictions)
    modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
  }
  
  # for k-fold cross validation
  if(is.integer(groupingstyle)){
    group <- kfold(data, groupingstyle)
    linearmodel <- results <- modgof <- list()
    for (k in 1:groupingstyle) {
      trainset <- data[group != k, ]
      testset <- data[group == k, ]
      linearmodel[[k]] <- lm(FLOW~., data=trainset[,c(15,18:ncol(trainset))])
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # for leave one group (basin) out cross validation
  if(groupingstyle=="logo"){
    linearmodel <- results <- modgof <- list()
    for (k in 1:(length(unique(data$CDEC_ID)))){
      h <- unique(data$CDEC_ID)[k]
      testset <- data[data$CDEC_ID==h,]
      trainset <- data[data$CDEC_ID!=h,]
      linearmodel[[k]] <- lm(FLOW~., data=trainset[,c(15,18:ncol(trainset))])
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
    colnames(modgof) <- unique(data$CDEC_ID)
  }
  
  # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
  if(groupingstyle=="lmgo"){
    nfolds <- 5
    group <- as.data.frame(unique(data$CDEC_ID))
    colnames(group) <- "CDEC_ID"
    group$kftrain <- kfold(nrow(group), nfolds)
    data <- merge(data, group, by="CDEC_ID")
    
    linearmodel <- results <- modgof <- list()
    for (k in 1:nfolds) {
      testset <- data[data$kftrain == k, ]
      trainset <- data[data$kftrain != k, ]
      linearmodel[[k]] <- lm(FLOW~., data=trainset[,c(15,18:ncol(trainset))])
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # # for leave hierarchies out cross validation
  # if(groupingstyle=="lho"){
  # }
  
  if(groupingstyle=="resub"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else if(groupingstyle=="logo"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else{
    list(mod=linearmodel, results=results, gof=modgof, kf=group)
    }
}

# lm_agg_resub_results <- lmcv(df_lm_agg, "resub", "agg")
# lm_agg_2fold_results <- lmcv(df_lm_agg, 2L, "agg")
# lm_agg_5fold_results <- lmcv(df_lm_agg, 5L, "agg")
# lm_agg_10fold_results <- lmcv(df_lm_agg, 10L, "agg")
# lm_agg_logo_results <- lmcv(df_lm_agg, "logo", "agg")
# lm_agg_lmgo_results <- lmcv(df_lm_agg, "lmgo", "agg")
# 
# lm_inc_resub_results <- lmcv(df_lm_inc, "resub", "inc")
# lm_inc_2fold_results <- lmcv(df_lm_inc, 2L, "inc")
# lm_inc_5fold_results <- lmcv(df_lm_inc, 5L, "inc")
# lm_inc_10fold_results <- lmcv(df_lm_inc, 10L, "inc")
# lm_inc_logo_results <- lmcv(df_lm_inc, "logo", "inc")
# lm_inc_lmgo_results <- lmcv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(lm_agg_resub_results, file="ch4 resampling/outputdata/rds/lm_agg_resub_results.RDS")
# saveRDS(lm_agg_2fold_results, file="ch4 resampling/outputdata/rds/lm_agg_2fold_results.RDS")
# saveRDS(lm_agg_5fold_results, file="ch4 resampling/outputdata/rds/lm_agg_5fold_results.RDS")
# saveRDS(lm_agg_10fold_results, file="ch4 resampling/outputdata/rds/lm_agg_10fold_results.RDS")
# saveRDS(lm_agg_logo_results, file="ch4 resampling/outputdata/rds/lm_agg_logo_results.RDS")
# saveRDS(lm_agg_lmgo_results, file="ch4 resampling/outputdata/rds/lm_agg_lmgo_results.RDS")
# 
# saveRDS(lm_inc_resub_results, file="ch4 resampling/outputdata/rds/lm_inc_resub_results.RDS")
# saveRDS(lm_inc_2fold_results, file="ch4 resampling/outputdata/rds/lm_inc_2fold_results.RDS")
# saveRDS(lm_inc_5fold_results, file="ch4 resampling/outputdata/rds/lm_inc_5fold_results.RDS")
# saveRDS(lm_inc_10fold_results, file="ch4 resampling/outputdata/rds/lm_inc_10fold_results.RDS")
# saveRDS(lm_inc_logo_results, file="ch4 resampling/outputdata/rds/lm_inc_logo_results.RDS")
# saveRDS(lm_inc_lmgo_results, file="ch4 resampling/outputdata/rds/lm_inc_lmgo_results.RDS")

lm_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_resub_results.RDS")
lm_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_2fold_results.RDS")
lm_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_5fold_results.RDS")
lm_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_10fold_results.RDS")
lm_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_logo_results.RDS")
lm_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/lm_agg_lmgo_results.RDS")

lm_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_resub_results.RDS")
lm_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_2fold_results.RDS")
lm_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_5fold_results.RDS")
lm_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_10fold_results.RDS")
lm_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_logo_results.RDS")
lm_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/lm_inc_lmgo_results.RDS")
```

```{r glm_modelling_and_cv}
glmcv <- function(data, groupingstyle, datatype){
  # for resubstitution, where testing data and training data is the same
  if(groupingstyle=="resub"){
    linearmodel <- glm(FLOW~., data=data[,c(15,18:ncol(data))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
    predictions <- predict(linearmodel, data, type='response')
    results <- cbind(obs=data$FLOW, pred=predictions)
    modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
  }
  
  # for k-fold cross validation
  if(is.integer(groupingstyle)){
    group <- kfold(data, groupingstyle)
    linearmodel <- results <- modgof <- list()
    for (k in 1:groupingstyle) {
      trainset <- data[group != k, ]
      testset <- data[group == k, ]
      linearmodel[[k]] <- glm(FLOW~., data=trainset[,c(15,18:ncol(trainset))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # for leave one group (basin) out cross validation
  if(groupingstyle=="logo"){
    linearmodel <- results <- modgof <- list()
    for (k in 1:(length(unique(data$CDEC_ID)))){
      h <- unique(data$CDEC_ID)[k]
      testset <- data[data$CDEC_ID==h,]
      trainset <- data[data$CDEC_ID!=h,]
      linearmodel[[k]] <- glm(FLOW~., data=trainset[,c(15,18:ncol(trainset))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
    colnames(modgof) <- unique(data$CDEC_ID)
  }
  
  # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
  if(groupingstyle=="lmgo"){
    nfolds <- 5
    group <- as.data.frame(unique(data$CDEC_ID))
    colnames(group) <- "CDEC_ID"
    group$kftrain <- kfold(nrow(group), nfolds)
    data <- merge(data, group, by="CDEC_ID")
    
    linearmodel <- results <- modgof <- list()
    for (k in 1:nfolds) {
      testset <- data[data$kftrain == k, ]
      trainset <- data[data$kftrain != k, ]
      linearmodel[[k]] <- glm(FLOW~., data=trainset[,c(15,18:ncol(trainset))], family=tweedie(var.power=1.1, link.power=0), maxit=1000)
      predictions <- predict(linearmodel[[k]], testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # # for leave hierarchies out cross validation
  # if(groupingstyle=="lho"){
  # }
  
  if(groupingstyle=="resub"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else if(groupingstyle=="logo"){
    list(mod=linearmodel, results=results, gof=modgof)
    }
  else{
    list(mod=linearmodel, results=results, gof=modgof, kf=group)
    }
}

library(statmod)
# glmtwd_agg_resub_results <- glmcv(df_lm_agg, "resub", "agg")
# glmtwd_agg_2fold_results <- glmcv(df_lm_agg, 2L, "agg")
# glmtwd_agg_5fold_results <- glmcv(df_lm_agg, 5L, "agg")
# glmtwd_agg_10fold_results <- glmcv(df_lm_agg, 10L, "agg")
# glmtwd_agg_logo_results <- glmcv(df_lm_agg, "logo", "agg")
# glmtwd_agg_lmgo_results <- glmcv(df_lm_agg, "lmgo", "agg")
# 
# glmtwd_inc_resub_results <- glmcv(df_lm_inc, "resub", "inc")
# glmtwd_inc_2fold_results <- glmcv(df_lm_inc, 2L, "inc")
# glmtwd_inc_5fold_results <- glmcv(df_lm_inc, 5L, "inc")
# glmtwd_inc_10fold_results <- glmcv(df_lm_inc, 10L, "inc")
# glmtwd_inc_logo_results <- glmcv(df_lm_inc, "logo", "inc")
# glmtwd_inc_lmgo_results <- glmcv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(glmtwd_agg_resub_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_resub_results.RDS")
# saveRDS(glmtwd_agg_2fold_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_2fold_results.RDS")
# saveRDS(glmtwd_agg_5fold_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_5fold_results.RDS")
# saveRDS(glmtwd_agg_10fold_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_10fold_results.RDS")
# saveRDS(glmtwd_agg_logo_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_logo_results.RDS")
# saveRDS(glmtwd_agg_lmgo_results, file="ch4 resampling/outputdata/rds/glmtwd_agg_lmgo_results.RDS")
# 
# saveRDS(glmtwd_inc_resub_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_resub_results.RDS")
# saveRDS(glmtwd_inc_2fold_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_2fold_results.RDS")
# saveRDS(glmtwd_inc_5fold_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_5fold_results.RDS")
# saveRDS(glmtwd_inc_10fold_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_10fold_results.RDS")
# saveRDS(glmtwd_inc_logo_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_logo_results.RDS")
# saveRDS(glmtwd_inc_lmgo_results, file="ch4 resampling/outputdata/rds/glmtwd_inc_lmgo_results.RDS")

glmtwd_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_resub_results.RDS")
glmtwd_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_2fold_results.RDS")
glmtwd_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_5fold_results.RDS")
glmtwd_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_10fold_results.RDS")
glmtwd_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_logo_results.RDS")
glmtwd_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_agg_lmgo_results.RDS")

glmtwd_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_resub_results.RDS")
glmtwd_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_2fold_results.RDS")
glmtwd_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_5fold_results.RDS")
glmtwd_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_10fold_results.RDS")
glmtwd_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_logo_results.RDS")
glmtwd_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/glmtwd_inc_lmgo_results.RDS")
```

```{r rf_modelling_and_cv}
# we are not saving the models because it takes too much memory. so rrfmodel is no longer specified as a list and took mod=rfmodel out of return list. 

library(randomForest)

# # let's first optimize the tuning parameter mtry
# trf <- tuneRF(df_lm_inc[,c(15,18:ncol(df_lm_inc))], df_lm_inc$FLOW, mtryStart=5, stepFactor=2)
# mt <- trf[which.min(trf[,2]), 1]
mt <- 20

rfcv <- function(data, groupingstyle, datatype){
  # for resubstitution, where testing data and training data is the same
  if(groupingstyle=="resub"){
    rfmodel <- randomForest(FLOW~. , data=data[,c(15,18:ncol(data))], mtry=mt)
    predictions <- predict(rfmodel, data, type='response')
    results <- cbind(obs=data$FLOW, pred=predictions)
    modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
  }
  
  # for k-fold cross validation
  if(is.integer(groupingstyle)){
    group <- kfold(data, groupingstyle)
    results <- modgof <- list()
    for(k in 1:groupingstyle) {
      trainset <- data[group != k, ]
      testset <- data[group == k, ]
      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:ncol(trainset))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # for leave one group (basin) out cross validation
  if(groupingstyle=="logo"){
    results <- modgof <- list()
    for (k in 1:(length(unique(data$CDEC_ID)))){
      h <- unique(data$CDEC_ID)[k]
      testset <- data[data$CDEC_ID==h,]
      trainset <- data[data$CDEC_ID!=h,]
      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:ncol(trainset))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
    colnames(modgof) <- unique(data$CDEC_ID)
  }
  
  # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
  if(groupingstyle=="lmgo"){
    nfolds <- 5
    group <- as.data.frame(unique(data$CDEC_ID))
    colnames(group) <- "CDEC_ID"
    group$kftrain <- kfold(nrow(group), nfolds)
    data <- merge(data, group, by="CDEC_ID")
    
    results <- modgof <- list()
    for (k in 1:nfolds) {
      testset <- data[data$kftrain == k, ]
      trainset <- data[data$kftrain != k, ]
      rfmodel <- randomForest(FLOW~. , data=trainset[,c(15,18:ncol(trainset))], mtry=mt)
      predictions <- predict(rfmodel, testset, type='response')
      results[[k]] <- cbind(obs=testset$FLOW, pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  if(groupingstyle=="resub"){
    list(results=results, gof=modgof)
  } else if(groupingstyle=="logo"){
    list(results=results, gof=modgof)
  } else{
    list(results=results, gof=modgof, kf=group)
  }
}

# rf_agg_resub_results <- rfcv(df_lm_agg, "resub", "agg")
# rf_agg_2fold_results <- rfcv(df_lm_agg, 2L, "agg")
# rf_agg_5fold_results <- rfcv(df_lm_agg, 5L, "agg")
# rf_agg_10fold_results <- rfcv(df_lm_agg, 10L, "agg")
# rf_agg_logo_results <- rfcv(df_lm_agg, "logo", "agg")
# rf_agg_lmgo_results <- rfcv(df_lm_agg, "lmgo", "agg")
# 
# rf_inc_resub_results <- rfcv(df_lm_inc, "resub", "inc")
# rf_inc_2fold_results <- rfcv(df_lm_inc, 2L, "inc")
# rf_inc_5fold_results <- rfcv(df_lm_inc, 5L, "inc")
# rf_inc_10fold_results <- rfcv(df_lm_inc, 10L, "inc")
# rf_inc_logo_results <- rfcv(df_lm_inc, "logo", "inc")
# rf_inc_lmgo_results <- rfcv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(rf_agg_resub_results, file="ch4 resampling/outputdata/rds/rf_agg_resub_results.RDS")
# saveRDS(rf_agg_2fold_results, file="ch4 resampling/outputdata/rds/rf_agg_2fold_results.RDS")
# saveRDS(rf_agg_5fold_results, file="ch4 resampling/outputdata/rds/rf_agg_5fold_results.RDS")
# saveRDS(rf_agg_10fold_results, file="ch4 resampling/outputdata/rds/rf_agg_10fold_results.RDS")
# saveRDS(rf_agg_logo_results, file="ch4 resampling/outputdata/rds/rf_agg_logo_results.RDS")
# saveRDS(rf_agg_lmgo_results, file="ch4 resampling/outputdata/rds/rf_agg_lmgo_results.RDS")
# 
# saveRDS(rf_inc_resub_results, file="ch4 resampling/outputdata/rds/rf_inc_resub_results.RDS")
# saveRDS(rf_inc_2fold_results, file="ch4 resampling/outputdata/rds/rf_inc_2fold_results.RDS")
# saveRDS(rf_inc_5fold_results, file="ch4 resampling/outputdata/rds/rf_inc_5fold_results.RDS")
# saveRDS(rf_inc_10fold_results, file="ch4 resampling/outputdata/rds/rf_inc_10fold_results.RDS")
# saveRDS(rf_inc_logo_results, file="ch4 resampling/outputdata/rds/rf_inc_logo_results.RDS")
# saveRDS(rf_inc_lmgo_results, file="ch4 resampling/outputdata/rds/rf_inc_lmgo_results.RDS")

rf_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_resub_results.RDS")
rf_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_2fold_results.RDS")
rf_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_5fold_results.RDS")
rf_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_10fold_results.RDS")
rf_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_logo_results.RDS")
rf_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/rf_agg_lmgo_results.RDS")

rf_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_resub_results.RDS")
rf_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_2fold_results.RDS")
rf_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_5fold_results.RDS")
rf_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_10fold_results.RDS")
rf_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_logo_results.RDS")
rf_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/rf_inc_lmgo_results.RDS")
```

RUN JUST THE NN INC ONES LATER
```{r nn_modeling_and_cv}
# install and set up our environment for deep learning
# devtools::install_github("rstudio/keras")
library(keras)
install_keras(method = "conda")

nncv <- function(data, groupingstyle, datatype){
  # the model network includes two layers of fully-connected relu activated neurons, and an output layer with no transformation. units are the number of hidden nodes
  trainingdim <- dim(data[,c(15,18:(ncol(data)-1))])
  nnmodel <- keras_model_sequential() %>%
  layer_dense(units=64, activation="relu", input_shape=trainingdim[[2]]) %>%
  layer_dense(units=64, activation="relu") %>%
  layer_dense(units=1) # number of outputs, here we just want one prediction
    
  nnmodel %>% # to compile the model, loss functions are defined here
    compile(optimizer="rmsprop", loss=keras::loss_mean_squared_error, metrics=c("mae"))
    
  # for resubstitution, where testing data and training data is the same
  if(groupingstyle=="resub"){
    trainsetpvs <- as.matrix(data[,c(15,18:(ncol(data)-1))])
    trainsetrv <- as.matrix(data$FLOW)
    nnmodel %>%  # this is to fit the model coefficients
      fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
    predictions <- nnmodel %>% predict(trainsetpvs)
    predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
    results <- cbind(obs=trainsetrv[ , 1], pred=predictions)
    modgof <- gof(as.data.frame(results)$pred, as.data.frame(results)$obs)
  }
  
  # for k-fold cross validation
  if(is.integer(groupingstyle)){
    group <- kfold(data, groupingstyle)
    results <- modgof <- list()
    for(k in 1:groupingstyle) {
      trainset <- data[group != k, ]
      testset <- data[group == k, ]
      
      # seperate into predictor variables and response variable
      testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-1))])
      trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-1))])
      testsetrv <- as.matrix(testset$FLOW)
      trainsetrv <- as.matrix(trainset$FLOW)
      
      nnmodel %>% 
        fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
      predictions <- nnmodel %>% predict(testsetpvs)
      predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
      results[[k]] <- cbind(obs=testsetrv[ , 1], pred=predictions, nforstitch=as.numeric(rownames(testset))) # adding rownames here for later stitching the dataset back to its original shape
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  # for leave one group (basin) out cross validation
  if(groupingstyle=="logo"){
    results <- modgof <- list()
  
    for (k in 1:(length(unique(data$CDEC_ID)))){
      h <- unique(data$CDEC_ID)[k]
      testset <- data[data$CDEC_ID==h,]
      trainset <- data[data$CDEC_ID!=h,]
      testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-1))])
      trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-1))])
      testsetrv <- as.matrix(testset$FLOW)
      trainsetrv <- as.matrix(trainset$FLOW)
      
      nnmodel %>%  
        fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
      predictions <- nnmodel %>% predict(testsetpvs)
      predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
      results[[k]] <- cbind(obs=testsetrv[ , 1], pred=predictions)
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
    colnames(modgof) <- unique(data$CDEC_ID)
  }
  
  # for random 5-fold leave multiple groups out cross validation, meaning a random 1/5 of the basins will be left out of training
  if(groupingstyle=="lmgo"){
    nfolds <- 5
    group <- as.data.frame(unique(data$CDEC_ID))
    colnames(group) <- "CDEC_ID"
    group$kftrain <- kfold(nrow(group), nfolds)
    data <- merge(data, group, by="CDEC_ID")
    
    results <- modgof <- list()
    for(k in 1:nfolds) {
      testset <- data[data$kftrain == k, ]
      trainset <- data[data$kftrain != k, ]
      testsetpvs <- as.matrix(testset[,c(15,18:(ncol(testset)-2))])
      trainsetpvs <- as.matrix(trainset[,c(15,18:(ncol(trainset)-2))])
      testsetrv <- as.matrix(testset$FLOW)
      trainsetrv <- as.matrix(trainset$FLOW)
      
      nnmodel %>% 
        fit(trainsetpvs, trainsetrv, epochs=100, batch_size=25, verbose=1, validation_split=0.2)
      predictions <- nnmodel %>% predict(testsetpvs)
      predictions <- predictions[ , 1] # because output layer was specified to be of unit=1
      results[[k]] <- cbind(obs=testsetrv[ , 1], pred=predictions, nforstitch=as.numeric(rownames(testset)))
      modgof[[k]] <- gof(as.data.frame(results[[k]])$pred, as.data.frame(results[[k]])$obs)
    }
    names_tbd <- rownames(modgof[[1]])
    modgof <- data.frame(matrix(unlist(modgof), nrow=length(modgof[[1]]), byrow=FALSE))
    rownames(modgof) <- names_tbd
  }
  
  if(groupingstyle=="resub"){
    list(results=results, gof=modgof)
  } else if(groupingstyle=="logo"){
    list(results=results, gof=modgof)
  } else{
    list(results=results, gof=modgof, kf=group)
  }
}

# nn_agg_resub_results <- nncv(df_lm_agg, "resub", "agg")
# nn_agg_2fold_results <- nncv(df_lm_agg, 2L, "agg")
# nn_agg_5fold_results <- nncv(df_lm_agg, 5L, "agg")
# nn_agg_10fold_results <- nncv(df_lm_agg, 10L, "agg")
# nn_agg_logo_results <- nncv(df_lm_agg, "logo", "agg")
# nn_agg_lmgo_results <- nncv(df_lm_agg, "lmgo", "agg")
# 
# nn_inc_resub_results <- nncv(df_lm_inc, "resub", "inc")
# nn_inc_2fold_results <- nncv(df_lm_inc, 2L, "inc")
# nn_inc_5fold_results <- nncv(df_lm_inc, 5L, "inc")
# nn_inc_10fold_results <- nncv(df_lm_inc, 10L, "inc")
# nn_inc_logo_results <- nncv(df_lm_inc, "logo", "inc")
# nn_inc_lmgo_results <- nncv(df_lm_inc, "lmgo", "inc")
# 
# saveRDS(nn_agg_resub_results, file="ch4 resampling/outputdata/rds/nn_agg_resub_results.RDS")
# saveRDS(nn_agg_2fold_results, file="ch4 resampling/outputdata/rds/nn_agg_2fold_results.RDS")
# saveRDS(nn_agg_5fold_results, file="ch4 resampling/outputdata/rds/nn_agg_5fold_results.RDS")
# saveRDS(nn_agg_10fold_results, file="ch4 resampling/outputdata/rds/nn_agg_10fold_results.RDS")
# saveRDS(nn_agg_logo_results, file="ch4 resampling/outputdata/rds/nn_agg_logo_results.RDS")
# saveRDS(nn_agg_lmgo_results, file="ch4 resampling/outputdata/rds/nn_agg_lmgo_results.RDS")
# 
# saveRDS(nn_inc_resub_results, file="ch4 resampling/outputdata/rds/nn_inc_resub_results.RDS")
# saveRDS(nn_inc_2fold_results, file="ch4 resampling/outputdata/rds/nn_inc_2fold_results.RDS")
# saveRDS(nn_inc_5fold_results, file="ch4 resampling/outputdata/rds/nn_inc_5fold_results.RDS")
# saveRDS(nn_inc_10fold_results, file="ch4 resampling/outputdata/rds/nn_inc_10fold_results.RDS")
# saveRDS(nn_inc_logo_results, file="ch4 resampling/outputdata/rds/nn_inc_logo_results.RDS")
# saveRDS(nn_inc_lmgo_results, file="ch4 resampling/outputdata/rds/nn_inc_lmgo_results.RDS")

nn_agg_resub_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_resub_results.RDS")
nn_agg_2fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_2fold_results.RDS")
nn_agg_5fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_5fold_results.RDS")
nn_agg_10fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_10fold_results.RDS")
nn_agg_logo_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_logo_results.RDS")
nn_agg_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/nn_agg_lmgo_results.RDS")

# nn_inc_resub_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_resub_results.RDS")
# nn_inc_2fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_2fold_results.RDS")
# nn_inc_5fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_5fold_results.RDS")
# nn_inc_10fold_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_10fold_results.RDS")
# nn_inc_logo_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_logo_results.RDS")
# nn_inc_lmgo_results <- readRDS("ch4 resampling/outputdata/rds/nn_inc_lmgo_results.RDS")
```

For saving results
```{r data_results_df}
# make a copy of the original dataframes to add the results to later
# notice how the lm, not glm dataset was used for the Tweedie distribution
results_lm_agg <- results_glm_agg <- results_nn_agg <- results_rf_agg <- df_lm_agg
results_lm_inc <- results_glm_inc <- results_nn_inc <- results_rf_inc <- df_lm_inc

# consider putting them all in one dataframe 
results_agg <- df_lm_agg
results_inc <- df_lm_inc
```

# 5.0 LOGO Post Processing 

## 5.1 Aggregate basins
```{r results_dataframes}
# put the logo results in their respective dataframes
# datatype: "agg", "inc"
# modeltype: "lm", "glm", "rf", "nn"
# grouping style: "resub", "2fold", "5fold", "10fold", "logo", "lmgo"

pp_agg_results <- function(resultsls, resultsdf, modeltype, groupingstyle){
  if(groupingstyle=="resub"){
    results_unlisted <- as.data.frame(resultsls$results)
    resultsdf <- cbind(resultsdf, RESUBFIT=results_unlisted$pred)
    resultsdf$RESUBRES <- resultsdf$RESUBFIT-resultsdf$FLOW # this is pred - obs
    
    # adding a KF column to make it consistent between groupingstyles
    resultsdf$KF <- 1
    colnames(resultsdf)[ncol(resultsdf)] <- "RESUBKF"
  } 
  
  if(is.integer(groupingstyle)){ 
    if(modeltype=="nn"){ # for NN we made a nforstitch column, use that to order instead of the usual way of using rownames
      kftype <- paste0(as.character(groupingstyle), "FOLD")
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      results_unlisted <- results_unlisted[order(results_unlisted$nforstitch), ]
      resultsdf <- cbind(resultsdf, FIT=results_unlisted$pred)
      resultsdf$RES <- resultsdf$FIT-resultsdf$FLOW
      colnames(resultsdf)[ncol(resultsdf)-1] <- paste0(kftype, "FIT")
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "RES")
      resultsdf$KF <- resultsls$kf
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "KF")
    }else{
      kftype <- paste0(as.character(groupingstyle), "FOLD")
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      # use the kf vector to scramble the unlisted results, to match up with the observations in the results df... no need to do these, because the rownames, or I should say numbers, have been preserved. So, just order
      index <- as.numeric(row.names(results_unlisted))
      results_unlisted <- results_unlisted[order(index), ]
      resultsdf <- cbind(resultsdf, FIT=results_unlisted$pred)
      resultsdf$RES <- resultsdf$FIT-resultsdf$FLOW
      colnames(resultsdf)[ncol(resultsdf)-1] <- paste0(kftype, "FIT")
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "RES")
      resultsdf$KF <- resultsls$kf
      colnames(resultsdf)[ncol(resultsdf)] <- paste0(kftype, "KF")
    }
  }
  
  if(groupingstyle=="logo"){ # no need to use the unique CDEC_IDs vector to scramble the unlisted results because the original results dataframe is in the same order, so a simple cbind will be OK
    results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
    resultsdf <- cbind(resultsdf, LOGOFIT=results_unlisted$pred)
    resultsdf$LOGORES <- resultsdf$LOGOFIT-resultsdf$FLOW 
    
    # adding a KF column to make it consistent between groupingstyles
    resultsdf$KF <- as.numeric(resultsdf$CDEC_ID)
    colnames(resultsdf)[ncol(resultsdf)] <- "LOGOKF"
  }
  
  if(groupingstyle=="lmgo"){
    if(modeltype=="nn"){ 
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      results_unlisted <- results_unlisted[order(results_unlisted$nforstitch), ]
      resultsdf <- cbind(resultsdf, LMGOFIT=results_unlisted$pred)
      resultsdf$LMGORES <- resultsdf$LMGOFIT-resultsdf$FLOW
      resultsdf <- merge(resultsdf, resultsls$kf, by="CDEC_ID")
      colnames(resultsdf)[ncol(resultsdf)] <- "LMGOKF"
    } else {
      results_unlisted <- as.data.frame(do.call("rbind", resultsls$results))
      index <- as.numeric(row.names(results_unlisted))
      results_unlisted <- results_unlisted[order(index), ]
      resultsdf <- cbind(resultsdf, LMGOFIT=results_unlisted$pred)
      resultsdf$LMGORES <- resultsdf$LMGOFIT-resultsdf$FLOW
      resultsdf <- merge(resultsdf, resultsls$kf, by="CDEC_ID")
      colnames(resultsdf)[ncol(resultsdf)] <- "LMGOKF"
    }
  }
  
  # now change column names based on modeltype
  colnames(resultsdf)[ncol(resultsdf)-2] <- paste0(toupper(modeltype), "_", colnames(resultsdf)[ncol(resultsdf)-2])
  colnames(resultsdf)[ncol(resultsdf)-1] <- paste0(toupper(modeltype), "_", colnames(resultsdf)[ncol(resultsdf)-1])
  colnames(resultsdf)[ncol(resultsdf)] <- paste0(toupper(modeltype), "_", colnames(resultsdf)[ncol(resultsdf)])
  return(resultsdf)
}

# first check to see if the dimensions match, examples below
dim(as.data.frame(do.call("rbind", glmtwd_agg_lmgo_results$results)))[[1]] == dim(results_agg)[[1]]

results_agg <- pp_agg_results(lm_agg_resub_results, results_agg, "lm", "resub")
results_agg <- pp_agg_results(lm_agg_2fold_results, results_agg, "lm", 2L)
results_agg <- pp_agg_results(lm_agg_5fold_results, results_agg, "lm", 5L)
results_agg <- pp_agg_results(lm_agg_10fold_results, results_agg, "lm", 10L)
results_agg <- pp_agg_results(lm_agg_logo_results, results_agg, "lm", "logo")
results_agg <- pp_agg_results(lm_agg_lmgo_results, results_agg, "lm", "lmgo")

results_agg <- pp_agg_results(glmtwd_agg_resub_results, results_agg, "glm", "resub")
results_agg <- pp_agg_results(glmtwd_agg_2fold_results, results_agg, "glm", 2L)
results_agg <- pp_agg_results(glmtwd_agg_5fold_results, results_agg, "glm", 5L)
results_agg <- pp_agg_results(glmtwd_agg_10fold_results, results_agg, "glm", 10L)
results_agg <- pp_agg_results(glmtwd_agg_logo_results, results_agg, "glm", "logo")
results_agg <- pp_agg_results(glmtwd_agg_lmgo_results, results_agg, "glm", "lmgo")

results_agg <- pp_agg_results(rf_agg_resub_results, results_agg, "rf", "resub")
results_agg <- pp_agg_results(rf_agg_2fold_results, results_agg, "rf", 2L)
results_agg <- pp_agg_results(rf_agg_5fold_results, results_agg, "rf", 5L)
results_agg <- pp_agg_results(rf_agg_10fold_results, results_agg, "rf", 10L)
results_agg <- pp_agg_results(rf_agg_logo_results, results_agg, "rf", "logo")
results_agg <- pp_agg_results(rf_agg_lmgo_results, results_agg, "rf", "lmgo")

results_agg <- pp_agg_results(nn_agg_resub_results, results_agg, "nn", "resub")
results_agg <- pp_agg_results(nn_agg_2fold_results, results_agg, "nn", 2L)
results_agg <- pp_agg_results(nn_agg_5fold_results, results_agg, "nn", 5L)
results_agg <- pp_agg_results(nn_agg_10fold_results, results_agg, "nn", 10L)
results_agg <- pp_agg_results(nn_agg_logo_results, results_agg, "nn", "logo")
results_agg <- pp_agg_results(nn_agg_lmgo_results, results_agg, "nn", "lmgo")
```

## 5.2 Incremental Basins
```{r post_processing_lm_logo_inc}
# not doing this! doesn't make any sense for grouping styles other than logo 
# pp_inc_results <- function(resultsls, resultsdf, modeltype, groupingstyle){
# }
```

## 5.3 GOF
```{r post_processing_gof}
gof_lm_resub_agg <- gof(results_agg$LM_RESUBFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_resub_agg <- gof(results_agg$GLM_RESUBFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_resub_agg <- gof(results_agg$RF_RESUBFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_resub_agg <- gof(results_agg$NN_RESUBFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_2fold_agg <- gof(results_agg$LM_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_2fold_agg <- gof(results_agg$GLM_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_2fold_agg <- gof(results_agg$RF_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_2fold_agg <- gof(results_agg$NN_2FOLDFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_5fold_agg <- gof(results_agg$LM_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_5fold_agg <- gof(results_agg$GLM_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_5fold_agg <- gof(results_agg$RF_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_5fold_agg <- gof(results_agg$NN_5FOLDFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_10fold_agg <- gof(results_agg$LM_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_10fold_agg <- gof(results_agg$GLM_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_10fold_agg <- gof(results_agg$RF_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_10fold_agg <- gof(results_agg$NN_10FOLDFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_logo_agg <- gof(results_agg$LM_LOGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_logo_agg <- gof(results_agg$GLM_LOGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_logo_agg <- gof(results_agg$RF_LOGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_logo_agg <- gof(results_agg$NN_LOGOFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_lmgo_agg <- gof(results_agg$LM_LMGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_glm_lmgo_agg <- gof(results_agg$GLM_LMGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_rf_lmgo_agg <- gof(results_agg$RF_LMGOFIT, results_agg$FLOW, na.rm=TRUE)
gof_nn_lmgo_agg <- gof(results_agg$NN_LMGOFIT, results_agg$FLOW, na.rm=TRUE)

gof_lm_agg <- cbind(gof_lm_resub_agg, gof_lm_2fold_agg, gof_lm_5fold_agg, gof_lm_10fold_agg, gof_lm_logo_agg, gof_lm_lmgo_agg)
gof_glm_agg <- cbind(gof_glm_resub_agg, gof_glm_2fold_agg, gof_glm_5fold_agg, gof_glm_10fold_agg, gof_glm_logo_agg, gof_glm_lmgo_agg)
gof_rf_agg <- cbind(gof_rf_resub_agg, gof_rf_2fold_agg, gof_rf_5fold_agg, gof_rf_10fold_agg, gof_rf_logo_agg, gof_rf_lmgo_agg)
gof_nn_agg <- cbind(gof_nn_resub_agg, gof_nn_2fold_agg, gof_nn_5fold_agg, gof_nn_10fold_agg, gof_nn_logo_agg, gof_nn_lmgo_agg)

colnames(gof_lm_agg) <- c("LM_RESUB", "LM_2FOLD", "LM_5FOLD", "LM_10FOLD", "LM_LOGO", "LM_LMGO")
colnames(gof_glm_agg) <- c("GLM_RESUB", "GLM_2FOLD", "GLM_5FOLD", "GLM_10FOLD", "GLM_LOGO", "GLM_LMGO")
colnames(gof_rf_agg) <- c("RF_RESUB", "RF_2FOLD", "RF_5FOLD", "RF_10FOLD", "RF_LOGO", "RF_LMGO")
colnames(gof_nn_agg) <- c("NN_RESUB", "NN_2FOLD", "NN_5FOLD", "NN_10FOLD", "NN_LOGO", "NN_LMGO")

gof_all <- as.data.frame(cbind(gof_lm_agg, gof_glm_agg, gof_rf_agg, gof_nn_agg))

library(Hmisc)
var_labels <- c("LM Resub", "LM 2 Fold", "LM 5 Fold", "LM 10 Fold", "LM Logo", "LM Lmgo", "GLM Resub", "GLM 2 Fold", "GLM 5 Fold", "GLM 10 Fold", "GLM Logo", "GLM Lmgo", "RF Resub", "RF 2 Fold", "RF 5 Fold", "RF 10 Fold", "RF Logo", "RF Lmgo", "NN Resub", "NN 2 Fold", "NN 5 Fold", "NN 10 Fold", "NN Logo", "NN Lmgo") 
names(var_labels) <- colnames(gof_all)
Hmisc::label(gof_all) <- lapply(names(var_labels), function(x) Hmisc::label(gof_all[,x]) = var_labels[x])

# for latex documents, put this in appendix
library(xtable)
xtable(data.frame(gof_all))

# check results
gof_all["bR2",]
```

```{r post_processing_gof_by_basins}
gof_lm_resub_agg <- gof_glm_resub_agg <- gof_rf_resub_agg <- gof_nn_resub_agg <- list()
gof_lm_2fold_agg <- gof_glm_2fold_agg <- gof_rf_2fold_agg <- gof_nn_2fold_agg <- list()
gof_lm_5fold_agg <- gof_glm_5fold_agg <- gof_rf_5fold_agg <- gof_nn_5fold_agg <- list()
gof_lm_10fold_agg <- gof_glm_10fold_agg <- gof_rf_10fold_agg <- gof_nn_10fold_agg <- list()
gof_lm_logo_agg <- gof_glm_logo_agg <- gof_rf_logo_agg <- gof_nn_logo_agg <- list()
gof_lm_lmgo_agg <- gof_glm_lmgo_agg <- gof_rf_lmgo_agg <- gof_nn_lmgo_agg <- list()

for (r in 1:(length(unique(results_agg$CDEC_ID)))){ 
  h <- unique(results_agg$CDEC_ID)[r]
  resultsdf_sub <- results_agg[results_agg$CDEC_ID==h,]
  
  gof_lm_resub_agg[[r]] <- gof(resultsdf_sub$LM_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_resub_agg[[r]] <- gof(resultsdf_sub$GLM_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_resub_agg[[r]] <- gof(resultsdf_sub$RF_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_resub_agg[[r]] <- gof(resultsdf_sub$NN_RESUBFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_2fold_agg[[r]] <- gof(resultsdf_sub$LM_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_2fold_agg[[r]] <- gof(resultsdf_sub$GLM_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_2fold_agg[[r]] <- gof(resultsdf_sub$RF_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_2fold_agg[[r]] <- gof(resultsdf_sub$NN_2FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_5fold_agg[[r]] <- gof(resultsdf_sub$LM_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_5fold_agg[[r]] <- gof(resultsdf_sub$GLM_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_5fold_agg[[r]] <- gof(resultsdf_sub$RF_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_5fold_agg[[r]] <- gof(resultsdf_sub$NN_5FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_10fold_agg[[r]] <- gof(resultsdf_sub$LM_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_10fold_agg[[r]] <- gof(resultsdf_sub$GLM_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_10fold_agg[[r]] <- gof(resultsdf_sub$RF_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_10fold_agg[[r]] <- gof(resultsdf_sub$NN_10FOLDFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_logo_agg[[r]] <- gof(resultsdf_sub$LM_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_logo_agg[[r]] <- gof(resultsdf_sub$GLM_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_logo_agg[[r]] <- gof(resultsdf_sub$RF_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_logo_agg[[r]] <- gof(resultsdf_sub$NN_LOGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  
  gof_lm_lmgo_agg[[r]] <- gof(resultsdf_sub$LM_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_glm_lmgo_agg[[r]] <- gof(resultsdf_sub$GLM_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_rf_lmgo_agg[[r]] <- gof(resultsdf_sub$RF_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
  gof_nn_lmgo_agg[[r]] <- gof(resultsdf_sub$NN_LMGOFIT, resultsdf_sub$FLOW, na.rm=TRUE)
}

names_tbd <- rownames(gof_lm_resub_agg[[1]])
gof_lm_resub_agg_by_basins <- data.frame(matrix(unlist(gof_lm_resub_agg), nrow=length(gof_lm_resub_agg[[1]]), byrow=FALSE))
gof_glm_resub_agg_by_basins <- data.frame(matrix(unlist(gof_glm_resub_agg), nrow=length(gof_glm_resub_agg[[1]]), byrow=FALSE))
gof_rf_resub_agg_by_basins <- data.frame(matrix(unlist(gof_rf_resub_agg), nrow=length(gof_rf_resub_agg[[1]]), byrow=FALSE))
gof_nn_resub_agg_by_basins <- data.frame(matrix(unlist(gof_nn_resub_agg), nrow=length(gof_nn_resub_agg[[1]]), byrow=FALSE))
gof_lm_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_lm_2fold_agg), nrow=length(gof_lm_2fold_agg[[1]]), byrow=FALSE))
gof_glm_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_glm_2fold_agg), nrow=length(gof_glm_2fold_agg[[1]]), byrow=FALSE))
gof_rf_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_rf_2fold_agg), nrow=length(gof_rf_2fold_agg[[1]]), byrow=FALSE))
gof_nn_2fold_agg_by_basins <- data.frame(matrix(unlist(gof_nn_2fold_agg), nrow=length(gof_nn_2fold_agg[[1]]), byrow=FALSE))
gof_lm_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_lm_5fold_agg), nrow=length(gof_lm_5fold_agg[[1]]), byrow=FALSE))
gof_glm_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_glm_5fold_agg), nrow=length(gof_glm_5fold_agg[[1]]), byrow=FALSE))
gof_rf_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_rf_5fold_agg), nrow=length(gof_rf_5fold_agg[[1]]), byrow=FALSE))
gof_nn_5fold_agg_by_basins <- data.frame(matrix(unlist(gof_nn_5fold_agg), nrow=length(gof_nn_5fold_agg[[1]]), byrow=FALSE))
gof_lm_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_lm_10fold_agg), nrow=length(gof_lm_10fold_agg[[1]]), byrow=FALSE))
gof_glm_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_glm_10fold_agg), nrow=length(gof_glm_10fold_agg[[1]]), byrow=FALSE))
gof_rf_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_rf_10fold_agg), nrow=length(gof_rf_10fold_agg[[1]]), byrow=FALSE))
gof_nn_10fold_agg_by_basins <- data.frame(matrix(unlist(gof_nn_10fold_agg), nrow=length(gof_nn_10fold_agg[[1]]), byrow=FALSE))
gof_lm_logo_agg_by_basins <- data.frame(matrix(unlist(gof_lm_logo_agg), nrow=length(gof_lm_logo_agg[[1]]), byrow=FALSE))
gof_glm_logo_agg_by_basins <- data.frame(matrix(unlist(gof_glm_logo_agg), nrow=length(gof_glm_logo_agg[[1]]), byrow=FALSE))
gof_rf_logo_agg_by_basins <- data.frame(matrix(unlist(gof_rf_logo_agg), nrow=length(gof_rf_logo_agg[[1]]), byrow=FALSE))
gof_nn_logo_agg_by_basins <- data.frame(matrix(unlist(gof_nn_logo_agg), nrow=length(gof_nn_logo_agg[[1]]), byrow=FALSE))
gof_lm_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_lm_lmgo_agg), nrow=length(gof_lm_lmgo_agg[[1]]), byrow=FALSE))
gof_glm_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_glm_lmgo_agg), nrow=length(gof_glm_lmgo_agg[[1]]), byrow=FALSE))
gof_rf_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_rf_lmgo_agg), nrow=length(gof_rf_lmgo_agg[[1]]), byrow=FALSE))
gof_nn_lmgo_agg_by_basins <- data.frame(matrix(unlist(gof_nn_lmgo_agg), nrow=length(gof_nn_lmgo_agg[[1]]), byrow=FALSE))

rownames(gof_lm_resub_agg_by_basins) <- names_tbd
rownames(gof_glm_resub_agg_by_basins) <- names_tbd
rownames(gof_rf_resub_agg_by_basins) <- names_tbd
rownames(gof_nn_resub_agg_by_basins) <- names_tbd
rownames(gof_lm_2fold_agg_by_basins) <- names_tbd
rownames(gof_glm_2fold_agg_by_basins) <- names_tbd
rownames(gof_rf_2fold_agg_by_basins) <- names_tbd
rownames(gof_nn_2fold_agg_by_basins) <- names_tbd
rownames(gof_lm_5fold_agg_by_basins) <- names_tbd
rownames(gof_glm_5fold_agg_by_basins) <- names_tbd
rownames(gof_rf_5fold_agg_by_basins) <- names_tbd
rownames(gof_nn_5fold_agg_by_basins) <- names_tbd
rownames(gof_lm_10fold_agg_by_basins) <- names_tbd
rownames(gof_glm_10fold_agg_by_basins) <- names_tbd
rownames(gof_rf_10fold_agg_by_basins) <- names_tbd
rownames(gof_nn_10fold_agg_by_basins) <- names_tbd
rownames(gof_lm_logo_agg_by_basins) <- names_tbd
rownames(gof_glm_logo_agg_by_basins) <- names_tbd
rownames(gof_rf_logo_agg_by_basins) <- names_tbd
rownames(gof_nn_logo_agg_by_basins) <- names_tbd
rownames(gof_lm_lmgo_agg_by_basins) <- names_tbd
rownames(gof_glm_lmgo_agg_by_basins) <- names_tbd
rownames(gof_rf_lmgo_agg_by_basins) <- names_tbd
rownames(gof_nn_lmgo_agg_by_basins) <- names_tbd
  
colnames(gof_lm_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_resub_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_2fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_5fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_10fold_agg_by_basins) <- unique(results_agg$CDEC_ID) 
colnames(gof_lm_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_logo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_lm_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_glm_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_rf_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
colnames(gof_nn_lmgo_agg_by_basins) <- unique(results_agg$CDEC_ID)
  
remove(names_tbd)
```

# 6.0 Plots

## 6.1 GOF Comparisons
```{r mof_comp_plots}
# plot this table especially for the important errors: RMSE, bR2, NSE, KGE, VE 
goftablet <- data.frame(t(gof_all))
goftablet$MODELTYPE <- factor(c("LM", "LM", "LM", "LM", "LM", "LM", "GLM", "GLM", "GLM", "GLM", "GLM", "GLM", "RF", "RF", "RF", "RF", "RF", "RF", "NN", "NN", "NN", "NN", "NN", "NN"), levels= c("LM", "GLM", "RF", "NN"))

png('ch4 resampling/outputdata/rplot41_gof_MSE.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  par(mar=c(4,4,1,1)+0.1, cex=1)
  goftablet <- goftablet[order(goftablet$MSE, decreasing = TRUE),]
  dotchart(goftablet$MSE, label=var_labels[match(rownames(goftablet), names(var_labels))], xlab="Mean Squared Error (AF^2)", pch=19, xlim=c(min(goftablet$MSE), 1.1*max(goftablet$MSE)), color= cbpblack[5:8][goftablet$MODELTYPE])
  text(x=goftablet$MSE, y=1:nrow(goftablet), labels=prettyNum(goftablet$MSE, digits=3, scientific=TRUE), pos=4, cex=1)
dev.off()

png('ch4 resampling/outputdata/rplot41_gof_RMSE.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  par(mar=c(4,4,1,1)+0.1, cex=1)
  goftablet <- goftablet[order(goftablet$RMSE, decreasing = TRUE),]
  dotchart(goftablet$RMSE, labels=var_labels[match(rownames(goftablet), names(var_labels))], xlab="Root Mean Squared Erro (AF)", pch=19, xlim=c(min(goftablet$RMSE), 1.1*max(goftablet$RMSE)), color= cbpblack[5:8][goftablet$MODELTYPE])
  text(x=goftablet$RMSE, y=1:nrow(goftablet), labels=prettyNum(goftablet$RMSE, digits=3, scientific=TRUE), pos=4, cex=1)
dev.off()

png('ch4 resampling/outputdata/rplot41_gof_bR2.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  par(mar=c(4,4,1,1)+0.1, cex=1)
  goftablet <- goftablet[order(goftablet$bR2),]
  dotchart(goftablet$bR2, labels=var_labels[match(rownames(goftablet), names(var_labels))], xlab="Bias-Corrected Coefficient of Determination (-)", pch=19, xlim=c(0,1.05), color= cbpblack[5:8][goftablet$MODELTYPE])
  text(x=goftablet$bR2, y=1:nrow(goftablet), labels=round(goftablet$bR2,2), pos=4, cex=1)
dev.off()

png('ch4 resampling/outputdata/rplot41_gof_NSE.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  par(mar=c(4,4,1,1)+0.1, cex=1)
  goftablet <- goftablet[order(goftablet$NSE),]
  dotchart(goftablet$NSE, labels=var_labels[match(rownames(goftablet), names(var_labels))], xlab="Nash-Sutcliffe Efficiency (-)", pch=19, xlim=c(min(goftablet$NSE), 1.0), color= cbpblack[5:8][goftablet$MODELTYPE])
  text(x=goftablet$NSE, y=1:nrow(goftablet), labels=prettyNum(goftablet$NSE, digits=3, scientific=FALSE), pos=4, cex=1)
dev.off()

png('ch4 resampling/outputdata/rplot41_gof_KGE.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  par(mar=c(4,4,1,1)+0.1, cex=1)
  goftablet <- goftablet[order(goftablet$KGE),]
  dotchart(goftablet$KGE, labels=var_labels[match(rownames(goftablet), names(var_labels))], xlab="Kling-Gupta Efficiency (-)", groups=goftablet$GROUPS, pch=19, xlim=c(min(goftablet$KGE), 1.1), color= cbpblack[5:8][goftablet$MODELTYPE])
  text(x=goftablet$KGE, y=1:nrow(goftablet), labels=prettyNum(goftablet$KGE, digits=3, scientific=FALSE), pos=4, cex=1)
dev.off()

png('ch4 resampling/outputdata/rplot41_gof_VE.png', width=6.5, height=4, units="in", pointsize=8, res=1200)
  par(mar=c(4,4,1,1)+0.1, cex=1)
  goftablet <- goftablet[order(goftablet$VE),]
  dotchart(goftablet$VE, labels=var_labels[match(rownames(goftablet), names(var_labels))], xlab="Volumetric Efficiency (AF)", groups=goftablet$GROUPS, pch=19, xlim=c(min(goftablet$VE), 1), color= cbpblack[5:8][goftablet$MODELTYPE])
  text(x=goftablet$VE, y=1:nrow(goftablet), labels=prettyNum(goftablet$VE, digits=3, scientific=FALSE), pos=4, cex=1)
dev.off()
```

```{r obsvpred_plots}
# color by resampling method plot
obsvpredplot <- function(resultsdf, modeltype, legendpos){
  resubfit <- paste0(toupper(modeltype), "_RESUBFIT")
  twofoldfit <- paste0(toupper(modeltype), "_2FOLDFIT")
  fivefoldfit <- paste0(toupper(modeltype), "_5FOLDFIT")
  tenfoldfit <- paste0(toupper(modeltype), "_10FOLDFIT")
  logofit <- paste0(toupper(modeltype), "_LOGOFIT")
  lmgofit <- paste0(toupper(modeltype), "_LMGOFIT")

  # find y and x limits
  xlower <- min(resultsdf$FLOW, na.rm=TRUE)
  xupper <- max(resultsdf$FLOW, na.rm=TRUE)
  ylower <- min(resultsdf[ , lmgofit], na.rm=TRUE)
  yupper <- max(resultsdf[ , lmgofit], na.rm=TRUE)
  xylower <- min(xlower, ylower)
  xyupper <- max(xupper, yupper)
  
  png(paste0('ch4 resampling/outputdata/rplot42_obsvspred_', modeltype, '.png'), width=3.25, height=2.85, units="in", pointsize=8, res=1200)
    par(mar=c(4,4,3,3)+0.1, cex=1)
    plot(resultsdf$FLOW, resultsdf[ , resubfit], col=cbpblack[2], xlab="Observed Unimpaired Flow (AF/m)", ylab="Predicted Unimpaired Flow (AF/m)", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
    abline(0,1, col="grey70", lty=3, lwd=2)
    points(resultsdf$FLOW, resultsdf[ , twofoldfit], col=cbpblack[3], pch=19)
    points(resultsdf$FLOW, resultsdf[ , fivefoldfit], col=cbpblack[4], pch=19)
    points(resultsdf$FLOW, resultsdf[ , tenfoldfit], col=cbpblack[5], pch=19)
    points(resultsdf$FLOW, resultsdf[ , logofit], col=cbpblack[6], pch=19)
    points(resultsdf$FLOW, resultsdf[ , lmgofit], col=cbpblack[7], pch=19)
    legend(legendpos, horiz=FALSE, inset=c(0.01, 0.01), cex=0.6, legend=c("RESUB", "2FOLD", "5 FOLD", "10FOLD", "LOGO", "LMGO"), title= "Resampling Method", pch=19, col=cbpblack[2:7], bg="grey96", box.lty=0, xpd=TRUE, xjust=1, title.adj=0)
  dev.off()
}

obsvpredplot(results_agg, "lm", "topleft") 
obsvpredplot(results_agg, "glm", "topleft") 
obsvpredplot(results_agg, "rf", "topleft") 
obsvpredplot(results_agg, "nn", "topleft") 
```

```{r obsvpredplot_forpaper}
# # when you have picked what models to show, use this
# png('ch4 resampling/outputdata/rplot47_obsvspred_all.png', width=6.5, height=8, units="in", pointsize=8, res=1200)
#   op <- par(mfrow = c(4, 2),     # 4x2 layout
#         oma = c(5, 4, 5, 5),     # two rows of text at the outer left and bottom margin
#         mar = c(1, 1, 1, 1)+0.1, # space for one row of text at ticks and to separate plots
#         mgp = c(2, 1, 0),        # axis label at 2 rows distance, tick labels at 1 row
#         xpd = FALSE)             # allow content to protrude into outer margin (and beyond)
#     
#   # par(mfrow = c(4,2), oma = c(2,2,0,0), mar = c(1,1,0,0))
#   
#   # find y and x limits
#   xlower <- min(results_all$FLOW, na.rm=TRUE)
#   xupper <- max(results_all$FLOW, na.rm=TRUE)
#   ylower <- min(results_all$LMLOGOFIT, na.rm=TRUE)
#   yupper <- max(results_all$LMLOGOFIT, na.rm=TRUE)
#   xylower <- min(xlower, ylower)
#   xyupper <- max(xupper, yupper)
#   
#   plot(results_all$FLOW, results_all$LMLOGOFIT, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$LMLOGOFIT~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$LMLOGOFIT, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$LMLOGOFIT, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$LMLOGOFIT, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   mtext("Aggregate", side=3, line=1)
#   
#   plot(results_all$FLOW, results_all$LMLOGOFIT_AGG, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$LMLOGOFIT_AGG~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$LMLOGOFIT_AGG, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$LMLOGOFIT_AGG, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$LMLOGOFIT_AGG, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   mtext("Incremental", side=3, line=1)
#   mtext("LM", side=4, line=1)
#   
#   plot(results_all$FLOW, results_all$GLMLOGOFIT, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$GLMLOGOFIT~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$GLMLOGOFIT, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$GLMLOGOFIT, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$GLMLOGOFIT, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   
#   plot(results_all$FLOW, results_all$GLMLOGOFIT_AGG, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$GLMLOGOFIT_AGG~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$GLMLOGOFIT_AGG, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$GLMLOGOFIT_AGG, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$GLMLOGOFIT_AGG, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   mtext("GLM", side=4, line=1)
#   
#   plot(results_all$FLOW, results_all$RFLOGOFIT, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$RFLOGOFIT~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$RFLOGOFIT, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$RFLOGOFIT, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$RFLOGOFIT, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   
#   plot(results_all$FLOW, results_all$RFLOGOFIT_AGG, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$RFLOGOFIT_AGG~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$RFLOGOFIT_AGG, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$RFLOGOFIT_AGG, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$RFLOGOFIT_AGG, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   mtext("RF", side=4, line=1)
#   
#   plot(results_all$FLOW, results_all$NNLOGOFIT, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$NNLOGOFIT~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$NNLOGOFIT, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$NNLOGOFIT, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$NNLOGOFIT, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   legend("bottomright", horiz=FALSE, inset=c(0.01, 0.01), c("Y = X line", "Regression line"), lty=c(3,1), lwd=c(2,1), col=c("grey70", cbpblack[8]), bg="white", box.lty=0)
#   
#   plot(results_all$FLOW, results_all$NNLOGOFIT_AGG, col=cbpblack[2:6][results_all$HIERARCHY], xlab="", ylab="", pch=19, xlim=c(xylower, xyupper), ylim=c(xylower, xyupper))
#   abline(0,1, col="grey70", lty=3, lwd=2)
#   lmline <- lm(results_all$NNLOGOFIT_AGG~results_all$FLOW)
#   abline(lmline, col=cbpblack[8])
#   mtext(paste("Y =", round(lmline$coefficients[2],3), "X +", round(lmline$coefficients[1],0)), side=3, line=-1.2, cex=0.8, adj=0.04)
#   # mtext(paste("bR2:", round(gof(resultsdf$NNLOGOFIT_AGG, resultsdf$FLOW)[18], 2), ", NSE:", round(gof(resultsdf$NNLOGOFIT_AGG, resultsdf$FLOW)[9], 2)), side=3, line=0.3, cex=0.8, adj=0.01)
#   mtext(paste("Model NSE:", round(gof(results_all$NNLOGOFIT_AGG, results_all$FLOW)[9], 2)), side=3, line=-2.2, cex=0.8, adj=0.04)
#   mtext("NN", side=4, line=1)
#   legend("bottomright", horiz=FALSE, inset=c(0.01, 0.01), legend=c(1:5), title= "Basin \nHierarchy", pch=19, col=cbpblack[2:6], bg="white", box.lty=0, xjust=1, title.adj=0)
#   title(xlab = "Observed Unimpaired Flow (AF/m)", ylab = "Predicted Unimpaired Flow (AF/m)", outer = TRUE, line = 2)
#   par(op)
# dev.off()
```

```{r error_density_plots}
# not done yet
# density plots of obs and pred data

densityplot <- function(resultsdf, modeltype, legendpos){
  resubfit <- paste0(toupper(modeltype), "_RESUBFIT")
  twofoldfit <- paste0(toupper(modeltype), "_2FOLDFIT")
  fivefoldfit <- paste0(toupper(modeltype), "_5FOLDFIT")
  tenfoldfit <- paste0(toupper(modeltype), "_10FOLDFIT")
  logofit <- paste0(toupper(modeltype), "_LOGOFIT")
  lmgofit <- paste0(toupper(modeltype), "_LMGOFIT")
  
  png(paste0('ch4 resampling/outputdata/rplot43_density_', modeltype, '.png'), width=3.25, height=2.85, units="in", pointsize=8, res=1200)
    par(mar=c(4,4,3,3)+0.1, cex=1)
    plot(density(resultsdf$FLOW), main="")
    rug(jitter(resultsdf$FLOW))
    lines(density(resultsdf[, resubfit], na.rm = TRUE), col=cbpblack[2])
    lines(density(resultsdf[ , twofoldfit], na.rm = TRUE), col=cbpblack[3])
    lines(density(resultsdf[ , fivefoldfit], na.rm = TRUE), col=cbpblack[4])
    lines(density(resultsdf[ , tenfoldfit], na.rm = TRUE), col=cbpblack[5])
    lines(density(resultsdf[ , logofit], na.rm = TRUE), col=cbpblack[6])
    lines(density(resultsdf[ , lmgofit], na.rm = TRUE), col=cbpblack[7])
    legend(legendpos, horiz=FALSE, inset=c(0.01, 0.01), cex=0.6, legend=c("RESUB", "2FOLD", "5 FOLD", "10FOLD", "LOGO", "LMGO"), title= "Resampling Method", lty=1, col=cbpblack[2:7], bg="grey96", box.lty=0, xpd=TRUE, xjust=1, title.adj=0)
  dev.off()
}

densityplot(results_agg, "lm", "topright") 
densityplot(results_agg, "glm", "topright") 
densityplot(results_agg, "rf", "topright") 
densityplot(results_agg, "nn", "topright") 

# zoom in
densityplot2 <- function(resultsdf, modeltype, legendpos){
  resubfit <- paste0(toupper(modeltype), "_RESUBFIT")
  twofoldfit <- paste0(toupper(modeltype), "_2FOLDFIT")
  fivefoldfit <- paste0(toupper(modeltype), "_5FOLDFIT")
  tenfoldfit <- paste0(toupper(modeltype), "_10FOLDFIT")
  logofit <- paste0(toupper(modeltype), "_LOGOFIT")
  lmgofit <- paste0(toupper(modeltype), "_LMGOFIT")
  
  png(paste0('ch4 resampling/outputdata/rplot44_density_', modeltype, '.png'), width=3.25, height=2.85, units="in", pointsize=8, res=1200)
    par(mar=c(4,4,3,3)+0.1, cex=1)
    plot(density(resultsdf$FLOW), main="", xlim=c(0,5e5))
    rug(jitter(resultsdf$FLOW))
    lines(density(resultsdf[, resubfit], na.rm = TRUE), col=cbpblack[2])
    lines(density(resultsdf[ , twofoldfit], na.rm = TRUE), col=cbpblack[3])
    lines(density(resultsdf[ , fivefoldfit], na.rm = TRUE), col=cbpblack[4])
    lines(density(resultsdf[ , tenfoldfit], na.rm = TRUE), col=cbpblack[5])
    lines(density(resultsdf[ , logofit], na.rm = TRUE), col=cbpblack[6])
    lines(density(resultsdf[ , lmgofit], na.rm = TRUE), col=cbpblack[7])
    legend(legendpos, horiz=FALSE, inset=c(0.01, 0.01), cex=0.6, legend=c("RESUB", "2FOLD", "5 FOLD", "10FOLD", "LOGO", "LMGO"), title= "Resampling Method", lty=1, col=cbpblack[2:7], bg="grey96", box.lty=0, xpd=TRUE, xjust=1, title.adj=0)
  dev.off()
}

densityplot2(results_agg, "lm", "topright") 
densityplot2(results_agg, "glm", "topright") 
densityplot2(results_agg, "rf", "topright") 
densityplot2(results_agg, "nn", "topright") 

library(reshape2)
densityplot3 <- function(resultsdf, modeltype){
  resubfit <- paste0(toupper(modeltype), "_RESUBFIT")
  twofoldfit <- paste0(toupper(modeltype), "_2FOLDFIT")
  fivefoldfit <- paste0(toupper(modeltype), "_5FOLDFIT")
  tenfoldfit <- paste0(toupper(modeltype), "_10FOLDFIT")
  logofit <- paste0(toupper(modeltype), "_LOGOFIT")
  lmgofit <- paste0(toupper(modeltype), "_LMGOFIT")
  results_all_melted <- melt(resultsdf[,c("DATE", "CDEC_ID", "FLOW", resubfit, twofoldfit, fivefoldfit, tenfoldfit, logofit, lmgofit)], id.vars=c("DATE", "CDEC_ID"))
  results_all_melted <- na.omit(results_all_melted)  
  
  png(paste0('ch4 resampling/outputdata/rplot45_density_', modeltype, '.png'), width=3.25, height=2.85, units="in", pointsize=8, res=1200)
  ggplot(results_all_melted, aes(x = value), alpha = 0.2) +
    geom_density(aes(color = variable)) +
    ylim(0, 1.5e-5) +
    xlim(0, 4e6) +
    scale_color_manual(values=c(cbpblack, cbpgrey[1]))+
    theme_bw()
  dev.off()
}

densityplot3(results_agg, "lm") 
densityplot3(results_agg, "glm") 
densityplot3(results_agg, "rf") 
densityplot3(results_agg, "nn") 
```

```{r error_mapplots}
# modeltype can be: "lm", "glm", "rf", "nn"
library(RColorBrewer)
library(lattice)
library(grid)

br2map <- function(gof_results, modelform, groupingstyle, datatype){ 
  basinsc <- basins_points
  results <- data.frame(t(gof_results))
  results$CDEC_ID <- rownames(results)
  basinsc <- merge(basinsc, results, by="CDEC_ID", all=TRUE)
  counties <- list(first=TRUE, "sp.polygons", cacounties, fill="gray88", col="white")

  png(paste0('ch4 resampling/outputdata/rplot46_br2map_', modelform, "_", groupingstyle, "_", datatype , '.png'), width=3.25, height=3, units="in", pointsize=8, res=1200)
  par(mar=c(0,0,0,0)+0.1, cex=1)
  mycolors <- colorRampPalette(c(cbpblack[2],cbpblack[4],cbpblack[6]))
  tbdspplot <- spplot(basinsc["bR2"], cex=0.8, sp.layout=counties, col.regions = mycolors(100), colorkey = list(right = list( # see ?levelplot in package trellis, argument colorkey:
                      fun = draw.colorkey, 
                      args = list(
                             key = list(
                                  at = seq(0, 1.0, 1/100), # colour breaks
                                  col = mycolors(100), # colours
                                  labels = list(
                                      at = seq(0, 1.0, 0.2),
                                      labels = seq(0, 1.0, 0.2)
                                      )
                                   )
                              )
                      )
          )
  )
  print(tbdspplot)
  grid.text("bR2(-)", 0.65, 0.88)
  dev.off()
}

br2map(gof_lm_resub_agg_by_basins, "lm", "resub", "agg")
br2map(gof_lm_2fold_agg_by_basins, "lm", "2fold", "agg")
br2map(gof_lm_5fold_agg_by_basins, "lm", "5fold", "agg")
br2map(gof_lm_10fold_agg_by_basins, "lm", "10fold", "agg")
br2map(gof_lm_logo_agg_by_basins, "lm", "logo", "agg")
br2map(gof_lm_lmgo_agg_by_basins, "lm", "lmgo", "agg")

br2map(gof_glm_resub_agg_by_basins, "glm", "resub", "agg")
br2map(gof_glm_2fold_agg_by_basins, "glm", "2fold", "agg")
br2map(gof_glm_5fold_agg_by_basins, "glm", "5fold", "agg")
br2map(gof_glm_10fold_agg_by_basins, "glm", "10fold", "agg")
br2map(gof_glm_logo_agg_by_basins, "glm", "logo", "agg")
br2map(gof_glm_lmgo_agg_by_basins, "glm", "lmgo", "agg")

br2map(gof_rf_resub_agg_by_basins, "rf", "resub", "agg")
br2map(gof_rf_2fold_agg_by_basins, "rf", "2fold", "agg")
br2map(gof_rf_5fold_agg_by_basins, "rf", "5fold", "agg")
br2map(gof_rf_10fold_agg_by_basins, "rf", "10fold", "agg")
br2map(gof_rf_logo_agg_by_basins, "rf", "logo", "agg")
br2map(gof_rf_lmgo_agg_by_basins, "rf", "lmgo", "agg")

br2map(gof_nn_resub_agg_by_basins, "nn", "resub", "agg")
br2map(gof_nn_2fold_agg_by_basins, "nn", "2fold", "agg")
br2map(gof_nn_5fold_agg_by_basins, "nn", "5fold", "agg")
br2map(gof_nn_10fold_agg_by_basins, "nn", "10fold", "agg")
br2map(gof_nn_logo_agg_by_basins, "nn", "logo", "agg")
br2map(gof_nn_lmgo_agg_by_basins, "nn", "lmgo", "agg")
```

```{r error_hierarchy_plots}
# plot errors by location in the hierarchy
# datatype can be: "agg", "cagg", "inc", "cinc"
# fitofinterest can be anything returned by the gof function

# # first let's make a dataframe with all the different grouping styles
# gof_lm_resub_agg_by_basins$GROUPINGSTYLE <- "resub" 
# gof_lm_2fold_agg_by_basins$GROUPINGSTYLE <- "2fold"
# gof_lm_5fold_agg_by_basins$GROUPINGSTYLE <- "5fold"
# gof_lm_10fold_agg_by_basins$GROUPINGSTYLE <- "10fold"
# gof_lm_logo_agg_by_basins$GROUPINGSTYLE <- "logo"
# gof_lm_lmgo_agg_by_basins$GROUPINGSTYLE <- "lmgo"
# 
# gof_glm_resub_agg_by_basins$GROUPINGSTYLE <- "resub" 
# gof_glm_2fold_agg_by_basins$GROUPINGSTYLE <- "2fold"
# gof_glm_5fold_agg_by_basins$GROUPINGSTYLE <- "5fold"
# gof_glm_10fold_agg_by_basins$GROUPINGSTYLE <- "10fold"
# gof_glm_logo_agg_by_basins$GROUPINGSTYLE <- "logo"
# gof_glm_lmgo_agg_by_basins$GROUPINGSTYLE <- "lmgo"
# 
# gof_rf_resub_agg_by_basins$GROUPINGSTYLE <- "resub" 
# gof_rf_2fold_agg_by_basins$GROUPINGSTYLE <- "2fold"
# gof_rf_5fold_agg_by_basins$GROUPINGSTYLE <- "5fold"
# gof_rf_10fold_agg_by_basins$GROUPINGSTYLE <- "10fold"
# gof_rf_logo_agg_by_basins$GROUPINGSTYLE <- "logo"
# gof_rf_lmgo_agg_by_basins$GROUPINGSTYLE <- "lmgo"
# 
# gof_nn_resub_agg_by_basins$GROUPINGSTYLE <- "resub" 
# gof_nn_2fold_agg_by_basins$GROUPINGSTYLE <- "2fold"
# gof_nn_5fold_agg_by_basins$GROUPINGSTYLE <- "5fold"
# gof_nn_10fold_agg_by_basins$GROUPINGSTYLE <- "10fold"
# gof_nn_logo_agg_by_basins$GROUPINGSTYLE <- "logo"
# gof_nn_lmgo_agg_by_basins$GROUPINGSTYLE <- "lmgo"
# 
# # make all dataframes into long format
# melt(gof_lm_resub_agg_by_basins, id.vars=c("subject", "sex"))
# gof_results_all <- 
  
# groupingstyle comparisons
gofdotchart <- function(gof_results_resub, gof_results_2fold, gof_results_5fold, gof_results_10fold, gof_results_logo, gof_results_lmgo, modeltype, fitofinterest, legendpos){
  tgof_results_resub <- data.frame(t(gof_results_resub))
  tgof_results_resub$CDEC_ID <- rownames(tgof_results_resub)
  basinsc <- basins_points@data
  basinsc <- merge(basinsc, tgof_results_resub, by="CDEC_ID", all=TRUE)
  
  tgof_results_2fold <- data.frame(t(gof_results_2fold))
  tgof_results_2fold$CDEC_ID <- rownames(tgof_results_2fold)
  basinsc2 <- basins_points@data
  basinsc2 <- merge(basinsc2, tgof_results_2fold, by="CDEC_ID", all=TRUE)
  
  tgof_results_5fold <- data.frame(t(gof_results_5fold))
  tgof_results_5fold$CDEC_ID <- rownames(tgof_results_5fold)
  basinsc3 <- basins_points@data
  basinsc3 <- merge(basinsc3, tgof_results_5fold, by="CDEC_ID", all=TRUE)
  
  tgof_results_10fold <- data.frame(t(gof_results_10fold))
  tgof_results_10fold$CDEC_ID <- rownames(tgof_results_10fold)
  basinsc4 <- basins_points@data
  basinsc4 <- merge(basinsc4, tgof_results_10fold, by="CDEC_ID", all=TRUE)
  
  tgof_results_logo <- data.frame(t(gof_results_logo))
  tgof_results_logo$CDEC_ID <- rownames(tgof_results_logo)
  basinsc5 <- basins_points@data
  basinsc5 <- merge(basinsc5, tgof_results_logo, by="CDEC_ID", all=TRUE)
  
  tgof_results_lmgo <- data.frame(t(gof_results_lmgo))
  tgof_results_lmgo$CDEC_ID <- rownames(tgof_results_lmgo)
  basinsc6 <- basins_points@data
  basinsc6 <- merge(basinsc6, tgof_results_lmgo, by="CDEC_ID", all=TRUE)

  basinsc$HIERARCHY <- (basinsc$STATIONS_ABOVE1!="none") + (basinsc$STATIONS_ABOVE2!="none") + (basinsc$STATIONS_ABOVE3!="none") + (basinsc$STATIONS_ABOVE4!="none") + 1
  basinsc2$HIERARCHY <- (basinsc2$STATIONS_ABOVE1!="none") + (basinsc2$STATIONS_ABOVE2!="none") + (basinsc2$STATIONS_ABOVE3!="none") + (basinsc2$STATIONS_ABOVE4!="none") + 1
  basinsc3$HIERARCHY <- (basinsc3$STATIONS_ABOVE1!="none") + (basinsc3$STATIONS_ABOVE2!="none") + (basinsc3$STATIONS_ABOVE3!="none") + (basinsc3$STATIONS_ABOVE4!="none") + 1
  basinsc4$HIERARCHY <- (basinsc4$STATIONS_ABOVE1!="none") + (basinsc4$STATIONS_ABOVE2!="none") + (basinsc4$STATIONS_ABOVE3!="none") + (basinsc4$STATIONS_ABOVE4!="none") + 1
  basinsc5$HIERARCHY <- (basinsc5$STATIONS_ABOVE1!="none") + (basinsc5$STATIONS_ABOVE2!="none") + (basinsc5$STATIONS_ABOVE3!="none") + (basinsc5$STATIONS_ABOVE4!="none") + 1
  basinsc6$HIERARCHY <- (basinsc6$STATIONS_ABOVE1!="none") + (basinsc6$STATIONS_ABOVE2!="none") + (basinsc6$STATIONS_ABOVE3!="none") + (basinsc6$STATIONS_ABOVE4!="none") + 1
  
  basinsc5 <- basinsc5[order(basinsc5[, fitofinterest], decreasing=TRUE), ]

  basinsm <- merge(basinsc2, basinsc, by="CDEC_ID")
  basinsm <- basinsm[order(basinsm[, paste0(fitofinterest, ".x")], decreasing=TRUE), ]
  tbdmin <- basinsm[, paste0(fitofinterest, ".x")]
  tbdmin <- tbdmin[which(tbdmin>-Inf)]
  minxlim <- min(tbdmin, na.rm = TRUE)
  
  if(fitofinterest=="ME"){
    fitofinterestlabel <- "Mean Error (AF)"
    maxxlim <- max(1.1*max(basinsm[, "ME.x"], na.rm=TRUE), 1.1*max(basinsm[, "ME.y"], na.rm=TRUE))
  } else if(fitofinterest=="MAE"){
    fitofinterestlabel <- "Mean Absolute Error (AF)"
    maxxlim <- max(1.1*max(basinsm[, "MAE.x"], na.rm=TRUE), 1.1*max(basinsm[, "MAE.y"], na.rm=TRUE))
  } else if(fitofinterest=="MSE"){
    fitofinterestlabel <- "Mean Squared Error (AF^2)"
    maxxlim <- max(1.1*max(basinsm[, "MSE.x"], na.rm=TRUE), 1.1*max(basinsm[, "MSE.y"], na.rm=TRUE))
  } else if(fitofinterest=="RMSE"){
    fitofinterestlabel <- "Root Mean Squared Error (AF)"
    maxxlim <- max(1.1*max(basinsm[, "RMSE.x"], na.rm=TRUE), 1.1*max(basinsm[, "RMSE.y"], na.rm=TRUE))
  } else if(fitofinterest=="NRMSE.."){
    fitofinterestlabel <- "Normalized Root Mean Squared Error (AF^2)"
    maxxlim <- max(1.1*max(basinsm[, "NRMSE...x"], na.rm=TRUE), 1.1*max(basinsm[, "NRMSE...y"], na.rm=TRUE))
  } else if(fitofinterest=="PBIAS.."){
    fitofinterestlabel <- "Percent Bias (-)"
    maxxlim <- max(1.4*max(basinsm[, "PBIAS...x"], na.rm=TRUE), 1.4*max(basinsm[, "PBIAS...y"], na.rm=TRUE))
  } else if(fitofinterest=="RSR"){
    fitofinterestlabel <- "RMSE to Standard Deviation of Observations Ratio (-)"
    maxxlim <- 67
  } else if(fitofinterest=="NSE"){
    fitofinterestlabel <- "Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 10
    # minxlim <- 7*minxlim
  } else if(fitofinterest=="rSD"){
    fitofinterestlabel <- "Ratio of Standard Deviations (-)"
    maxxlim <- max(1.1*max(basinsm[, "rSD.x"], na.rm=TRUE), 1.1*max(basinsm[, "rSD.y"], na.rm=TRUE))
  } else if(fitofinterest=="mNSE"){
    fitofinterestlabel <- "Modified Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5
  } else if(fitofinterest=="rNSE"){
    fitofinterestlabel <- "Relative Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5e5
  } else if(fitofinterest=="d"){
    fitofinterestlabel <- "Index of Agreement (-)"
    maxxlim <- max(1.05*max(basinsm[, "d.x"], na.rm=TRUE), 1.05*max(basinsm[, "d.y"], na.rm=TRUE))
  } else if(fitofinterest=="md"){
    fitofinterestlabel <- "Modified Index of Agreement (-)"
    maxxlim <- max(1.1*max(basinsm[, "md.x"], na.rm=TRUE), 1.1*max(basinsm[, "md.y"], na.rm=TRUE))
  } else if(fitofinterest=="rd"){
    fitofinterestlabel <- "Relative Index of Agreement (-)"
    maxxlim <- 100
  } else if(fitofinterest=="cp"){
    fitofinterestlabel <- "Persistence Index (-)"
    maxxlim <- 200
  } else if(fitofinterest=="r"){
    fitofinterestlabel <- "Pearson Correlation coefficient (-)"
    maxxlim <- max(1.1*max(basinsm[, "r.x"], na.rm=TRUE), 1.1*max(basinsm[, "r.y"], na.rm=TRUE))
  } else if(fitofinterest=="R2"){
    fitofinterestlabel <- "Coefficient of Determination (-)"
    maxxlim <- 1.0
  } else if(fitofinterest=="bR2"){
    fitofinterestlabel <- "Bias-Corrected Coefficient of Determination (-)"
    maxxlim <- 1.0
    minxlim <- -0.05
  } else if(fitofinterest=="KGE"){
    fitofinterestlabel <- "Kling-Gupta Efficiency (-)"
    maxxlim <- 10
  } else if(fitofinterest=="VE"){
    fitofinterestlabel <- "Volumetric Efficiency (AF)"
    maxxlim <- 6
  } else{
    print("Input a measure of fit provided by the gof function in HydroGOF package!")
  }
  
  png(paste0('ch4 resampling/outputdata/rplot47_', modeltype, "_", fitofinterest, 'dotchart_comp.png'), width=6.5, height=8, units="in", pointsize=8, res=1200)
    dotchart(basinsm[, paste0(fitofinterest, ".x")], xlab=fitofinterestlabel, ylab="", labels=basinsm$CDEC_ID, group=as.factor(basinsm$HIERARCHY.x), cex=0.8, pch=19, color="black", xlim=c(minxlim, maxxlim))
    mtext("Basin Hierarchies", side=2, line=2, cex=0.8)
    # to allow over plotting
    par(new=TRUE)
    basinsm$mycol <- as.integer(basinsm[, paste0(fitofinterest, ".y")]>basinsm[, paste0(fitofinterest, ".x")])+7
    mycol <- cbpblack[basinsm$mycol]
    dotchart(basinsm[, paste0(fitofinterest, ".y")], xlab=fitofinterestlabel, ylab="", labels=basinsm$CDEC_ID, group=as.factor(basinsm$HIERARCHY.x), cex=0.8, pch=2, xlim=c(minxlim, maxxlim), col=mycol)
    legend(legendpos, pch=c(19,2,2,2), c("inc", "agg", "agg>inc", "inc>agg"), col=c("black", "black", cbpblack[8], cbpblack[7]), bg="grey96", horiz=FALSE, inset=c(0.01, 0.01), cex=0.8, box.lty=0)
  dev.off()
}

gofdotchart(gof_lm_resub_agg_by_basins, gof_lm_2fold_agg_by_basins, gof_lm_5fold_agg_by_basins, gof_lm_10fold_agg_by_basins, gof_lm_logo_agg_by_basins, gof_lm_lmgo_agg_by_basins, "bR2", "topright")
gofdotchart(gof_glm_resub_agg_by_basins, gof_glm_2fold_agg_by_basins, gof_glm_5fold_agg_by_basins, gof_glm_10fold_agg_by_basins, gof_glm_logo_agg_by_basins, gof_glm_lmgo_agg_by_basins, "bR2", "topright")
gofdotchart(gof_rf_resub_agg_by_basins, gof_rf_2fold_agg_by_basins, gof_rf_5fold_agg_by_basins, gof_rf_10fold_agg_by_basins, gof_rf_logo_agg_by_basins, gof_rf_lmgo_agg_by_basins, "bR2", "topright")
gofdotchart(gof_nn_resub_agg_by_basins, gof_nn_2fold_agg_by_basins, gof_nn_5fold_agg_by_basins, gof_nn_10fold_agg_by_basins, gof_nn_logo_agg_by_basins, gof_nn_lmgo_agg_by_basins, "bR2", "topright")
```

```{r boxplot}
gofboxplot <- function(gof_results, datatype, modelform, fitofinterest){ 
  basinsc <- basins_points
  results <- data.frame(t(gof_results))
  results$CDEC_ID <- rownames(results)
  basinsc <- merge(basinsc, results, by="CDEC_ID", all=TRUE)
  basinsc <- basinsc@data[order(basinsc@data[, fitofinterest], decreasing=TRUE), ]
  basinsc$HIERARCHY <- (basinsc$STATIONS_ABOVE1!="none") + (basinsc$STATIONS_ABOVE2!="none") + (basinsc$STATIONS_ABOVE3!="none") + (basinsc$STATIONS_ABOVE4!="none") + 1
  basinsc$GRPS <- as.factor(basinsc$HIERARCHY)
  basinsc <- basinsc[order(basinsc[, fitofinterest], decreasing=TRUE), ]
  
  if(fitofinterest=="ME"){
    fitofinterestlabel <- "Mean Error (AF)"
    maxxlim <- 1.1*max(basinsc[, "ME"], na.rm=TRUE)
  } else if(fitofinterest=="MAE"){
    fitofinterestlabel <- "Mean Absolute Error (AF)"
    maxxlim <- 1.1*max(basinsc[, "MAE"], na.rm=TRUE)
  } else if(fitofinterest=="MSE"){
    fitofinterestlabel <- "Mean Squared Error (AF^2)"
    maxxlim <- 1.1*max(basinsc[, "MSE"], na.rm=TRUE)
  } else if(fitofinterest=="RMSE"){
    fitofinterestlabel <- "Root Mean Squared Error (AF)"
    maxxlim <- 1.1*max(basinsc[, "RMSE"], na.rm=TRUE)
  } else if(fitofinterest=="NRMSE.."){
    fitofinterestlabel <- "Normalized Root Mean Squared Error (AF^2)"
    maxxlim <- 1.1*max(basinsc[, "NRMSE.."], na.rm=TRUE)
  } else if(fitofinterest=="PBIAS.."){
    fitofinterestlabel <- "Percent Bias (-)"
    maxxlim <- 1.4*max(basinsc[, "PBIAS.."], na.rm=TRUE)
  } else if(fitofinterest=="RSR"){
    fitofinterestlabel <- "RMSE to Standard Deviation of Observations Ratio (-)"
    maxxlim <- 67
  } else if(fitofinterest=="NSE"){
    fitofinterestlabel <- "Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 500
  } else if(fitofinterest=="rSD"){
    fitofinterestlabel <- "Ratio of Standard Deviations (-)"
    maxxlim <- 1.1*max(basinsc[, "rSD"], na.rm=TRUE)
  } else if(fitofinterest=="mNSE"){
    fitofinterestlabel <- "Modified Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5
  } else if(fitofinterest=="rNSE"){
    fitofinterestlabel <- "Relative Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5e5
  } else if(fitofinterest=="d"){
    fitofinterestlabel <- "Index of Agreement (-)"
    maxxlim <- 1.05*max(basinsc[, "d"], na.rm=TRUE)
  } else if(fitofinterest=="md"){
    fitofinterestlabel <- "Modified Index of Agreement (-)"
    maxxlim <- 1.1*max(basinsc[, "md"], na.rm=TRUE)
  } else if(fitofinterest=="rd"){
    fitofinterestlabel <- "Relative Index of Agreement (-)"
    maxxlim <- 100
  } else if(fitofinterest=="cp"){
    fitofinterestlabel <- "Persistence Index (-)"
    maxxlim <- 200
  } else if(fitofinterest=="r"){
    fitofinterestlabel <- "Pearson Correlation coefficient (-)"
    maxxlim <- 1.1*max(basinsc[, "r"], na.rm=TRUE)
  } else if(fitofinterest=="R2"){
    fitofinterestlabel <- "Coefficient of Determination (-)"
    maxxlim <- 1.0
  } else if(fitofinterest=="bR2"){
    fitofinterestlabel <- "Bias-Corrected Coefficient of Determination (-)"
    maxxlim <- 1.0
  } else if(fitofinterest=="KGE"){
    fitofinterestlabel <- "Kling-Gupta Efficiency (-)"
    maxxlim <- 10
  } else if(fitofinterest=="VE"){
    fitofinterestlabel <- "Volumetric Efficiency (AF)"
    maxxlim <- 6
  } else{
    print("Input a measure of fit provided by the gof function in HydroGOF package!")
  }
  
  plottoprint <- ggplot(basinsc, aes(x=GRPS, y=basinsc[,fitofinterest], fill=GRPS))+
      geom_boxplot(outlier.shape=NA, alpha=0.3) +
      geom_jitter(shape=16, position=position_jitter(0.1)) +
      coord_flip() +
      theme_bw(base_size = 8) +
      ylab(fitofinterestlabel) +
      xlab("Basin Hierarchy") +
      scale_x_discrete(limits = rev(levels(basinsc$GRPS))) +
      scale_color_manual(values=cbpblack[2:6]) +
      theme(legend.position="none")
  
  png(paste0('ch4 resampling/outputdata/rplot412_', fitofinterest, "gofboxplot_", modelform, "_", datatype, '.png'), width=6.5, height=1.8, units="in", pointsize=8, res=1200)
    par(mar=c(0,0,0,0)+0.1, cex=1)
    print(plottoprint)
  dev.off()
}

# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "ME")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "MAE")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "MSE")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "RMSE")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "NRMSE..")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "PBIAS..")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "RSR")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "rSD")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "NSE")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "mNSE")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "rNSE")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "d")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "md")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "rd")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "cp")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "r")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "R2")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "bR2")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "KGE")
# gofboxplot(gof_lm_inc_by_basins, "inc", "lm", "VE")

gofboxplot2 <- function(gof_results_agg, gof_results_inc, fitofinterest, legendpos){ 
  basinsc <- basins_points
  results <- data.frame(t(gof_results_agg))
  results$CDEC_ID <- rownames(results)
  
  results2 <- data.frame(t(gof_results_inc))
  results2$CDEC_ID <- rownames(results2)
  
  basinsc <- merge(basinsc, results, by="CDEC_ID", all=TRUE) # the .x s are the agg basins, the .y s are the inc
  basinsc <- merge(basinsc, results2, by="CDEC_ID", all=TRUE)
  
  basinsc <- basinsc@data[order(basinsc@data[, paste0(fitofinterest, ".y")], decreasing=TRUE), ]
  basinsc$HIERARCHY <- (basinsc$STATIONS_ABOVE1!="none") + (basinsc$STATIONS_ABOVE2!="none") + (basinsc$STATIONS_ABOVE3!="none") + (basinsc$STATIONS_ABOVE4!="none") + 1
  basinsc$GRPS <- as.factor(basinsc$HIERARCHY)
  basinsc <- basinsc[order(basinsc[, paste0(fitofinterest, ".y")], decreasing=TRUE), ]
  
  if(fitofinterest=="ME"){
    fitofinterestlabel <- "Mean Error (AF)"
    maxxlim <- 1.1*max(basinsc[, "ME"], na.rm=TRUE)
  } else if(fitofinterest=="MAE"){
    fitofinterestlabel <- "Mean Absolute Error (AF)"
    maxxlim <- 1.1*max(basinsc[, "MAE"], na.rm=TRUE)
  } else if(fitofinterest=="MSE"){
    fitofinterestlabel <- "Mean Squared Error (AF^2)"
    maxxlim <- 1.1*max(basinsc[, "MSE"], na.rm=TRUE)
  } else if(fitofinterest=="RMSE"){
    fitofinterestlabel <- "Root Mean Squared Error (AF)"
    maxxlim <- 1.1*max(basinsc[, "RMSE"], na.rm=TRUE)
  } else if(fitofinterest=="NRMSE.."){
    fitofinterestlabel <- "Normalized Root Mean Squared Error (AF^2)"
    maxxlim <- 1.1*max(basinsc[, "NRMSE.."], na.rm=TRUE)
  } else if(fitofinterest=="PBIAS.."){
    fitofinterestlabel <- "Percent Bias (-)"
    maxxlim <- 1.4*max(basinsc[, "PBIAS.."], na.rm=TRUE)
  } else if(fitofinterest=="RSR"){
    fitofinterestlabel <- "RMSE to Standard Deviation of Observations Ratio (-)"
    maxxlim <- 67
  } else if(fitofinterest=="NSE"){
    fitofinterestlabel <- "Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 500
  } else if(fitofinterest=="rSD"){
    fitofinterestlabel <- "Ratio of Standard Deviations (-)"
    maxxlim <- 1.1*max(basinsc[, "rSD"], na.rm=TRUE)
  } else if(fitofinterest=="mNSE"){
    fitofinterestlabel <- "Modified Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5
  } else if(fitofinterest=="rNSE"){
    fitofinterestlabel <- "Relative Nash-Sutcliffe Efficiency (-)"
    maxxlim <- 5e5
  } else if(fitofinterest=="d"){
    fitofinterestlabel <- "Index of Agreement (-)"
    maxxlim <- 1.05*max(basinsc[, "d"], na.rm=TRUE)
  } else if(fitofinterest=="md"){
    fitofinterestlabel <- "Modified Index of Agreement (-)"
    maxxlim <- 1.1*max(basinsc[, "md"], na.rm=TRUE)
  } else if(fitofinterest=="rd"){
    fitofinterestlabel <- "Relative Index of Agreement (-)"
    maxxlim <- 100
  } else if(fitofinterest=="cp"){
    fitofinterestlabel <- "Persistence Index (-)"
    maxxlim <- 200
  } else if(fitofinterest=="r"){
    fitofinterestlabel <- "Pearson Correlation coefficient (-)"
    maxxlim <- 1.1*max(basinsc[, "r"], na.rm=TRUE)
  } else if(fitofinterest=="R2"){
    fitofinterestlabel <- "Coefficient of Determination (-)"
    maxxlim <- 1.0
  } else if(fitofinterest=="bR2"){
    fitofinterestlabel <- "Bias-Corrected Coefficient of Determination (-)"
    maxxlim <- 1.0
  } else if(fitofinterest=="KGE"){
    fitofinterestlabel <- "Kling-Gupta Efficiency (-)"
    maxxlim <- 10
  } else if(fitofinterest=="VE"){
    fitofinterestlabel <- "Volumetric Efficiency (AF)"
    maxxlim <- 6
  } else{
    print("Input a measure of fit provided by the gof function in HydroGOF package!")
  }
  
  basinsc2 <- melt(basinsc[,c("CDEC_ID", "GRPS", paste0(fitofinterest, ".x"), paste0(fitofinterest, ".y"))], id.vars = c("CDEC_ID", "GRPS"), measure.vars = c(paste0(fitofinterest, ".x"), paste0(fitofinterest, ".y")))
  plottoprint <- ggplot(basinsc2, aes(x=GRPS, y=value, fill=variable))+
      geom_boxplot(outlier.shape=NA, alpha=0.3, position=position_dodge(1)) +
      geom_point(position=position_dodge(width=1), aes(group=variable, col=variable), show.legend=FALSE) +
      # geom_jitter(shape=16, position=position_jitter(0.1), aes(group=variable)) +
      coord_flip() +
      theme_bw(base_size = 8) +
      ylab(fitofinterestlabel) +
      xlab("Basin Hierarchy") +
      scale_x_discrete(limits = rev(levels(basinsc$GRPS))) +
      scale_color_manual(values=cbpblack[7:8]) +
      theme(legend.title = element_blank(), legend.text=element_text(size=10), text=element_text(size=10)) +
      scale_fill_discrete(labels=c("agg", "inc"))
  
  png(paste0('ch4 resampling/outputdata/rplot412_', fitofinterest, "gofboxplot_comp.png"), width=6.5, height=4, units="in", pointsize=8, res=1200)
    par(mar=c(0,0,0,0)+0.1, cex=1)
    print(plottoprint)
  dev.off()
}

# gofboxplot2(gof_glm_agg_by_basins, gof_glm_inc_by_basins, "bR2", "topright")
gofboxplot2(gof_nn_agg_by_basins, gof_nn_inc_by_basins, "bR2", "topright")
```



